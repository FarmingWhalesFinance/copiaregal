{"ast":null,"code":"import { v4 as uuid } from '@lukeed/uuid';\nimport { dset } from 'dset';\nimport Logger from '../logger';\nimport Stats from '../stats';\nimport { RemoteMetrics } from '../stats/remote-metrics';\n\nvar ContextCancelation =\n/** @class */\nfunction () {\n  function ContextCancelation(options) {\n    var _a, _b, _c;\n\n    this.retry = (_a = options.retry) !== null && _a !== void 0 ? _a : true;\n    this.type = (_b = options.type) !== null && _b !== void 0 ? _b : 'plugin Error';\n    this.reason = (_c = options.reason) !== null && _c !== void 0 ? _c : '';\n  }\n\n  return ContextCancelation;\n}();\n\nexport { ContextCancelation };\nvar remoteMetrics;\n\nvar Context =\n/** @class */\nfunction () {\n  function Context(event, id) {\n    this.logger = new Logger();\n\n    this.cancel = function (error) {\n      if (error) {\n        throw error;\n      }\n\n      throw new ContextCancelation({\n        reason: 'Context Cancel'\n      });\n    };\n\n    this._attempts = 0;\n    this._event = event;\n    this._id = id !== null && id !== void 0 ? id : uuid();\n    this.stats = new Stats(remoteMetrics);\n  }\n\n  Context.initMetrics = function (options) {\n    remoteMetrics = new RemoteMetrics(options);\n  };\n\n  Context.system = function () {\n    return new Context({\n      type: 'track',\n      event: 'system'\n    });\n  };\n\n  Context.prototype.isSame = function (other) {\n    return other._id === this._id;\n  };\n\n  Context.prototype.log = function (level, message, extras) {\n    this.logger.log(level, message, extras);\n  };\n\n  Object.defineProperty(Context.prototype, \"id\", {\n    get: function () {\n      return this._id;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(Context.prototype, \"event\", {\n    get: function () {\n      return this._event;\n    },\n    set: function (evt) {\n      this._event = evt;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(Context.prototype, \"attempts\", {\n    get: function () {\n      return this._attempts;\n    },\n    set: function (attempts) {\n      this._attempts = attempts;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Context.prototype.updateEvent = function (path, val) {\n    var _a; // Don't allow integrations that are set to false to be overwritten with integration settings.\n\n\n    if (path.split('.')[0] === 'integrations') {\n      var integrationName = path.split('.')[1];\n\n      if (((_a = this._event.integrations) === null || _a === void 0 ? void 0 : _a[integrationName]) === false) {\n        return this._event;\n      }\n    }\n\n    dset(this._event, path, val);\n    return this._event;\n  };\n\n  Context.prototype.failedDelivery = function () {\n    return this._failedDelivery;\n  };\n\n  Context.prototype.setFailedDelivery = function (options) {\n    this._failedDelivery = options;\n  };\n\n  Context.prototype.logs = function () {\n    return this.logger.logs;\n  };\n\n  Context.prototype.flush = function () {\n    this.logger.flush();\n    this.stats.flush();\n  };\n\n  Context.prototype.toJSON = function () {\n    return {\n      id: this._id,\n      event: this._event,\n      logs: this.logger.logs,\n      metrics: this.stats.metrics\n    };\n  };\n\n  return Context;\n}();\n\nexport { Context };","map":{"version":3,"sources":["../../../../src/core/context/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { v4 as uuid } from '@lukeed/uuid';\nimport { dset } from 'dset';\nimport Logger from '../logger';\nimport Stats from '../stats';\nimport { RemoteMetrics } from '../stats/remote-metrics';\nvar ContextCancelation = /** @class */ (function () {\n    function ContextCancelation(options) {\n        var _a, _b, _c;\n        this.retry = (_a = options.retry) !== null && _a !== void 0 ? _a : true;\n        this.type = (_b = options.type) !== null && _b !== void 0 ? _b : 'plugin Error';\n        this.reason = (_c = options.reason) !== null && _c !== void 0 ? _c : '';\n    }\n    return ContextCancelation;\n}());\nexport { ContextCancelation };\nvar remoteMetrics;\nvar Context = /** @class */ (function () {\n    function Context(event, id) {\n        this.logger = new Logger();\n        this.cancel = function (error) {\n            if (error) {\n                throw error;\n            }\n            throw new ContextCancelation({ reason: 'Context Cancel' });\n        };\n        this._attempts = 0;\n        this._event = event;\n        this._id = id !== null && id !== void 0 ? id : uuid();\n        this.stats = new Stats(remoteMetrics);\n    }\n    Context.initMetrics = function (options) {\n        remoteMetrics = new RemoteMetrics(options);\n    };\n    Context.system = function () {\n        return new Context({ type: 'track', event: 'system' });\n    };\n    Context.prototype.isSame = function (other) {\n        return other._id === this._id;\n    };\n    Context.prototype.log = function (level, message, extras) {\n        this.logger.log(level, message, extras);\n    };\n    Object.defineProperty(Context.prototype, \"id\", {\n        get: function () {\n            return this._id;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(Context.prototype, \"event\", {\n        get: function () {\n            return this._event;\n        },\n        set: function (evt) {\n            this._event = evt;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(Context.prototype, \"attempts\", {\n        get: function () {\n            return this._attempts;\n        },\n        set: function (attempts) {\n            this._attempts = attempts;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Context.prototype.updateEvent = function (path, val) {\n        var _a;\n        // Don't allow integrations that are set to false to be overwritten with integration settings.\n        if (path.split('.')[0] === 'integrations') {\n            var integrationName = path.split('.')[1];\n            if (((_a = this._event.integrations) === null || _a === void 0 ? void 0 : _a[integrationName]) === false) {\n                return this._event;\n            }\n        }\n        dset(this._event, path, val);\n        return this._event;\n    };\n    Context.prototype.failedDelivery = function () {\n        return this._failedDelivery;\n    };\n    Context.prototype.setFailedDelivery = function (options) {\n        this._failedDelivery = options;\n    };\n    Context.prototype.logs = function () {\n        return this.logger.logs;\n    };\n    Context.prototype.flush = function () {\n        this.logger.flush();\n        this.stats.flush();\n    };\n    Context.prototype.toJSON = function () {\n        return {\n            id: this._id,\n            event: this._event,\n            logs: this.logger.logs,\n            metrics: this.stats.metrics,\n        };\n    };\n    return Context;\n}());\nexport { Context };\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}