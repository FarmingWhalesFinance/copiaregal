{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { Emitter } from '@segment/analytics-core';\nimport { backoff } from './backoff';\n/**\n * @internal\n */\n\nexport var ON_REMOVE_FROM_FUTURE = 'onRemoveFromFuture';\n\nvar PriorityQueue =\n/** @class */\nfunction (_super) {\n  __extends(PriorityQueue, _super);\n\n  function PriorityQueue(maxAttempts, queue, seen) {\n    var _this = _super.call(this) || this;\n\n    _this.future = [];\n    _this.maxAttempts = maxAttempts;\n    _this.queue = queue;\n    _this.seen = seen !== null && seen !== void 0 ? seen : {};\n    return _this;\n  }\n\n  PriorityQueue.prototype.push = function () {\n    var _this = this;\n\n    var operations = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      operations[_i] = arguments[_i];\n    }\n\n    var accepted = operations.map(function (operation) {\n      var attempts = _this.updateAttempts(operation);\n\n      if (attempts > _this.maxAttempts || _this.includes(operation)) {\n        return false;\n      }\n\n      _this.queue.push(operation);\n\n      return true;\n    });\n    this.queue = this.queue.sort(function (a, b) {\n      return _this.getAttempts(a) - _this.getAttempts(b);\n    });\n    return accepted;\n  };\n\n  PriorityQueue.prototype.pushWithBackoff = function (operation) {\n    var _this = this;\n\n    if (this.getAttempts(operation) === 0) {\n      return this.push(operation)[0];\n    }\n\n    var attempt = this.updateAttempts(operation);\n\n    if (attempt > this.maxAttempts || this.includes(operation)) {\n      return false;\n    }\n\n    var timeout = backoff({\n      attempt: attempt - 1\n    });\n    setTimeout(function () {\n      _this.queue.push(operation); // remove from future list\n\n\n      _this.future = _this.future.filter(function (f) {\n        return f.id !== operation.id;\n      }); // Lets listeners know that a 'future' message is now available in the queue\n\n      _this.emit(ON_REMOVE_FROM_FUTURE);\n    }, timeout);\n    this.future.push(operation);\n    return true;\n  };\n\n  PriorityQueue.prototype.getAttempts = function (operation) {\n    var _a;\n\n    return (_a = this.seen[operation.id]) !== null && _a !== void 0 ? _a : 0;\n  };\n\n  PriorityQueue.prototype.updateAttempts = function (operation) {\n    this.seen[operation.id] = this.getAttempts(operation) + 1;\n    return this.getAttempts(operation);\n  };\n\n  PriorityQueue.prototype.includes = function (operation) {\n    return this.queue.includes(operation) || this.future.includes(operation) || Boolean(this.queue.find(function (i) {\n      return i.id === operation.id;\n    })) || Boolean(this.future.find(function (i) {\n      return i.id === operation.id;\n    }));\n  };\n\n  PriorityQueue.prototype.pop = function () {\n    return this.queue.shift();\n  };\n\n  Object.defineProperty(PriorityQueue.prototype, \"length\", {\n    get: function () {\n      return this.queue.length;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(PriorityQueue.prototype, \"todo\", {\n    get: function () {\n      return this.queue.length + this.future.length;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  return PriorityQueue;\n}(Emitter);\n\nexport { PriorityQueue };","map":{"version":3,"sources":["../../../../src/lib/priority-queue/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __extends } from \"tslib\";\nimport { Emitter } from '@segment/analytics-core';\nimport { backoff } from './backoff';\n/**\n * @internal\n */\nexport var ON_REMOVE_FROM_FUTURE = 'onRemoveFromFuture';\nvar PriorityQueue = /** @class */ (function (_super) {\n    __extends(PriorityQueue, _super);\n    function PriorityQueue(maxAttempts, queue, seen) {\n        var _this = _super.call(this) || this;\n        _this.future = [];\n        _this.maxAttempts = maxAttempts;\n        _this.queue = queue;\n        _this.seen = seen !== null && seen !== void 0 ? seen : {};\n        return _this;\n    }\n    PriorityQueue.prototype.push = function () {\n        var _this = this;\n        var operations = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            operations[_i] = arguments[_i];\n        }\n        var accepted = operations.map(function (operation) {\n            var attempts = _this.updateAttempts(operation);\n            if (attempts > _this.maxAttempts || _this.includes(operation)) {\n                return false;\n            }\n            _this.queue.push(operation);\n            return true;\n        });\n        this.queue = this.queue.sort(function (a, b) { return _this.getAttempts(a) - _this.getAttempts(b); });\n        return accepted;\n    };\n    PriorityQueue.prototype.pushWithBackoff = function (operation) {\n        var _this = this;\n        if (this.getAttempts(operation) === 0) {\n            return this.push(operation)[0];\n        }\n        var attempt = this.updateAttempts(operation);\n        if (attempt > this.maxAttempts || this.includes(operation)) {\n            return false;\n        }\n        var timeout = backoff({ attempt: attempt - 1 });\n        setTimeout(function () {\n            _this.queue.push(operation);\n            // remove from future list\n            _this.future = _this.future.filter(function (f) { return f.id !== operation.id; });\n            // Lets listeners know that a 'future' message is now available in the queue\n            _this.emit(ON_REMOVE_FROM_FUTURE);\n        }, timeout);\n        this.future.push(operation);\n        return true;\n    };\n    PriorityQueue.prototype.getAttempts = function (operation) {\n        var _a;\n        return (_a = this.seen[operation.id]) !== null && _a !== void 0 ? _a : 0;\n    };\n    PriorityQueue.prototype.updateAttempts = function (operation) {\n        this.seen[operation.id] = this.getAttempts(operation) + 1;\n        return this.getAttempts(operation);\n    };\n    PriorityQueue.prototype.includes = function (operation) {\n        return (this.queue.includes(operation) ||\n            this.future.includes(operation) ||\n            Boolean(this.queue.find(function (i) { return i.id === operation.id; })) ||\n            Boolean(this.future.find(function (i) { return i.id === operation.id; })));\n    };\n    PriorityQueue.prototype.pop = function () {\n        return this.queue.shift();\n    };\n    Object.defineProperty(PriorityQueue.prototype, \"length\", {\n        get: function () {\n            return this.queue.length;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Object.defineProperty(PriorityQueue.prototype, \"todo\", {\n        get: function () {\n            return this.queue.length + this.future.length;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    return PriorityQueue;\n}(Emitter));\nexport { PriorityQueue };\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}