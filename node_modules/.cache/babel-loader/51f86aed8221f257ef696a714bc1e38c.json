{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { isServer } from '../../core/environment';\nimport { loadScript } from '../../lib/load-script';\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn';\nexport function remoteMiddlewares(ctx, settings, obfuscate) {\n  var _a;\n\n  return __awaiter(this, void 0, void 0, function () {\n    var path, remoteMiddleware, names, scripts, middleware;\n\n    var _this = this;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          if (isServer()) {\n            return [2\n            /*return*/\n            , []];\n          }\n\n          path = getNextIntegrationsURL();\n          remoteMiddleware = (_a = settings.enabledMiddleware) !== null && _a !== void 0 ? _a : {};\n          names = Object.entries(remoteMiddleware).filter(function (_a) {\n            var _ = _a[0],\n                enabled = _a[1];\n            return enabled;\n          }).map(function (_a) {\n            var name = _a[0];\n            return name;\n          });\n          scripts = names.map(function (name) {\n            return __awaiter(_this, void 0, void 0, function () {\n              var nonNamespaced, bundleName, fullPath, error_1;\n              return __generator(this, function (_a) {\n                switch (_a.label) {\n                  case 0:\n                    nonNamespaced = name.replace('@segment/', '');\n                    bundleName = nonNamespaced;\n\n                    if (obfuscate) {\n                      bundleName = btoa(nonNamespaced).replace(/=/g, '');\n                    }\n\n                    fullPath = \"\".concat(path, \"/middleware/\").concat(bundleName, \"/latest/\").concat(bundleName, \".js.gz\");\n                    _a.label = 1;\n\n                  case 1:\n                    _a.trys.push([1, 3,, 4]);\n\n                    return [4\n                    /*yield*/\n                    , loadScript(fullPath) // @ts-ignore\n                    ];\n\n                  case 2:\n                    _a.sent(); // @ts-ignore\n\n\n                    return [2\n                    /*return*/\n                    , window[\"\".concat(nonNamespaced, \"Middleware\")]];\n\n                  case 3:\n                    error_1 = _a.sent();\n                    ctx.log('error', error_1);\n                    ctx.stats.increment('failed_remote_middleware');\n                    return [3\n                    /*break*/\n                    , 4];\n\n                  case 4:\n                    return [2\n                    /*return*/\n                    ];\n                }\n              });\n            });\n          });\n          return [4\n          /*yield*/\n          , Promise.all(scripts)];\n\n        case 1:\n          middleware = _b.sent();\n          middleware = middleware.filter(Boolean);\n          return [2\n          /*return*/\n          , middleware];\n      }\n    });\n  });\n}","map":{"version":3,"sources":["../../../../src/plugins/remote-middleware/index.ts"],"names":[],"mappings":";AAEA,SAAS,QAAT,QAAyB,wBAAzB;AACA,SAAS,UAAT,QAA2B,uBAA3B;AACA,SAAS,sBAAT,QAAuC,qBAAvC;AAGA,OAAM,SAAgB,iBAAhB,CACJ,GADI,EAEJ,QAFI,EAGJ,SAHI,EAGe;;;;;;;;;;;UAEnB,IAAI,QAAQ,EAAZ,EAAgB;YACd,OAAA,CAAA;YAAA;YAAA,EAAO,EAAP,CAAA;UACD;;UACK,IAAI,GAAG,sBAAsB,EAA7B;UACA,gBAAgB,GAAG,CAAA,EAAA,GAAA,QAAQ,CAAC,iBAAT,MAA0B,IAA1B,IAA0B,EAAA,KAAA,KAAA,CAA1B,GAA0B,EAA1B,GAA8B,EAAjD;UACA,KAAK,GAAG,MAAM,CAAC,OAAP,CAAe,gBAAf,EACX,MADW,CACJ,UAAC,EAAD,EAAa;gBAAX,CAAC,GAAA,EAAA,CAAA,CAAA,C;gBAAE,OAAO,GAAA,EAAA,CAAA,CAAA,C;YAAM,OAAA,OAAA;UAAO,CADrB,EAEX,GAFW,CAEP,UAAC,EAAD,EAAO;gBAAL,IAAI,GAAA,EAAA,CAAA,CAAA,C;YAAM,OAAA,IAAA;UAAI,CAFT,CAAR;UAIA,OAAO,GAAG,KAAK,CAAC,GAAN,CAAU,UAAO,IAAP,EAAW;YAAA,OAAA,SAAA,CAAA,KAAA,EAAA,KAAA,CAAA,EAAA,KAAA,CAAA,EAAA,YAAA;;;;;oBAC7B,aAAa,GAAG,IAAI,CAAC,OAAL,CAAa,WAAb,EAA0B,EAA1B,CAAhB;oBACF,UAAU,GAAG,aAAb;;oBACJ,IAAI,SAAJ,EAAe;sBACb,UAAU,GAAG,IAAI,CAAC,aAAD,CAAJ,CAAoB,OAApB,CAA4B,IAA5B,EAAkC,EAAlC,CAAb;oBACD;;oBACK,QAAQ,GAAG,GAAA,MAAA,CAAG,IAAH,EAAO,cAAP,EAAO,MAAP,CAAsB,UAAtB,EAAgC,UAAhC,EAAgC,MAAhC,CAA2C,UAA3C,EAAqD,QAArD,CAAX;;;;;;oBAGJ,OAAA,CAAA;oBAAA;oBAAA,EAAM,UAAU,CAAC,QAAD,CAAhB,CACA;oBADA,CAAA;;;oBAAA,EAAA,CAAA,IAAA,G,CACA;;;oBACA,OAAA,CAAA;oBAAA;oBAAA,EAAO,MAAM,CAAC,GAAA,MAAA,CAAG,aAAH,EAAgB,YAAhB,CAAD,CAAb,CAAA;;;;oBAEA,GAAG,CAAC,GAAJ,CAAQ,OAAR,EAAiB,OAAjB;oBACA,GAAG,CAAC,KAAJ,CAAU,SAAV,CAAoB,0BAApB;;;;;;;;;;;aAdiC,CAAA;UAgBpC,CAhBe,CAAV;UAkBW,OAAA,CAAA;UAAA;UAAA,EAAM,OAAO,CAAC,GAAR,CAAY,OAAZ,CAAN,CAAA;;;UAAb,UAAU,GAAG,EAAA,CAAA,IAAA,EAAb;UACJ,UAAU,GAAG,UAAU,CAAC,MAAX,CAAkB,OAAlB,CAAb;UAEA,OAAA,CAAA;UAAA;UAAA,EAAO,UAAP,CAAA;;;;AACD","sourceRoot":"","sourcesContent":["import { __awaiter, __generator } from \"tslib\";\nimport { isServer } from '../../core/environment';\nimport { loadScript } from '../../lib/load-script';\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn';\nexport function remoteMiddlewares(ctx, settings, obfuscate) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function () {\n        var path, remoteMiddleware, names, scripts, middleware;\n        var _this = this;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    if (isServer()) {\n                        return [2 /*return*/, []];\n                    }\n                    path = getNextIntegrationsURL();\n                    remoteMiddleware = (_a = settings.enabledMiddleware) !== null && _a !== void 0 ? _a : {};\n                    names = Object.entries(remoteMiddleware)\n                        .filter(function (_a) {\n                        var _ = _a[0], enabled = _a[1];\n                        return enabled;\n                    })\n                        .map(function (_a) {\n                        var name = _a[0];\n                        return name;\n                    });\n                    scripts = names.map(function (name) { return __awaiter(_this, void 0, void 0, function () {\n                        var nonNamespaced, bundleName, fullPath, error_1;\n                        return __generator(this, function (_a) {\n                            switch (_a.label) {\n                                case 0:\n                                    nonNamespaced = name.replace('@segment/', '');\n                                    bundleName = nonNamespaced;\n                                    if (obfuscate) {\n                                        bundleName = btoa(nonNamespaced).replace(/=/g, '');\n                                    }\n                                    fullPath = \"\".concat(path, \"/middleware/\").concat(bundleName, \"/latest/\").concat(bundleName, \".js.gz\");\n                                    _a.label = 1;\n                                case 1:\n                                    _a.trys.push([1, 3, , 4]);\n                                    return [4 /*yield*/, loadScript(fullPath)\n                                        // @ts-ignore\n                                    ];\n                                case 2:\n                                    _a.sent();\n                                    // @ts-ignore\n                                    return [2 /*return*/, window[\"\".concat(nonNamespaced, \"Middleware\")]];\n                                case 3:\n                                    error_1 = _a.sent();\n                                    ctx.log('error', error_1);\n                                    ctx.stats.increment('failed_remote_middleware');\n                                    return [3 /*break*/, 4];\n                                case 4: return [2 /*return*/];\n                            }\n                        });\n                    }); });\n                    return [4 /*yield*/, Promise.all(scripts)];\n                case 1:\n                    middleware = _b.sent();\n                    middleware = middleware.filter(Boolean);\n                    return [2 /*return*/, middleware];\n            }\n        });\n    });\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}