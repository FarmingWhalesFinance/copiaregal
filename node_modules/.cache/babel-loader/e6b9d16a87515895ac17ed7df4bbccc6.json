{"ast":null,"code":"import { __awaiter, __generator, __spreadArray } from \"tslib\";\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn';\nimport { loadScript, unloadScript } from '../../lib/load-script';\n\nfunction normalizeName(name) {\n  return name.toLowerCase().replace('.', '').replace(/\\s+/g, '-');\n}\n\nfunction obfuscatePathName(pathName, obfuscate) {\n  if (obfuscate === void 0) {\n    obfuscate = false;\n  }\n\n  return obfuscate ? btoa(pathName).replace(/=/g, '') : undefined;\n}\n\nfunction recordLoadMetrics(fullPath, ctx, name) {\n  var _a, _b;\n\n  try {\n    var metric = ((_b = (_a = window === null || window === void 0 ? void 0 : window.performance) === null || _a === void 0 ? void 0 : _a.getEntriesByName(fullPath, 'resource')) !== null && _b !== void 0 ? _b : [])[0]; // we assume everything that took under 100ms is cached\n\n    metric && ctx.stats.gauge('legacy_destination_time', Math.round(metric.duration), __spreadArray([name], metric.duration < 100 ? ['cached'] : [], true));\n  } catch (_) {// not available\n  }\n}\n\nexport function loadIntegration(ctx, analyticsInstance, name, version, settings, obfuscate) {\n  return __awaiter(this, void 0, void 0, function () {\n    var pathName, obfuscatedPathName, path, fullPath, err_1, deps, integrationBuilder, analyticsStub, integration;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          pathName = normalizeName(name);\n          obfuscatedPathName = obfuscatePathName(pathName, obfuscate);\n          path = getNextIntegrationsURL();\n          fullPath = \"\".concat(path, \"/integrations/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \"/\").concat(version, \"/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \".dynamic.js.gz\");\n          _a.label = 1;\n\n        case 1:\n          _a.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , loadScript(fullPath)];\n\n        case 2:\n          _a.sent();\n\n          recordLoadMetrics(fullPath, ctx, name);\n          return [3\n          /*break*/\n          , 4];\n\n        case 3:\n          err_1 = _a.sent();\n          ctx.stats.gauge('legacy_destination_time', -1, [\"plugin:\".concat(name), \"failed\"]);\n          throw err_1;\n\n        case 4:\n          deps = window[\"\".concat(pathName, \"Deps\")];\n          return [4\n          /*yield*/\n          , Promise.all(deps.map(function (dep) {\n            return loadScript(path + dep + '.gz');\n          })) // @ts-ignore\n          ];\n\n        case 5:\n          _a.sent(); // @ts-ignore\n\n\n          window[\"\".concat(pathName, \"Loader\")]();\n          integrationBuilder = window[\"\".concat(pathName, \"Integration\")]; // GA and Appcues use a different interface to instantiating integrations\n\n          if (integrationBuilder.Integration) {\n            analyticsStub = {\n              user: function () {\n                return analyticsInstance.user();\n              },\n              addIntegration: function () {}\n            };\n            integrationBuilder(analyticsStub);\n            integrationBuilder = integrationBuilder.Integration;\n          }\n\n          integration = new integrationBuilder(settings);\n          integration.analytics = analyticsInstance;\n          return [2\n          /*return*/\n          , integration];\n      }\n    });\n  });\n}\nexport function unloadIntegration(name, version, obfuscate) {\n  return __awaiter(this, void 0, void 0, function () {\n    var path, pathName, obfuscatedPathName, fullPath;\n    return __generator(this, function (_a) {\n      path = getNextIntegrationsURL();\n      pathName = normalizeName(name);\n      obfuscatedPathName = obfuscatePathName(name, obfuscate);\n      fullPath = \"\".concat(path, \"/integrations/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \"/\").concat(version, \"/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \".dynamic.js.gz\");\n      return [2\n      /*return*/\n      , unloadScript(fullPath)];\n    });\n  });\n}\nexport function resolveVersion(settings) {\n  var _a, _b, _c, _d;\n\n  return (_d = (_b = (_a = settings.versionSettings) === null || _a === void 0 ? void 0 : _a.override) !== null && _b !== void 0 ? _b : (_c = settings.versionSettings) === null || _c === void 0 ? void 0 : _c.version) !== null && _d !== void 0 ? _d : 'latest';\n}","map":{"version":3,"sources":["../../../../src/plugins/ajs-destination/loader.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __awaiter, __generator, __spreadArray } from \"tslib\";\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn';\nimport { loadScript, unloadScript } from '../../lib/load-script';\nfunction normalizeName(name) {\n    return name.toLowerCase().replace('.', '').replace(/\\s+/g, '-');\n}\nfunction obfuscatePathName(pathName, obfuscate) {\n    if (obfuscate === void 0) { obfuscate = false; }\n    return obfuscate ? btoa(pathName).replace(/=/g, '') : undefined;\n}\nfunction recordLoadMetrics(fullPath, ctx, name) {\n    var _a, _b;\n    try {\n        var metric = ((_b = (_a = window === null || window === void 0 ? void 0 : window.performance) === null || _a === void 0 ? void 0 : _a.getEntriesByName(fullPath, 'resource')) !== null && _b !== void 0 ? _b : [])[0];\n        // we assume everything that took under 100ms is cached\n        metric &&\n            ctx.stats.gauge('legacy_destination_time', Math.round(metric.duration), __spreadArray([\n                name\n            ], (metric.duration < 100 ? ['cached'] : []), true));\n    }\n    catch (_) {\n        // not available\n    }\n}\nexport function loadIntegration(ctx, analyticsInstance, name, version, settings, obfuscate) {\n    return __awaiter(this, void 0, void 0, function () {\n        var pathName, obfuscatedPathName, path, fullPath, err_1, deps, integrationBuilder, analyticsStub, integration;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    pathName = normalizeName(name);\n                    obfuscatedPathName = obfuscatePathName(pathName, obfuscate);\n                    path = getNextIntegrationsURL();\n                    fullPath = \"\".concat(path, \"/integrations/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \"/\").concat(version, \"/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \".dynamic.js.gz\");\n                    _a.label = 1;\n                case 1:\n                    _a.trys.push([1, 3, , 4]);\n                    return [4 /*yield*/, loadScript(fullPath)];\n                case 2:\n                    _a.sent();\n                    recordLoadMetrics(fullPath, ctx, name);\n                    return [3 /*break*/, 4];\n                case 3:\n                    err_1 = _a.sent();\n                    ctx.stats.gauge('legacy_destination_time', -1, [\"plugin:\".concat(name), \"failed\"]);\n                    throw err_1;\n                case 4:\n                    deps = window[\"\".concat(pathName, \"Deps\")];\n                    return [4 /*yield*/, Promise.all(deps.map(function (dep) { return loadScript(path + dep + '.gz'); }))\n                        // @ts-ignore\n                    ];\n                case 5:\n                    _a.sent();\n                    // @ts-ignore\n                    window[\"\".concat(pathName, \"Loader\")]();\n                    integrationBuilder = window[\"\".concat(pathName, \"Integration\")];\n                    // GA and Appcues use a different interface to instantiating integrations\n                    if (integrationBuilder.Integration) {\n                        analyticsStub = {\n                            user: function () { return analyticsInstance.user(); },\n                            addIntegration: function () { },\n                        };\n                        integrationBuilder(analyticsStub);\n                        integrationBuilder = integrationBuilder.Integration;\n                    }\n                    integration = new integrationBuilder(settings);\n                    integration.analytics = analyticsInstance;\n                    return [2 /*return*/, integration];\n            }\n        });\n    });\n}\nexport function unloadIntegration(name, version, obfuscate) {\n    return __awaiter(this, void 0, void 0, function () {\n        var path, pathName, obfuscatedPathName, fullPath;\n        return __generator(this, function (_a) {\n            path = getNextIntegrationsURL();\n            pathName = normalizeName(name);\n            obfuscatedPathName = obfuscatePathName(name, obfuscate);\n            fullPath = \"\".concat(path, \"/integrations/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \"/\").concat(version, \"/\").concat(obfuscatedPathName !== null && obfuscatedPathName !== void 0 ? obfuscatedPathName : pathName, \".dynamic.js.gz\");\n            return [2 /*return*/, unloadScript(fullPath)];\n        });\n    });\n}\nexport function resolveVersion(settings) {\n    var _a, _b, _c, _d;\n    return ((_d = (_b = (_a = settings.versionSettings) === null || _a === void 0 ? void 0 : _a.override) !== null && _b !== void 0 ? _b : (_c = settings.versionSettings) === null || _c === void 0 ? void 0 : _c.version) !== null && _d !== void 0 ? _d : 'latest');\n}\n//# sourceMappingURL=loader.js.map"]},"metadata":{},"sourceType":"module"}