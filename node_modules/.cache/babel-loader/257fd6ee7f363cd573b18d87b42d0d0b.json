{"ast":null,"code":"import { __assign } from \"tslib\";\nimport jar from 'js-cookie';\nimport { gracefulDecodeURIComponent } from '../../core/query-string/gracefulDecodeURIComponent';\nimport { tld } from '../../core/user/tld';\nimport { version } from '../../generated/version';\nvar cookieOptions;\n\nfunction getCookieOptions() {\n  if (cookieOptions) {\n    return cookieOptions;\n  }\n\n  var domain = tld(window.location.href);\n  cookieOptions = {\n    expires: 31536000000,\n    secure: false,\n    path: '/'\n  };\n\n  if (domain) {\n    cookieOptions.domain = domain;\n  }\n\n  return cookieOptions;\n} // Default value will be updated to 'web' in `bundle-umd.ts` for web build.\n\n\nvar _version = 'npm';\nexport function setVersionType(version) {\n  _version = version;\n}\nexport function getVersionType() {\n  return _version;\n}\nexport function ampId() {\n  var ampId = jar.get('_ga');\n\n  if (ampId && ampId.startsWith('amp')) {\n    return ampId;\n  }\n}\nexport function utm(query) {\n  if (query.startsWith('?')) {\n    query = query.substring(1);\n  }\n\n  query = query.replace(/\\?/g, '&');\n  return query.split('&').reduce(function (acc, str) {\n    var _a = str.split('='),\n        k = _a[0],\n        _b = _a[1],\n        v = _b === void 0 ? '' : _b;\n\n    if (k.includes('utm_') && k.length > 4) {\n      var utmParam = k.substr(4);\n\n      if (utmParam === 'campaign') {\n        utmParam = 'name';\n      }\n\n      acc[utmParam] = gracefulDecodeURIComponent(v);\n    }\n\n    return acc;\n  }, {});\n}\n\nfunction ads(query) {\n  var queryIds = {\n    btid: 'dataxu',\n    urid: 'millennial-media'\n  };\n\n  if (query.startsWith('?')) {\n    query = query.substring(1);\n  }\n\n  query = query.replace(/\\?/g, '&');\n  var parts = query.split('&');\n\n  for (var _i = 0, parts_1 = parts; _i < parts_1.length; _i++) {\n    var part = parts_1[_i];\n\n    var _a = part.split('='),\n        k = _a[0],\n        v = _a[1];\n\n    if (queryIds[k]) {\n      return {\n        id: v,\n        type: queryIds[k]\n      };\n    }\n  }\n}\n\nfunction referrerId(query, ctx, disablePersistance) {\n  var stored = jar.get('s:context.referrer');\n  var ad = ads(query);\n  stored = stored ? JSON.parse(stored) : undefined;\n  ad = ad !== null && ad !== void 0 ? ad : stored;\n\n  if (!ad) {\n    return;\n  }\n\n  if (ctx) {\n    ctx.referrer = __assign(__assign({}, ctx.referrer), ad);\n  }\n\n  if (!disablePersistance) {\n    jar.set('s:context.referrer', JSON.stringify(ad), getCookieOptions());\n  }\n}\n\nexport function normalize(analytics, json, settings, integrations) {\n  var _a, _b, _c, _d;\n\n  var user = analytics.user();\n  var query = window.location.search;\n  json.context = (_b = (_a = json.context) !== null && _a !== void 0 ? _a : json.options) !== null && _b !== void 0 ? _b : {};\n  var ctx = json.context;\n  var anonId = json.anonymousId;\n  delete json.options;\n  json.writeKey = settings === null || settings === void 0 ? void 0 : settings.apiKey;\n  ctx.userAgent = window.navigator.userAgent; // @ts-ignore\n\n  var locale = navigator.userLanguage || navigator.language;\n\n  if (typeof ctx.locale === 'undefined' && typeof locale !== 'undefined') {\n    ctx.locale = locale;\n  }\n\n  if (!ctx.library) {\n    var type = getVersionType();\n\n    if (type === 'web') {\n      ctx.library = {\n        name: 'analytics.js',\n        version: \"next-\".concat(version)\n      };\n    } else {\n      ctx.library = {\n        name: 'analytics.js',\n        version: \"npm:next-\".concat(version)\n      };\n    }\n  }\n\n  if (query && !ctx.campaign) {\n    ctx.campaign = utm(query);\n  }\n\n  referrerId(query, ctx, (_c = analytics.options.disableClientPersistence) !== null && _c !== void 0 ? _c : false);\n  json.userId = json.userId || user.id();\n  json.anonymousId = user.anonymousId(anonId);\n  json.sentAt = new Date();\n  var failed = analytics.queue.failedInitializations || [];\n\n  if (failed.length > 0) {\n    json._metadata = {\n      failedInitializations: failed\n    };\n  }\n\n  var bundled = [];\n  var unbundled = [];\n\n  for (var key in integrations) {\n    var integration = integrations[key];\n\n    if (key === 'Segment.io') {\n      bundled.push(key);\n    }\n\n    if (integration.bundlingStatus === 'bundled') {\n      bundled.push(key);\n    }\n\n    if (integration.bundlingStatus === 'unbundled') {\n      unbundled.push(key);\n    }\n  } // This will make sure that the disabled cloud mode destinations will be\n  // included in the unbundled list.\n\n\n  for (var _i = 0, _e = (settings === null || settings === void 0 ? void 0 : settings.unbundledIntegrations) || []; _i < _e.length; _i++) {\n    var settingsUnbundled = _e[_i];\n\n    if (!unbundled.includes(settingsUnbundled)) {\n      unbundled.push(settingsUnbundled);\n    }\n  }\n\n  var configIds = (_d = settings === null || settings === void 0 ? void 0 : settings.maybeBundledConfigIds) !== null && _d !== void 0 ? _d : {};\n  var bundledConfigIds = [];\n  bundled.sort().forEach(function (name) {\n    var _a;\n\n    ;\n    ((_a = configIds[name]) !== null && _a !== void 0 ? _a : []).forEach(function (id) {\n      bundledConfigIds.push(id);\n    });\n  });\n\n  if ((settings === null || settings === void 0 ? void 0 : settings.addBundledMetadata) !== false) {\n    json._metadata = __assign(__assign({}, json._metadata), {\n      bundled: bundled.sort(),\n      unbundled: unbundled.sort(),\n      bundledIds: bundledConfigIds\n    });\n  }\n\n  var amp = ampId();\n\n  if (amp) {\n    ctx.amp = {\n      id: amp\n    };\n  }\n\n  return json;\n}","map":{"version":3,"sources":["../../../../src/plugins/segmentio/normalize.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign } from \"tslib\";\nimport jar from 'js-cookie';\nimport { gracefulDecodeURIComponent } from '../../core/query-string/gracefulDecodeURIComponent';\nimport { tld } from '../../core/user/tld';\nimport { version } from '../../generated/version';\nvar cookieOptions;\nfunction getCookieOptions() {\n    if (cookieOptions) {\n        return cookieOptions;\n    }\n    var domain = tld(window.location.href);\n    cookieOptions = {\n        expires: 31536000000,\n        secure: false,\n        path: '/',\n    };\n    if (domain) {\n        cookieOptions.domain = domain;\n    }\n    return cookieOptions;\n}\n// Default value will be updated to 'web' in `bundle-umd.ts` for web build.\nvar _version = 'npm';\nexport function setVersionType(version) {\n    _version = version;\n}\nexport function getVersionType() {\n    return _version;\n}\nexport function ampId() {\n    var ampId = jar.get('_ga');\n    if (ampId && ampId.startsWith('amp')) {\n        return ampId;\n    }\n}\nexport function utm(query) {\n    if (query.startsWith('?')) {\n        query = query.substring(1);\n    }\n    query = query.replace(/\\?/g, '&');\n    return query.split('&').reduce(function (acc, str) {\n        var _a = str.split('='), k = _a[0], _b = _a[1], v = _b === void 0 ? '' : _b;\n        if (k.includes('utm_') && k.length > 4) {\n            var utmParam = k.substr(4);\n            if (utmParam === 'campaign') {\n                utmParam = 'name';\n            }\n            acc[utmParam] = gracefulDecodeURIComponent(v);\n        }\n        return acc;\n    }, {});\n}\nfunction ads(query) {\n    var queryIds = {\n        btid: 'dataxu',\n        urid: 'millennial-media',\n    };\n    if (query.startsWith('?')) {\n        query = query.substring(1);\n    }\n    query = query.replace(/\\?/g, '&');\n    var parts = query.split('&');\n    for (var _i = 0, parts_1 = parts; _i < parts_1.length; _i++) {\n        var part = parts_1[_i];\n        var _a = part.split('='), k = _a[0], v = _a[1];\n        if (queryIds[k]) {\n            return {\n                id: v,\n                type: queryIds[k],\n            };\n        }\n    }\n}\nfunction referrerId(query, ctx, disablePersistance) {\n    var stored = jar.get('s:context.referrer');\n    var ad = ads(query);\n    stored = stored ? JSON.parse(stored) : undefined;\n    ad = ad !== null && ad !== void 0 ? ad : stored;\n    if (!ad) {\n        return;\n    }\n    if (ctx) {\n        ctx.referrer = __assign(__assign({}, ctx.referrer), ad);\n    }\n    if (!disablePersistance) {\n        jar.set('s:context.referrer', JSON.stringify(ad), getCookieOptions());\n    }\n}\nexport function normalize(analytics, json, settings, integrations) {\n    var _a, _b, _c, _d;\n    var user = analytics.user();\n    var query = window.location.search;\n    json.context = (_b = (_a = json.context) !== null && _a !== void 0 ? _a : json.options) !== null && _b !== void 0 ? _b : {};\n    var ctx = json.context;\n    var anonId = json.anonymousId;\n    delete json.options;\n    json.writeKey = settings === null || settings === void 0 ? void 0 : settings.apiKey;\n    ctx.userAgent = window.navigator.userAgent;\n    // @ts-ignore\n    var locale = navigator.userLanguage || navigator.language;\n    if (typeof ctx.locale === 'undefined' && typeof locale !== 'undefined') {\n        ctx.locale = locale;\n    }\n    if (!ctx.library) {\n        var type = getVersionType();\n        if (type === 'web') {\n            ctx.library = {\n                name: 'analytics.js',\n                version: \"next-\".concat(version),\n            };\n        }\n        else {\n            ctx.library = {\n                name: 'analytics.js',\n                version: \"npm:next-\".concat(version),\n            };\n        }\n    }\n    if (query && !ctx.campaign) {\n        ctx.campaign = utm(query);\n    }\n    referrerId(query, ctx, (_c = analytics.options.disableClientPersistence) !== null && _c !== void 0 ? _c : false);\n    json.userId = json.userId || user.id();\n    json.anonymousId = user.anonymousId(anonId);\n    json.sentAt = new Date();\n    var failed = analytics.queue.failedInitializations || [];\n    if (failed.length > 0) {\n        json._metadata = { failedInitializations: failed };\n    }\n    var bundled = [];\n    var unbundled = [];\n    for (var key in integrations) {\n        var integration = integrations[key];\n        if (key === 'Segment.io') {\n            bundled.push(key);\n        }\n        if (integration.bundlingStatus === 'bundled') {\n            bundled.push(key);\n        }\n        if (integration.bundlingStatus === 'unbundled') {\n            unbundled.push(key);\n        }\n    }\n    // This will make sure that the disabled cloud mode destinations will be\n    // included in the unbundled list.\n    for (var _i = 0, _e = (settings === null || settings === void 0 ? void 0 : settings.unbundledIntegrations) || []; _i < _e.length; _i++) {\n        var settingsUnbundled = _e[_i];\n        if (!unbundled.includes(settingsUnbundled)) {\n            unbundled.push(settingsUnbundled);\n        }\n    }\n    var configIds = (_d = settings === null || settings === void 0 ? void 0 : settings.maybeBundledConfigIds) !== null && _d !== void 0 ? _d : {};\n    var bundledConfigIds = [];\n    bundled.sort().forEach(function (name) {\n        var _a;\n        ;\n        ((_a = configIds[name]) !== null && _a !== void 0 ? _a : []).forEach(function (id) {\n            bundledConfigIds.push(id);\n        });\n    });\n    if ((settings === null || settings === void 0 ? void 0 : settings.addBundledMetadata) !== false) {\n        json._metadata = __assign(__assign({}, json._metadata), { bundled: bundled.sort(), unbundled: unbundled.sort(), bundledIds: bundledConfigIds });\n    }\n    var amp = ampId();\n    if (amp) {\n        ctx.amp = { id: amp };\n    }\n    return json;\n}\n//# sourceMappingURL=normalize.js.map"]},"metadata":{},"sourceType":"module"}