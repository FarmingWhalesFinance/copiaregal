{"ast":null,"code":"/**\n * Get the current page's canonical URL.\n *\n * @return {string|undefined}\n */\nfunction canonical() {\n  var tags = document.getElementsByTagName('link');\n  var canon = '';\n  Array.prototype.slice.call(tags).forEach(function (tag) {\n    if (tag.getAttribute('rel') === 'canonical') {\n      canon = tag.getAttribute('href');\n    }\n  });\n  return canon;\n}\n/**\n * Return the canonical path for the page.\n */\n\n\nfunction canonicalPath() {\n  var canon = canonical();\n\n  if (!canon) {\n    return window.location.pathname;\n  }\n\n  var a = document.createElement('a');\n  a.href = canon;\n  var pathname = !a.pathname.startsWith('/') ? '/' + a.pathname : a.pathname;\n  return pathname;\n}\n/**\n * Return the canonical URL for the page concat the given `search`\n * and strip the hash.\n */\n\n\nexport function canonicalUrl(search) {\n  if (search === void 0) {\n    search = '';\n  }\n\n  var canon = canonical();\n\n  if (canon) {\n    return canon.includes('?') ? canon : \"\".concat(canon).concat(search);\n  }\n\n  var url = window.location.href;\n  var i = url.indexOf('#');\n  return i === -1 ? url : url.slice(0, i);\n}\n/**\n * Return a default `options.context.page` object.\n *\n * https://segment.com/docs/spec/page/#properties\n */\n\nexport function pageDefaults() {\n  return {\n    path: canonicalPath(),\n    referrer: document.referrer,\n    search: location.search,\n    title: document.title,\n    url: canonicalUrl(location.search)\n  };\n}\n\nfunction enrichPageContext(ctx) {\n  var _a;\n\n  var event = ctx.event;\n  event.context = event.context || {};\n  var pageContext = pageDefaults();\n  var pageProps = (_a = event.properties) !== null && _a !== void 0 ? _a : {};\n  Object.keys(pageContext).forEach(function (key) {\n    if (pageProps[key]) {\n      pageContext[key] = pageProps[key];\n    }\n  });\n\n  if (event.context.page) {\n    pageContext = Object.assign({}, pageContext, event.context.page);\n  }\n\n  event.context = Object.assign({}, event.context, {\n    page: pageContext\n  });\n  ctx.event = event;\n  return ctx;\n}\n\nexport var pageEnrichment = {\n  name: 'Page Enrichment',\n  version: '0.1.0',\n  isLoaded: function () {\n    return true;\n  },\n  load: function () {\n    return Promise.resolve();\n  },\n  type: 'before',\n  page: function (ctx) {\n    ctx.event.properties = Object.assign({}, pageDefaults(), ctx.event.properties);\n\n    if (ctx.event.name) {\n      ctx.event.properties.name = ctx.event.name;\n    }\n\n    return enrichPageContext(ctx);\n  },\n  alias: enrichPageContext,\n  track: enrichPageContext,\n  identify: enrichPageContext,\n  group: enrichPageContext\n};","map":{"version":3,"sources":["../../../../src/plugins/page-enrichment/index.ts"],"names":[],"mappings":"AAYA;;;;AAIG;AACH,SAAS,SAAT,GAAkB;EAChB,IAAM,IAAI,GAAG,QAAQ,CAAC,oBAAT,CAA8B,MAA9B,CAAb;EACA,IAAI,KAAK,GAAkB,EAA3B;EAEA,KAAK,CAAC,SAAN,CAAgB,KAAhB,CAAsB,IAAtB,CAA2B,IAA3B,EAAiC,OAAjC,CAAyC,UAAC,GAAD,EAAI;IAC3C,IAAI,GAAG,CAAC,YAAJ,CAAiB,KAAjB,MAA4B,WAAhC,EAA6C;MAC3C,KAAK,GAAG,GAAG,CAAC,YAAJ,CAAiB,MAAjB,CAAR;IACD;EACF,CAJD;EAMA,OAAO,KAAP;AACD;AAED;;AAEG;;;AAEH,SAAS,aAAT,GAAsB;EACpB,IAAM,KAAK,GAAG,SAAS,EAAvB;;EACA,IAAI,CAAC,KAAL,EAAY;IACV,OAAO,MAAM,CAAC,QAAP,CAAgB,QAAvB;EACD;;EAED,IAAM,CAAC,GAAG,QAAQ,CAAC,aAAT,CAAuB,GAAvB,CAAV;EACA,CAAC,CAAC,IAAF,GAAS,KAAT;EACA,IAAM,QAAQ,GAAG,CAAC,CAAC,CAAC,QAAF,CAAW,UAAX,CAAsB,GAAtB,CAAD,GAA8B,MAAM,CAAC,CAAC,QAAtC,GAAiD,CAAC,CAAC,QAApE;EAEA,OAAO,QAAP;AACD;AAED;;;AAGG;;;AAEH,OAAM,SAAU,YAAV,CAAuB,MAAvB,EAAkC;EAAX,IAAA,MAAA,KAAA,KAAA,CAAA,EAAA;IAAA,MAAA,GAAA,EAAA;EAAW;;EACtC,IAAM,KAAK,GAAG,SAAS,EAAvB;;EACA,IAAI,KAAJ,EAAW;IACT,OAAO,KAAK,CAAC,QAAN,CAAe,GAAf,IAAsB,KAAtB,GAA8B,GAAA,MAAA,CAAG,KAAH,EAAQ,MAAR,CAAW,MAAX,CAArC;EACD;;EACD,IAAM,GAAG,GAAG,MAAM,CAAC,QAAP,CAAgB,IAA5B;EACA,IAAM,CAAC,GAAG,GAAG,CAAC,OAAJ,CAAY,GAAZ,CAAV;EACA,OAAO,CAAC,KAAK,CAAC,CAAP,GAAW,GAAX,GAAiB,GAAG,CAAC,KAAJ,CAAU,CAAV,EAAa,CAAb,CAAxB;AACD;AAED;;;;AAIG;;AAEH,OAAM,SAAU,YAAV,GAAsB;EAC1B,OAAO;IACL,IAAI,EAAE,aAAa,EADd;IAEL,QAAQ,EAAE,QAAQ,CAAC,QAFd;IAGL,MAAM,EAAE,QAAQ,CAAC,MAHZ;IAIL,KAAK,EAAE,QAAQ,CAAC,KAJX;IAKL,GAAG,EAAE,YAAY,CAAC,QAAQ,CAAC,MAAV;EALZ,CAAP;AAOD;;AAED,SAAS,iBAAT,CAA2B,GAA3B,EAAuC;;;EACrC,IAAM,KAAK,GAAG,GAAG,CAAC,KAAlB;EACA,KAAK,CAAC,OAAN,GAAgB,KAAK,CAAC,OAAN,IAAiB,EAAjC;EACA,IAAI,WAAW,GAAG,YAAY,EAA9B;EACA,IAAM,SAAS,GAAG,CAAA,EAAA,GAAA,KAAK,CAAC,UAAN,MAAgB,IAAhB,IAAgB,EAAA,KAAA,KAAA,CAAhB,GAAgB,EAAhB,GAAoB,EAAtC;EAEA,MAAM,CAAC,IAAP,CAAY,WAAZ,EAAyB,OAAzB,CAAiC,UAAC,GAAD,EAAI;IACnC,IAAI,SAAS,CAAC,GAAD,CAAb,EAAoB;MAClB,WAAW,CAAC,GAAD,CAAX,GAAmB,SAAS,CAAC,GAAD,CAA5B;IACD;EACF,CAJD;;EAMA,IAAI,KAAK,CAAC,OAAN,CAAc,IAAlB,EAAwB;IACtB,WAAW,GAAG,MAAM,CAAC,MAAP,CAAc,EAAd,EAAkB,WAAlB,EAA+B,KAAK,CAAC,OAAN,CAAc,IAA7C,CAAd;EACD;;EAED,KAAK,CAAC,OAAN,GAAgB,MAAM,CAAC,MAAP,CAAc,EAAd,EAAkB,KAAK,CAAC,OAAxB,EAAiC;IAC/C,IAAI,EAAE;EADyC,CAAjC,CAAhB;EAIA,GAAG,CAAC,KAAJ,GAAY,KAAZ;EAEA,OAAO,GAAP;AACD;;AAED,OAAO,IAAM,cAAc,GAAW;EACpC,IAAI,EAAE,iBAD8B;EAEpC,OAAO,EAAE,OAF2B;EAGpC,QAAQ,EAAE,YAAA;IAAM,OAAA,IAAA;EAAI,CAHgB;EAIpC,IAAI,EAAE,YAAA;IAAM,OAAA,OAAO,CAAP,OAAA,EAAA;EAAiB,CAJO;EAKpC,IAAI,EAAE,QAL8B;EAOpC,IAAI,EAAE,UAAC,GAAD,EAAI;IACR,GAAG,CAAC,KAAJ,CAAU,UAAV,GAAuB,MAAM,CAAC,MAAP,CACrB,EADqB,EAErB,YAAY,EAFS,EAGrB,GAAG,CAAC,KAAJ,CAAU,UAHW,CAAvB;;IAMA,IAAI,GAAG,CAAC,KAAJ,CAAU,IAAd,EAAoB;MAClB,GAAG,CAAC,KAAJ,CAAU,UAAV,CAAqB,IAArB,GAA4B,GAAG,CAAC,KAAJ,CAAU,IAAtC;IACD;;IAED,OAAO,iBAAiB,CAAC,GAAD,CAAxB;EACD,CAnBmC;EAqBpC,KAAK,EAAE,iBArB6B;EAsBpC,KAAK,EAAE,iBAtB6B;EAuBpC,QAAQ,EAAE,iBAvB0B;EAwBpC,KAAK,EAAE;AAxB6B,CAA/B","sourceRoot":"","sourcesContent":["/**\n * Get the current page's canonical URL.\n *\n * @return {string|undefined}\n */\nfunction canonical() {\n    var tags = document.getElementsByTagName('link');\n    var canon = '';\n    Array.prototype.slice.call(tags).forEach(function (tag) {\n        if (tag.getAttribute('rel') === 'canonical') {\n            canon = tag.getAttribute('href');\n        }\n    });\n    return canon;\n}\n/**\n * Return the canonical path for the page.\n */\nfunction canonicalPath() {\n    var canon = canonical();\n    if (!canon) {\n        return window.location.pathname;\n    }\n    var a = document.createElement('a');\n    a.href = canon;\n    var pathname = !a.pathname.startsWith('/') ? '/' + a.pathname : a.pathname;\n    return pathname;\n}\n/**\n * Return the canonical URL for the page concat the given `search`\n * and strip the hash.\n */\nexport function canonicalUrl(search) {\n    if (search === void 0) { search = ''; }\n    var canon = canonical();\n    if (canon) {\n        return canon.includes('?') ? canon : \"\".concat(canon).concat(search);\n    }\n    var url = window.location.href;\n    var i = url.indexOf('#');\n    return i === -1 ? url : url.slice(0, i);\n}\n/**\n * Return a default `options.context.page` object.\n *\n * https://segment.com/docs/spec/page/#properties\n */\nexport function pageDefaults() {\n    return {\n        path: canonicalPath(),\n        referrer: document.referrer,\n        search: location.search,\n        title: document.title,\n        url: canonicalUrl(location.search),\n    };\n}\nfunction enrichPageContext(ctx) {\n    var _a;\n    var event = ctx.event;\n    event.context = event.context || {};\n    var pageContext = pageDefaults();\n    var pageProps = (_a = event.properties) !== null && _a !== void 0 ? _a : {};\n    Object.keys(pageContext).forEach(function (key) {\n        if (pageProps[key]) {\n            pageContext[key] = pageProps[key];\n        }\n    });\n    if (event.context.page) {\n        pageContext = Object.assign({}, pageContext, event.context.page);\n    }\n    event.context = Object.assign({}, event.context, {\n        page: pageContext,\n    });\n    ctx.event = event;\n    return ctx;\n}\nexport var pageEnrichment = {\n    name: 'Page Enrichment',\n    version: '0.1.0',\n    isLoaded: function () { return true; },\n    load: function () { return Promise.resolve(); },\n    type: 'before',\n    page: function (ctx) {\n        ctx.event.properties = Object.assign({}, pageDefaults(), ctx.event.properties);\n        if (ctx.event.name) {\n            ctx.event.properties.name = ctx.event.name;\n        }\n        return enrichPageContext(ctx);\n    },\n    alias: enrichPageContext,\n    track: enrichPageContext,\n    identify: enrichPageContext,\n    group: enrichPageContext,\n};\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}