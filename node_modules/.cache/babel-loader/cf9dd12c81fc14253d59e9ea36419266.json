{"ast":null,"code":"import { __assign, __awaiter, __generator } from \"tslib\";\nimport { Alias, Group, Identify, Page, Track } from '@segment/facade';\nimport { isOffline, isOnline } from '../../core/connection';\nimport { Context, ContextCancelation } from '../../core/context';\nimport { isServer } from '../../core/environment';\nimport { attempt } from '../../core/queue/delivery';\nimport { asPromise } from '../../lib/as-promise';\nimport { isPlanEventEnabled } from '../../lib/is-plan-event-enabled';\nimport { mergedOptions } from '../../lib/merged-options';\nimport { pWhile } from '../../lib/p-while';\nimport { PriorityQueue } from '../../lib/priority-queue';\nimport { PersistedPriorityQueue } from '../../lib/priority-queue/persisted';\nimport { applyDestinationMiddleware } from '../middleware';\nimport { tsubMiddleware } from '../routing-middleware';\nimport { loadIntegration, resolveVersion, unloadIntegration } from './loader';\n\nvar klona = function (evt) {\n  return JSON.parse(JSON.stringify(evt));\n};\n\nfunction flushQueue(xt, queue) {\n  return __awaiter(this, void 0, void 0, function () {\n    var failedQueue;\n\n    var _this = this;\n\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          failedQueue = [];\n\n          if (isOffline()) {\n            return [2\n            /*return*/\n            , queue];\n          }\n\n          return [4\n          /*yield*/\n          , pWhile(function () {\n            return queue.length > 0 && isOnline();\n          }, function () {\n            return __awaiter(_this, void 0, void 0, function () {\n              var ctx, result, success;\n              return __generator(this, function (_a) {\n                switch (_a.label) {\n                  case 0:\n                    ctx = queue.pop();\n\n                    if (!ctx) {\n                      return [2\n                      /*return*/\n                      ];\n                    }\n\n                    return [4\n                    /*yield*/\n                    , attempt(ctx, xt)];\n\n                  case 1:\n                    result = _a.sent();\n                    success = result instanceof Context;\n\n                    if (!success) {\n                      failedQueue.push(ctx);\n                    }\n\n                    return [2\n                    /*return*/\n                    ];\n                }\n              });\n            });\n          }) // re-add failed tasks\n          ];\n\n        case 1:\n          _a.sent(); // re-add failed tasks\n\n\n          failedQueue.map(function (failed) {\n            return queue.pushWithBackoff(failed);\n          });\n          return [2\n          /*return*/\n          , queue];\n      }\n    });\n  });\n}\n\nvar LegacyDestination =\n/** @class */\nfunction () {\n  function LegacyDestination(name, version, settings, options) {\n    if (settings === void 0) {\n      settings = {};\n    }\n\n    this.options = {};\n    this.type = 'destination';\n    this.middleware = [];\n    this._ready = false;\n    this._initialized = false;\n    this.flushing = false;\n    this.name = name;\n    this.version = version;\n    this.settings = __assign({}, settings); // AJS-Renderer sets an extraneous `type` setting that clobbers\n    // existing type defaults. We need to remove it if it's present\n\n    if (this.settings['type'] && this.settings['type'] === 'browser') {\n      delete this.settings['type'];\n    }\n\n    this.options = options;\n    this.buffer = options.disableClientPersistence ? new PriorityQueue(4, []) : new PersistedPriorityQueue(4, \"dest-\".concat(name));\n    this.scheduleFlush();\n  }\n\n  LegacyDestination.prototype.isLoaded = function () {\n    return this._ready;\n  };\n\n  LegacyDestination.prototype.ready = function () {\n    var _a;\n\n    return (_a = this.onReady) !== null && _a !== void 0 ? _a : Promise.resolve();\n  };\n\n  LegacyDestination.prototype.load = function (ctx, analyticsInstance) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a;\n\n      var _this = this;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            if (this._ready || this.onReady !== undefined) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            _a = this;\n            return [4\n            /*yield*/\n            , loadIntegration(ctx, analyticsInstance, this.name, this.version, this.settings, this.options.obfuscate)];\n\n          case 1:\n            _a.integration = _b.sent();\n            this.onReady = new Promise(function (resolve) {\n              var onReadyFn = function () {\n                _this._ready = true;\n                resolve(true);\n              };\n\n              _this.integration.once('ready', onReadyFn);\n            });\n            this.onInitialize = new Promise(function (resolve) {\n              var onInit = function () {\n                _this._initialized = true;\n                resolve(true);\n              };\n\n              _this.integration.on('initialize', onInit);\n            });\n\n            try {\n              ctx.stats.increment('analytics_js.integration.invoke', 1, [\"method:initialize\", \"integration_name:\".concat(this.name)]);\n              this.integration.initialize();\n            } catch (error) {\n              ctx.stats.increment('analytics_js.integration.invoke.error', 1, [\"method:initialize\", \"integration_name:\".concat(this.name)]);\n              throw error;\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  LegacyDestination.prototype.unload = function (_ctx, _analyticsInstance) {\n    return unloadIntegration(this.name, this.version, this.options.obfuscate);\n  };\n\n  LegacyDestination.prototype.addMiddleware = function () {\n    var _a;\n\n    var fn = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      fn[_i] = arguments[_i];\n    }\n\n    this.middleware = (_a = this.middleware).concat.apply(_a, fn);\n  };\n\n  LegacyDestination.prototype.shouldBuffer = function (ctx) {\n    return (// page events can't be buffered because of destinations that automatically add page views\n      ctx.event.type !== 'page' && (isOffline() || this._ready === false || this._initialized === false)\n    );\n  };\n\n  LegacyDestination.prototype.send = function (ctx, clz, eventType) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var plan, ev, planEvent, afterMiddleware, event, err_1;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            if (this.shouldBuffer(ctx)) {\n              this.buffer.push(ctx);\n              this.scheduleFlush();\n              return [2\n              /*return*/\n              , ctx];\n            }\n\n            plan = (_b = (_a = this.options) === null || _a === void 0 ? void 0 : _a.plan) === null || _b === void 0 ? void 0 : _b.track;\n            ev = ctx.event.event;\n\n            if (plan && ev && this.name !== 'Segment.io') {\n              planEvent = plan[ev];\n\n              if (!isPlanEventEnabled(plan, planEvent)) {\n                ctx.updateEvent('integrations', __assign(__assign({}, ctx.event.integrations), {\n                  All: false,\n                  'Segment.io': true\n                }));\n                ctx.cancel(new ContextCancelation({\n                  retry: false,\n                  reason: \"Event \".concat(ev, \" disabled for integration \").concat(this.name, \" in tracking plan\"),\n                  type: 'Dropped by plan'\n                }));\n                return [2\n                /*return*/\n                , ctx];\n              } else {\n                ctx.updateEvent('integrations', __assign(__assign({}, ctx.event.integrations), planEvent === null || planEvent === void 0 ? void 0 : planEvent.integrations));\n              }\n\n              if ((planEvent === null || planEvent === void 0 ? void 0 : planEvent.enabled) && (planEvent === null || planEvent === void 0 ? void 0 : planEvent.integrations[this.name]) === false) {\n                ctx.cancel(new ContextCancelation({\n                  retry: false,\n                  reason: \"Event \".concat(ev, \" disabled for integration \").concat(this.name, \" in tracking plan\"),\n                  type: 'Dropped by plan'\n                }));\n                return [2\n                /*return*/\n                , ctx];\n              }\n            }\n\n            return [4\n            /*yield*/\n            , applyDestinationMiddleware(this.name, klona(ctx.event), this.middleware)];\n\n          case 1:\n            afterMiddleware = _c.sent();\n\n            if (afterMiddleware === null) {\n              return [2\n              /*return*/\n              , ctx];\n            }\n\n            event = new clz(afterMiddleware, {});\n            ctx.stats.increment('analytics_js.integration.invoke', 1, [\"method:\".concat(eventType), \"integration_name:\".concat(this.name)]);\n            _c.label = 2;\n\n          case 2:\n            _c.trys.push([2, 5,, 6]);\n\n            if (!this.integration) return [3\n            /*break*/\n            , 4];\n            return [4\n            /*yield*/\n            , asPromise(this.integration.invoke.call(this.integration, eventType, event))];\n\n          case 3:\n            _c.sent();\n\n            _c.label = 4;\n\n          case 4:\n            return [3\n            /*break*/\n            , 6];\n\n          case 5:\n            err_1 = _c.sent();\n            ctx.stats.increment('analytics_js.integration.invoke.error', 1, [\"method:\".concat(eventType), \"integration_name:\".concat(this.name)]);\n            throw err_1;\n\n          case 6:\n            return [2\n            /*return*/\n            , ctx];\n        }\n      });\n    });\n  };\n\n  LegacyDestination.prototype.track = function (ctx) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.send(ctx, Track, 'track')];\n      });\n    });\n  };\n\n  LegacyDestination.prototype.page = function (ctx) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_b) {\n        if (((_a = this.integration) === null || _a === void 0 ? void 0 : _a._assumesPageview) && !this._initialized) {\n          this.integration.initialize();\n        }\n\n        return [2\n        /*return*/\n        , this.onInitialize.then(function () {\n          return _this.send(ctx, Page, 'page');\n        })];\n      });\n    });\n  };\n\n  LegacyDestination.prototype.identify = function (ctx) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.send(ctx, Identify, 'identify')];\n      });\n    });\n  };\n\n  LegacyDestination.prototype.alias = function (ctx) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.send(ctx, Alias, 'alias')];\n      });\n    });\n  };\n\n  LegacyDestination.prototype.group = function (ctx) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.send(ctx, Group, 'group')];\n      });\n    });\n  };\n\n  LegacyDestination.prototype.scheduleFlush = function () {\n    var _this = this;\n\n    if (this.flushing) {\n      return;\n    } // eslint-disable-next-line @typescript-eslint/no-misused-promises\n\n\n    setTimeout(function () {\n      return __awaiter(_this, void 0, void 0, function () {\n        var _a;\n\n        return __generator(this, function (_b) {\n          switch (_b.label) {\n            case 0:\n              this.flushing = true;\n              _a = this;\n              return [4\n              /*yield*/\n              , flushQueue(this, this.buffer)];\n\n            case 1:\n              _a.buffer = _b.sent();\n              this.flushing = false;\n\n              if (this.buffer.todo > 0) {\n                this.scheduleFlush();\n              }\n\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    }, Math.random() * 5000);\n  };\n\n  return LegacyDestination;\n}();\n\nexport { LegacyDestination };\nexport function ajsDestinations(settings, globalIntegrations, options) {\n  var _a, _b;\n\n  if (globalIntegrations === void 0) {\n    globalIntegrations = {};\n  }\n\n  if (options === void 0) {\n    options = {};\n  }\n\n  if (isServer()) {\n    return [];\n  }\n\n  if (settings.plan) {\n    options = options !== null && options !== void 0 ? options : {};\n    options.plan = settings.plan;\n  }\n\n  var routingRules = (_b = (_a = settings.middlewareSettings) === null || _a === void 0 ? void 0 : _a.routingRules) !== null && _b !== void 0 ? _b : [];\n  var routingMiddleware = tsubMiddleware(routingRules); // merged remote CDN settings with user provided options\n\n  var integrationOptions = mergedOptions(settings, options !== null && options !== void 0 ? options : {});\n  return Object.entries(settings.integrations).map(function (_a) {\n    var _b;\n\n    var name = _a[0],\n        integrationSettings = _a[1];\n\n    if (name.startsWith('Segment')) {\n      return;\n    }\n\n    var allDisableAndNotDefined = globalIntegrations.All === false && globalIntegrations[name] === undefined;\n\n    if (globalIntegrations[name] === false || allDisableAndNotDefined) {\n      return;\n    }\n\n    var type = integrationSettings.type,\n        bundlingStatus = integrationSettings.bundlingStatus,\n        versionSettings = integrationSettings.versionSettings; // We use `!== 'unbundled'` (versus `=== 'bundled'`) to be inclusive of\n    // destinations without a defined value for `bundlingStatus`\n\n    var deviceMode = bundlingStatus !== 'unbundled' && (type === 'browser' || ((_b = versionSettings === null || versionSettings === void 0 ? void 0 : versionSettings.componentTypes) === null || _b === void 0 ? void 0 : _b.includes('browser'))); // checking for iterable is a quick fix we need in place to prevent\n    // errors showing Iterable as a failed destiantion. Ideally, we should\n    // fix the Iterable metadata instead, but that's a longer process.\n\n    if (!deviceMode && name !== 'Segment.io' || name === 'Iterable') {\n      return;\n    }\n\n    var version = resolveVersion(integrationSettings);\n    var destination = new LegacyDestination(name, version, integrationOptions[name], options);\n    var routing = routingRules.filter(function (rule) {\n      return rule.destinationName === name;\n    });\n\n    if (routing.length > 0) {\n      destination.addMiddleware(routingMiddleware);\n    }\n\n    return destination;\n  }).filter(function (xt) {\n    return xt !== undefined;\n  });\n}","map":{"version":3,"sources":["../../../../src/plugins/ajs-destination/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __awaiter, __generator } from \"tslib\";\nimport { Alias, Group, Identify, Page, Track } from '@segment/facade';\nimport { isOffline, isOnline } from '../../core/connection';\nimport { Context, ContextCancelation } from '../../core/context';\nimport { isServer } from '../../core/environment';\nimport { attempt } from '../../core/queue/delivery';\nimport { asPromise } from '../../lib/as-promise';\nimport { isPlanEventEnabled } from '../../lib/is-plan-event-enabled';\nimport { mergedOptions } from '../../lib/merged-options';\nimport { pWhile } from '../../lib/p-while';\nimport { PriorityQueue } from '../../lib/priority-queue';\nimport { PersistedPriorityQueue } from '../../lib/priority-queue/persisted';\nimport { applyDestinationMiddleware, } from '../middleware';\nimport { tsubMiddleware } from '../routing-middleware';\nimport { loadIntegration, resolveVersion, unloadIntegration } from './loader';\nvar klona = function (evt) {\n    return JSON.parse(JSON.stringify(evt));\n};\nfunction flushQueue(xt, queue) {\n    return __awaiter(this, void 0, void 0, function () {\n        var failedQueue;\n        var _this = this;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    failedQueue = [];\n                    if (isOffline()) {\n                        return [2 /*return*/, queue];\n                    }\n                    return [4 /*yield*/, pWhile(function () { return queue.length > 0 && isOnline(); }, function () { return __awaiter(_this, void 0, void 0, function () {\n                            var ctx, result, success;\n                            return __generator(this, function (_a) {\n                                switch (_a.label) {\n                                    case 0:\n                                        ctx = queue.pop();\n                                        if (!ctx) {\n                                            return [2 /*return*/];\n                                        }\n                                        return [4 /*yield*/, attempt(ctx, xt)];\n                                    case 1:\n                                        result = _a.sent();\n                                        success = result instanceof Context;\n                                        if (!success) {\n                                            failedQueue.push(ctx);\n                                        }\n                                        return [2 /*return*/];\n                                }\n                            });\n                        }); })\n                        // re-add failed tasks\n                    ];\n                case 1:\n                    _a.sent();\n                    // re-add failed tasks\n                    failedQueue.map(function (failed) { return queue.pushWithBackoff(failed); });\n                    return [2 /*return*/, queue];\n            }\n        });\n    });\n}\nvar LegacyDestination = /** @class */ (function () {\n    function LegacyDestination(name, version, settings, options) {\n        if (settings === void 0) { settings = {}; }\n        this.options = {};\n        this.type = 'destination';\n        this.middleware = [];\n        this._ready = false;\n        this._initialized = false;\n        this.flushing = false;\n        this.name = name;\n        this.version = version;\n        this.settings = __assign({}, settings);\n        // AJS-Renderer sets an extraneous `type` setting that clobbers\n        // existing type defaults. We need to remove it if it's present\n        if (this.settings['type'] && this.settings['type'] === 'browser') {\n            delete this.settings['type'];\n        }\n        this.options = options;\n        this.buffer = options.disableClientPersistence\n            ? new PriorityQueue(4, [])\n            : new PersistedPriorityQueue(4, \"dest-\".concat(name));\n        this.scheduleFlush();\n    }\n    LegacyDestination.prototype.isLoaded = function () {\n        return this._ready;\n    };\n    LegacyDestination.prototype.ready = function () {\n        var _a;\n        return (_a = this.onReady) !== null && _a !== void 0 ? _a : Promise.resolve();\n    };\n    LegacyDestination.prototype.load = function (ctx, analyticsInstance) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a;\n            var _this = this;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        if (this._ready || this.onReady !== undefined) {\n                            return [2 /*return*/];\n                        }\n                        _a = this;\n                        return [4 /*yield*/, loadIntegration(ctx, analyticsInstance, this.name, this.version, this.settings, this.options.obfuscate)];\n                    case 1:\n                        _a.integration = _b.sent();\n                        this.onReady = new Promise(function (resolve) {\n                            var onReadyFn = function () {\n                                _this._ready = true;\n                                resolve(true);\n                            };\n                            _this.integration.once('ready', onReadyFn);\n                        });\n                        this.onInitialize = new Promise(function (resolve) {\n                            var onInit = function () {\n                                _this._initialized = true;\n                                resolve(true);\n                            };\n                            _this.integration.on('initialize', onInit);\n                        });\n                        try {\n                            ctx.stats.increment('analytics_js.integration.invoke', 1, [\n                                \"method:initialize\",\n                                \"integration_name:\".concat(this.name),\n                            ]);\n                            this.integration.initialize();\n                        }\n                        catch (error) {\n                            ctx.stats.increment('analytics_js.integration.invoke.error', 1, [\n                                \"method:initialize\",\n                                \"integration_name:\".concat(this.name),\n                            ]);\n                            throw error;\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    LegacyDestination.prototype.unload = function (_ctx, _analyticsInstance) {\n        return unloadIntegration(this.name, this.version, this.options.obfuscate);\n    };\n    LegacyDestination.prototype.addMiddleware = function () {\n        var _a;\n        var fn = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            fn[_i] = arguments[_i];\n        }\n        this.middleware = (_a = this.middleware).concat.apply(_a, fn);\n    };\n    LegacyDestination.prototype.shouldBuffer = function (ctx) {\n        return (\n        // page events can't be buffered because of destinations that automatically add page views\n        ctx.event.type !== 'page' &&\n            (isOffline() || this._ready === false || this._initialized === false));\n    };\n    LegacyDestination.prototype.send = function (ctx, clz, eventType) {\n        var _a, _b;\n        return __awaiter(this, void 0, void 0, function () {\n            var plan, ev, planEvent, afterMiddleware, event, err_1;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        if (this.shouldBuffer(ctx)) {\n                            this.buffer.push(ctx);\n                            this.scheduleFlush();\n                            return [2 /*return*/, ctx];\n                        }\n                        plan = (_b = (_a = this.options) === null || _a === void 0 ? void 0 : _a.plan) === null || _b === void 0 ? void 0 : _b.track;\n                        ev = ctx.event.event;\n                        if (plan && ev && this.name !== 'Segment.io') {\n                            planEvent = plan[ev];\n                            if (!isPlanEventEnabled(plan, planEvent)) {\n                                ctx.updateEvent('integrations', __assign(__assign({}, ctx.event.integrations), { All: false, 'Segment.io': true }));\n                                ctx.cancel(new ContextCancelation({\n                                    retry: false,\n                                    reason: \"Event \".concat(ev, \" disabled for integration \").concat(this.name, \" in tracking plan\"),\n                                    type: 'Dropped by plan',\n                                }));\n                                return [2 /*return*/, ctx];\n                            }\n                            else {\n                                ctx.updateEvent('integrations', __assign(__assign({}, ctx.event.integrations), planEvent === null || planEvent === void 0 ? void 0 : planEvent.integrations));\n                            }\n                            if ((planEvent === null || planEvent === void 0 ? void 0 : planEvent.enabled) && (planEvent === null || planEvent === void 0 ? void 0 : planEvent.integrations[this.name]) === false) {\n                                ctx.cancel(new ContextCancelation({\n                                    retry: false,\n                                    reason: \"Event \".concat(ev, \" disabled for integration \").concat(this.name, \" in tracking plan\"),\n                                    type: 'Dropped by plan',\n                                }));\n                                return [2 /*return*/, ctx];\n                            }\n                        }\n                        return [4 /*yield*/, applyDestinationMiddleware(this.name, klona(ctx.event), this.middleware)];\n                    case 1:\n                        afterMiddleware = _c.sent();\n                        if (afterMiddleware === null) {\n                            return [2 /*return*/, ctx];\n                        }\n                        event = new clz(afterMiddleware, {});\n                        ctx.stats.increment('analytics_js.integration.invoke', 1, [\n                            \"method:\".concat(eventType),\n                            \"integration_name:\".concat(this.name),\n                        ]);\n                        _c.label = 2;\n                    case 2:\n                        _c.trys.push([2, 5, , 6]);\n                        if (!this.integration) return [3 /*break*/, 4];\n                        return [4 /*yield*/, asPromise(this.integration.invoke.call(this.integration, eventType, event))];\n                    case 3:\n                        _c.sent();\n                        _c.label = 4;\n                    case 4: return [3 /*break*/, 6];\n                    case 5:\n                        err_1 = _c.sent();\n                        ctx.stats.increment('analytics_js.integration.invoke.error', 1, [\n                            \"method:\".concat(eventType),\n                            \"integration_name:\".concat(this.name),\n                        ]);\n                        throw err_1;\n                    case 6: return [2 /*return*/, ctx];\n                }\n            });\n        });\n    };\n    LegacyDestination.prototype.track = function (ctx) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.send(ctx, Track, 'track')];\n            });\n        });\n    };\n    LegacyDestination.prototype.page = function (ctx) {\n        var _a;\n        return __awaiter(this, void 0, void 0, function () {\n            var _this = this;\n            return __generator(this, function (_b) {\n                if (((_a = this.integration) === null || _a === void 0 ? void 0 : _a._assumesPageview) && !this._initialized) {\n                    this.integration.initialize();\n                }\n                return [2 /*return*/, this.onInitialize.then(function () {\n                        return _this.send(ctx, Page, 'page');\n                    })];\n            });\n        });\n    };\n    LegacyDestination.prototype.identify = function (ctx) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.send(ctx, Identify, 'identify')];\n            });\n        });\n    };\n    LegacyDestination.prototype.alias = function (ctx) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.send(ctx, Alias, 'alias')];\n            });\n        });\n    };\n    LegacyDestination.prototype.group = function (ctx) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.send(ctx, Group, 'group')];\n            });\n        });\n    };\n    LegacyDestination.prototype.scheduleFlush = function () {\n        var _this = this;\n        if (this.flushing) {\n            return;\n        }\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {\n            var _a;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        this.flushing = true;\n                        _a = this;\n                        return [4 /*yield*/, flushQueue(this, this.buffer)];\n                    case 1:\n                        _a.buffer = _b.sent();\n                        this.flushing = false;\n                        if (this.buffer.todo > 0) {\n                            this.scheduleFlush();\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        }); }, Math.random() * 5000);\n    };\n    return LegacyDestination;\n}());\nexport { LegacyDestination };\nexport function ajsDestinations(settings, globalIntegrations, options) {\n    var _a, _b;\n    if (globalIntegrations === void 0) { globalIntegrations = {}; }\n    if (options === void 0) { options = {}; }\n    if (isServer()) {\n        return [];\n    }\n    if (settings.plan) {\n        options = options !== null && options !== void 0 ? options : {};\n        options.plan = settings.plan;\n    }\n    var routingRules = (_b = (_a = settings.middlewareSettings) === null || _a === void 0 ? void 0 : _a.routingRules) !== null && _b !== void 0 ? _b : [];\n    var routingMiddleware = tsubMiddleware(routingRules);\n    // merged remote CDN settings with user provided options\n    var integrationOptions = mergedOptions(settings, options !== null && options !== void 0 ? options : {});\n    return Object.entries(settings.integrations)\n        .map(function (_a) {\n        var _b;\n        var name = _a[0], integrationSettings = _a[1];\n        if (name.startsWith('Segment')) {\n            return;\n        }\n        var allDisableAndNotDefined = globalIntegrations.All === false &&\n            globalIntegrations[name] === undefined;\n        if (globalIntegrations[name] === false || allDisableAndNotDefined) {\n            return;\n        }\n        var type = integrationSettings.type, bundlingStatus = integrationSettings.bundlingStatus, versionSettings = integrationSettings.versionSettings;\n        // We use `!== 'unbundled'` (versus `=== 'bundled'`) to be inclusive of\n        // destinations without a defined value for `bundlingStatus`\n        var deviceMode = bundlingStatus !== 'unbundled' &&\n            (type === 'browser' ||\n                ((_b = versionSettings === null || versionSettings === void 0 ? void 0 : versionSettings.componentTypes) === null || _b === void 0 ? void 0 : _b.includes('browser')));\n        // checking for iterable is a quick fix we need in place to prevent\n        // errors showing Iterable as a failed destiantion. Ideally, we should\n        // fix the Iterable metadata instead, but that's a longer process.\n        if ((!deviceMode && name !== 'Segment.io') || name === 'Iterable') {\n            return;\n        }\n        var version = resolveVersion(integrationSettings);\n        var destination = new LegacyDestination(name, version, integrationOptions[name], options);\n        var routing = routingRules.filter(function (rule) { return rule.destinationName === name; });\n        if (routing.length > 0) {\n            destination.addMiddleware(routingMiddleware);\n        }\n        return destination;\n    })\n        .filter(function (xt) { return xt !== undefined; });\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}