{"ast":null,"code":"import { __assign, __awaiter, __extends, __generator, __spreadArray } from \"tslib\";\nimport { getProcessEnv } from '../lib/get-process-env';\nimport { getCDN, setGlobalCDNUrl } from '../lib/parse-cdn';\nimport fetch from 'unfetch';\nimport { Analytics } from '../core/analytics';\nimport { Context } from '../core/context';\nimport { mergedOptions } from '../lib/merged-options';\nimport { pageEnrichment } from '../plugins/page-enrichment';\nimport { remoteLoader } from '../plugins/remote-loader';\nimport { segmentio } from '../plugins/segmentio';\nimport { validation } from '../plugins/validation';\nimport { AnalyticsBuffered, flushAnalyticsCallsInNewTask, flushAddSourceMiddleware, flushSetAnonymousID, flushOn } from '../core/buffer';\nimport { popSnippetWindowBuffer } from '../core/buffer/snippet';\nexport function loadLegacySettings(writeKey, cdnURL) {\n  var baseUrl = cdnURL !== null && cdnURL !== void 0 ? cdnURL : getCDN();\n  return fetch(\"\".concat(baseUrl, \"/v1/projects/\").concat(writeKey, \"/settings\")).then(function (res) {\n    if (!res.ok) {\n      return res.text().then(function (errorResponseMessage) {\n        throw new Error(errorResponseMessage);\n      });\n    }\n\n    return res.json();\n  }).catch(function (err) {\n    console.error(err.message);\n    throw err;\n  });\n}\n\nfunction hasLegacyDestinations(settings) {\n  return getProcessEnv().NODE_ENV !== 'test' && // just one integration means segmentio\n  Object.keys(settings.integrations).length > 1;\n}\n/**\n * With AJS classic, we allow users to call setAnonymousId before the library initialization.\n * This is important because some of the destinations will use the anonymousId during the initialization,\n * and if we set anonId afterwards, that wouldn’t impact the destination.\n *\n * Also Ensures events can be registered before library initialization.\n * This is important so users can register to 'initialize' and any events that may fire early during setup.\n */\n\n\nfunction flushPreBuffer(analytics, buffer) {\n  buffer.push.apply(buffer, popSnippetWindowBuffer());\n  flushSetAnonymousID(analytics, buffer);\n  flushOn(analytics, buffer);\n}\n/**\n * Finish flushing buffer and cleanup.\n */\n\n\nfunction flushFinalBuffer(analytics, buffer) {\n  return __awaiter(this, void 0, void 0, function () {\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          // Call popSnippetWindowBuffer before each flush task since there may be\n          // analytics calls during async function calls.\n          buffer.push.apply(buffer, popSnippetWindowBuffer());\n          return [4\n          /*yield*/\n          , flushAddSourceMiddleware(analytics, buffer)];\n\n        case 1:\n          _a.sent();\n\n          buffer.push.apply(buffer, popSnippetWindowBuffer());\n          flushAnalyticsCallsInNewTask(analytics, buffer); // Clear buffer, just in case analytics is loaded twice; we don't want to fire events off again.\n\n          buffer.clear();\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n}\n\nfunction registerPlugins(legacySettings, analytics, opts, options, plugins) {\n  var _a, _b, _c;\n\n  return __awaiter(this, void 0, void 0, function () {\n    var legacyDestinations, _d, schemaFilter, _e, mergedSettings, remotePlugins, toRegister, shouldIgnoreSegmentio, ctx;\n\n    var _this = this;\n\n    return __generator(this, function (_f) {\n      switch (_f.label) {\n        case 0:\n          if (!hasLegacyDestinations(legacySettings)) return [3\n          /*break*/\n          , 2];\n          return [4\n          /*yield*/\n          , import(\n          /* webpackChunkName: \"ajs-destination\" */\n          '../plugins/ajs-destination').then(function (mod) {\n            return mod.ajsDestinations(legacySettings, analytics.integrations, opts);\n          })];\n\n        case 1:\n          _d = _f.sent();\n          return [3\n          /*break*/\n          , 3];\n\n        case 2:\n          _d = [];\n          _f.label = 3;\n\n        case 3:\n          legacyDestinations = _d;\n          if (!legacySettings.legacyVideoPluginsEnabled) return [3\n          /*break*/\n          , 5];\n          return [4\n          /*yield*/\n          , import(\n          /* webpackChunkName: \"legacyVideos\" */\n          '../plugins/legacy-video-plugins').then(function (mod) {\n            return mod.loadLegacyVideoPlugins(analytics);\n          })];\n\n        case 4:\n          _f.sent();\n\n          _f.label = 5;\n\n        case 5:\n          if (!((_a = opts.plan) === null || _a === void 0 ? void 0 : _a.track)) return [3\n          /*break*/\n          , 7];\n          return [4\n          /*yield*/\n          , import(\n          /* webpackChunkName: \"schemaFilter\" */\n          '../plugins/schema-filter').then(function (mod) {\n            var _a;\n\n            return mod.schemaFilter((_a = opts.plan) === null || _a === void 0 ? void 0 : _a.track, legacySettings);\n          })];\n\n        case 6:\n          _e = _f.sent();\n          return [3\n          /*break*/\n          , 8];\n\n        case 7:\n          _e = undefined;\n          _f.label = 8;\n\n        case 8:\n          schemaFilter = _e;\n          mergedSettings = mergedOptions(legacySettings, options);\n          return [4\n          /*yield*/\n          , remoteLoader(legacySettings, analytics.integrations, mergedSettings, options.obfuscate).catch(function () {\n            return [];\n          })];\n\n        case 9:\n          remotePlugins = _f.sent();\n          toRegister = __spreadArray(__spreadArray(__spreadArray([validation, pageEnrichment], plugins, true), legacyDestinations, true), remotePlugins, true);\n\n          if (schemaFilter) {\n            toRegister.push(schemaFilter);\n          }\n\n          shouldIgnoreSegmentio = ((_b = opts.integrations) === null || _b === void 0 ? void 0 : _b.All) === false && !opts.integrations['Segment.io'] || opts.integrations && opts.integrations['Segment.io'] === false;\n\n          if (!shouldIgnoreSegmentio) {\n            toRegister.push(segmentio(analytics, mergedSettings['Segment.io'], legacySettings.integrations));\n          }\n\n          return [4\n          /*yield*/\n          , analytics.register.apply(analytics, toRegister)];\n\n        case 10:\n          ctx = _f.sent();\n          if (!Object.entries((_c = legacySettings.enabledMiddleware) !== null && _c !== void 0 ? _c : {}).some(function (_a) {\n            var enabled = _a[1];\n            return enabled;\n          })) return [3\n          /*break*/\n          , 12];\n          return [4\n          /*yield*/\n          , import(\n          /* webpackChunkName: \"remoteMiddleware\" */\n          '../plugins/remote-middleware').then(function (_a) {\n            var remoteMiddlewares = _a.remoteMiddlewares;\n            return __awaiter(_this, void 0, void 0, function () {\n              var middleware, promises;\n              return __generator(this, function (_b) {\n                switch (_b.label) {\n                  case 0:\n                    return [4\n                    /*yield*/\n                    , remoteMiddlewares(ctx, legacySettings, options.obfuscate)];\n\n                  case 1:\n                    middleware = _b.sent();\n                    promises = middleware.map(function (mdw) {\n                      return analytics.addSourceMiddleware(mdw);\n                    });\n                    return [2\n                    /*return*/\n                    , Promise.all(promises)];\n                }\n              });\n            });\n          })];\n\n        case 11:\n          _f.sent();\n\n          _f.label = 12;\n\n        case 12:\n          return [2\n          /*return*/\n          , ctx];\n      }\n    });\n  });\n}\n\nfunction loadAnalytics(settings, options, preInitBuffer) {\n  var _a, _b, _c, _d, _e, _f;\n\n  if (options === void 0) {\n    options = {};\n  }\n\n  return __awaiter(this, void 0, void 0, function () {\n    var legacySettings, _g, retryQueue, opts, analytics, plugins, ctx, search, hash, term;\n\n    return __generator(this, function (_h) {\n      switch (_h.label) {\n        case 0:\n          // this is an ugly side-effect, but it's for the benefits of the plugins that get their cdn via getCDN()\n          if (settings.cdnURL) setGlobalCDNUrl(settings.cdnURL);\n          if (!((_a = settings.cdnSettings) !== null && _a !== void 0)) return [3\n          /*break*/\n          , 1];\n          _g = _a;\n          return [3\n          /*break*/\n          , 3];\n\n        case 1:\n          return [4\n          /*yield*/\n          , loadLegacySettings(settings.writeKey, settings.cdnURL)];\n\n        case 2:\n          _g = _h.sent();\n          _h.label = 3;\n\n        case 3:\n          legacySettings = _g;\n          retryQueue = (_c = (_b = legacySettings.integrations['Segment.io']) === null || _b === void 0 ? void 0 : _b.retryQueue) !== null && _c !== void 0 ? _c : true;\n          opts = __assign({\n            retryQueue: retryQueue\n          }, options);\n          analytics = new Analytics(settings, opts);\n          plugins = (_d = settings.plugins) !== null && _d !== void 0 ? _d : [];\n          Context.initMetrics(legacySettings.metrics); // needs to be flushed before plugins are registered\n\n          flushPreBuffer(analytics, preInitBuffer);\n          return [4\n          /*yield*/\n          , registerPlugins(legacySettings, analytics, opts, options, plugins)];\n\n        case 4:\n          ctx = _h.sent();\n          search = (_e = window.location.search) !== null && _e !== void 0 ? _e : '';\n          hash = (_f = window.location.hash) !== null && _f !== void 0 ? _f : '';\n          term = search.length ? search : hash.replace(/(?=#).*(?=\\?)/, '');\n          if (!term.includes('ajs_')) return [3\n          /*break*/\n          , 6];\n          return [4\n          /*yield*/\n          , analytics.queryString(term).catch(console.error)];\n\n        case 5:\n          _h.sent();\n\n          _h.label = 6;\n\n        case 6:\n          analytics.initialized = true;\n          analytics.emit('initialize', settings, options);\n\n          if (options.initialPageview) {\n            analytics.page().catch(console.error);\n          }\n\n          return [4\n          /*yield*/\n          , flushFinalBuffer(analytics, preInitBuffer)];\n\n        case 7:\n          _h.sent();\n\n          return [2\n          /*return*/\n          , [analytics, ctx]];\n      }\n    });\n  });\n}\n/**\n * The public browser interface for this package.\n * Use AnalyticsBrowser.load to create an instance.\n */\n\n\nvar AnalyticsBrowser =\n/** @class */\nfunction (_super) {\n  __extends(AnalyticsBrowser, _super);\n\n  function AnalyticsBrowser(loader) {\n    return _super.call(this, loader) || this;\n  }\n  /**\n   * Instantiates an object exposing Analytics methods.\n   *\n   * ```ts\n   * const ajs = AnalyticsBrowser.load({ writeKey: '<YOUR_WRITE_KEY>' })\n   *\n   * ajs.track(\"foo\")\n   * ...\n   * ```\n   */\n\n\n  AnalyticsBrowser.load = function (settings, options) {\n    if (options === void 0) {\n      options = {};\n    }\n\n    return new this(function (preInitBuffer) {\n      return loadAnalytics(settings, options, preInitBuffer);\n    });\n  };\n\n  AnalyticsBrowser.standalone = function (writeKey, options) {\n    return AnalyticsBrowser.load({\n      writeKey: writeKey\n    }, options).then(function (res) {\n      return res[0];\n    });\n  };\n\n  return AnalyticsBrowser;\n}(AnalyticsBuffered);\n\nexport { AnalyticsBrowser };","map":{"version":3,"sources":["../../../src/browser/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __awaiter, __extends, __generator, __spreadArray } from \"tslib\";\nimport { getProcessEnv } from '../lib/get-process-env';\nimport { getCDN, setGlobalCDNUrl } from '../lib/parse-cdn';\nimport fetch from 'unfetch';\nimport { Analytics } from '../core/analytics';\nimport { Context } from '../core/context';\nimport { mergedOptions } from '../lib/merged-options';\nimport { pageEnrichment } from '../plugins/page-enrichment';\nimport { remoteLoader } from '../plugins/remote-loader';\nimport { segmentio } from '../plugins/segmentio';\nimport { validation } from '../plugins/validation';\nimport { AnalyticsBuffered, flushAnalyticsCallsInNewTask, flushAddSourceMiddleware, flushSetAnonymousID, flushOn, } from '../core/buffer';\nimport { popSnippetWindowBuffer } from '../core/buffer/snippet';\nexport function loadLegacySettings(writeKey, cdnURL) {\n    var baseUrl = cdnURL !== null && cdnURL !== void 0 ? cdnURL : getCDN();\n    return fetch(\"\".concat(baseUrl, \"/v1/projects/\").concat(writeKey, \"/settings\"))\n        .then(function (res) {\n        if (!res.ok) {\n            return res.text().then(function (errorResponseMessage) {\n                throw new Error(errorResponseMessage);\n            });\n        }\n        return res.json();\n    })\n        .catch(function (err) {\n        console.error(err.message);\n        throw err;\n    });\n}\nfunction hasLegacyDestinations(settings) {\n    return (getProcessEnv().NODE_ENV !== 'test' &&\n        // just one integration means segmentio\n        Object.keys(settings.integrations).length > 1);\n}\n/**\n * With AJS classic, we allow users to call setAnonymousId before the library initialization.\n * This is important because some of the destinations will use the anonymousId during the initialization,\n * and if we set anonId afterwards, that wouldn’t impact the destination.\n *\n * Also Ensures events can be registered before library initialization.\n * This is important so users can register to 'initialize' and any events that may fire early during setup.\n */\nfunction flushPreBuffer(analytics, buffer) {\n    buffer.push.apply(buffer, popSnippetWindowBuffer());\n    flushSetAnonymousID(analytics, buffer);\n    flushOn(analytics, buffer);\n}\n/**\n * Finish flushing buffer and cleanup.\n */\nfunction flushFinalBuffer(analytics, buffer) {\n    return __awaiter(this, void 0, void 0, function () {\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    // Call popSnippetWindowBuffer before each flush task since there may be\n                    // analytics calls during async function calls.\n                    buffer.push.apply(buffer, popSnippetWindowBuffer());\n                    return [4 /*yield*/, flushAddSourceMiddleware(analytics, buffer)];\n                case 1:\n                    _a.sent();\n                    buffer.push.apply(buffer, popSnippetWindowBuffer());\n                    flushAnalyticsCallsInNewTask(analytics, buffer);\n                    // Clear buffer, just in case analytics is loaded twice; we don't want to fire events off again.\n                    buffer.clear();\n                    return [2 /*return*/];\n            }\n        });\n    });\n}\nfunction registerPlugins(legacySettings, analytics, opts, options, plugins) {\n    var _a, _b, _c;\n    return __awaiter(this, void 0, void 0, function () {\n        var legacyDestinations, _d, schemaFilter, _e, mergedSettings, remotePlugins, toRegister, shouldIgnoreSegmentio, ctx;\n        var _this = this;\n        return __generator(this, function (_f) {\n            switch (_f.label) {\n                case 0:\n                    if (!hasLegacyDestinations(legacySettings)) return [3 /*break*/, 2];\n                    return [4 /*yield*/, import(\n                        /* webpackChunkName: \"ajs-destination\" */ '../plugins/ajs-destination').then(function (mod) {\n                            return mod.ajsDestinations(legacySettings, analytics.integrations, opts);\n                        })];\n                case 1:\n                    _d = _f.sent();\n                    return [3 /*break*/, 3];\n                case 2:\n                    _d = [];\n                    _f.label = 3;\n                case 3:\n                    legacyDestinations = _d;\n                    if (!legacySettings.legacyVideoPluginsEnabled) return [3 /*break*/, 5];\n                    return [4 /*yield*/, import(\n                        /* webpackChunkName: \"legacyVideos\" */ '../plugins/legacy-video-plugins').then(function (mod) {\n                            return mod.loadLegacyVideoPlugins(analytics);\n                        })];\n                case 4:\n                    _f.sent();\n                    _f.label = 5;\n                case 5:\n                    if (!((_a = opts.plan) === null || _a === void 0 ? void 0 : _a.track)) return [3 /*break*/, 7];\n                    return [4 /*yield*/, import(\n                        /* webpackChunkName: \"schemaFilter\" */ '../plugins/schema-filter').then(function (mod) {\n                            var _a;\n                            return mod.schemaFilter((_a = opts.plan) === null || _a === void 0 ? void 0 : _a.track, legacySettings);\n                        })];\n                case 6:\n                    _e = _f.sent();\n                    return [3 /*break*/, 8];\n                case 7:\n                    _e = undefined;\n                    _f.label = 8;\n                case 8:\n                    schemaFilter = _e;\n                    mergedSettings = mergedOptions(legacySettings, options);\n                    return [4 /*yield*/, remoteLoader(legacySettings, analytics.integrations, mergedSettings, options.obfuscate).catch(function () { return []; })];\n                case 9:\n                    remotePlugins = _f.sent();\n                    toRegister = __spreadArray(__spreadArray(__spreadArray([\n                        validation,\n                        pageEnrichment\n                    ], plugins, true), legacyDestinations, true), remotePlugins, true);\n                    if (schemaFilter) {\n                        toRegister.push(schemaFilter);\n                    }\n                    shouldIgnoreSegmentio = (((_b = opts.integrations) === null || _b === void 0 ? void 0 : _b.All) === false && !opts.integrations['Segment.io']) ||\n                        (opts.integrations && opts.integrations['Segment.io'] === false);\n                    if (!shouldIgnoreSegmentio) {\n                        toRegister.push(segmentio(analytics, mergedSettings['Segment.io'], legacySettings.integrations));\n                    }\n                    return [4 /*yield*/, analytics.register.apply(analytics, toRegister)];\n                case 10:\n                    ctx = _f.sent();\n                    if (!Object.entries((_c = legacySettings.enabledMiddleware) !== null && _c !== void 0 ? _c : {}).some(function (_a) {\n                        var enabled = _a[1];\n                        return enabled;\n                    })) return [3 /*break*/, 12];\n                    return [4 /*yield*/, import(\n                        /* webpackChunkName: \"remoteMiddleware\" */ '../plugins/remote-middleware').then(function (_a) {\n                            var remoteMiddlewares = _a.remoteMiddlewares;\n                            return __awaiter(_this, void 0, void 0, function () {\n                                var middleware, promises;\n                                return __generator(this, function (_b) {\n                                    switch (_b.label) {\n                                        case 0: return [4 /*yield*/, remoteMiddlewares(ctx, legacySettings, options.obfuscate)];\n                                        case 1:\n                                            middleware = _b.sent();\n                                            promises = middleware.map(function (mdw) {\n                                                return analytics.addSourceMiddleware(mdw);\n                                            });\n                                            return [2 /*return*/, Promise.all(promises)];\n                                    }\n                                });\n                            });\n                        })];\n                case 11:\n                    _f.sent();\n                    _f.label = 12;\n                case 12: return [2 /*return*/, ctx];\n            }\n        });\n    });\n}\nfunction loadAnalytics(settings, options, preInitBuffer) {\n    var _a, _b, _c, _d, _e, _f;\n    if (options === void 0) { options = {}; }\n    return __awaiter(this, void 0, void 0, function () {\n        var legacySettings, _g, retryQueue, opts, analytics, plugins, ctx, search, hash, term;\n        return __generator(this, function (_h) {\n            switch (_h.label) {\n                case 0:\n                    // this is an ugly side-effect, but it's for the benefits of the plugins that get their cdn via getCDN()\n                    if (settings.cdnURL)\n                        setGlobalCDNUrl(settings.cdnURL);\n                    if (!((_a = settings.cdnSettings) !== null && _a !== void 0)) return [3 /*break*/, 1];\n                    _g = _a;\n                    return [3 /*break*/, 3];\n                case 1: return [4 /*yield*/, loadLegacySettings(settings.writeKey, settings.cdnURL)];\n                case 2:\n                    _g = (_h.sent());\n                    _h.label = 3;\n                case 3:\n                    legacySettings = _g;\n                    retryQueue = (_c = (_b = legacySettings.integrations['Segment.io']) === null || _b === void 0 ? void 0 : _b.retryQueue) !== null && _c !== void 0 ? _c : true;\n                    opts = __assign({ retryQueue: retryQueue }, options);\n                    analytics = new Analytics(settings, opts);\n                    plugins = (_d = settings.plugins) !== null && _d !== void 0 ? _d : [];\n                    Context.initMetrics(legacySettings.metrics);\n                    // needs to be flushed before plugins are registered\n                    flushPreBuffer(analytics, preInitBuffer);\n                    return [4 /*yield*/, registerPlugins(legacySettings, analytics, opts, options, plugins)];\n                case 4:\n                    ctx = _h.sent();\n                    search = (_e = window.location.search) !== null && _e !== void 0 ? _e : '';\n                    hash = (_f = window.location.hash) !== null && _f !== void 0 ? _f : '';\n                    term = search.length ? search : hash.replace(/(?=#).*(?=\\?)/, '');\n                    if (!term.includes('ajs_')) return [3 /*break*/, 6];\n                    return [4 /*yield*/, analytics.queryString(term).catch(console.error)];\n                case 5:\n                    _h.sent();\n                    _h.label = 6;\n                case 6:\n                    analytics.initialized = true;\n                    analytics.emit('initialize', settings, options);\n                    if (options.initialPageview) {\n                        analytics.page().catch(console.error);\n                    }\n                    return [4 /*yield*/, flushFinalBuffer(analytics, preInitBuffer)];\n                case 7:\n                    _h.sent();\n                    return [2 /*return*/, [analytics, ctx]];\n            }\n        });\n    });\n}\n/**\n * The public browser interface for this package.\n * Use AnalyticsBrowser.load to create an instance.\n */\nvar AnalyticsBrowser = /** @class */ (function (_super) {\n    __extends(AnalyticsBrowser, _super);\n    function AnalyticsBrowser(loader) {\n        return _super.call(this, loader) || this;\n    }\n    /**\n     * Instantiates an object exposing Analytics methods.\n     *\n     * ```ts\n     * const ajs = AnalyticsBrowser.load({ writeKey: '<YOUR_WRITE_KEY>' })\n     *\n     * ajs.track(\"foo\")\n     * ...\n     * ```\n     */\n    AnalyticsBrowser.load = function (settings, options) {\n        if (options === void 0) { options = {}; }\n        return new this(function (preInitBuffer) {\n            return loadAnalytics(settings, options, preInitBuffer);\n        });\n    };\n    AnalyticsBrowser.standalone = function (writeKey, options) {\n        return AnalyticsBrowser.load({ writeKey: writeKey }, options).then(function (res) { return res[0]; });\n    };\n    return AnalyticsBrowser;\n}(AnalyticsBuffered));\nexport { AnalyticsBrowser };\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}