{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { v4 as uuid } from '@lukeed/uuid';\nimport jar from 'js-cookie';\nimport { tld } from './tld';\nimport autoBind from '../../lib/bind-all';\nvar defaults = {\n  persist: true,\n  cookie: {\n    key: 'ajs_user_id',\n    oldKey: 'ajs_user'\n  },\n  localStorage: {\n    key: 'ajs_user_traits'\n  }\n};\n\nvar Store =\n/** @class */\nfunction () {\n  function Store() {\n    this.cache = {};\n  }\n\n  Store.prototype.get = function (key) {\n    return this.cache[key];\n  };\n\n  Store.prototype.set = function (key, value) {\n    this.cache[key] = value;\n    return value;\n  };\n\n  Store.prototype.remove = function (key) {\n    delete this.cache[key];\n  };\n\n  return Store;\n}();\n\nvar ONE_YEAR = 365;\n\nvar Cookie =\n/** @class */\nfunction (_super) {\n  __extends(Cookie, _super);\n\n  function Cookie(options) {\n    if (options === void 0) {\n      options = Cookie.defaults;\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.options = __assign(__assign({}, Cookie.defaults), options);\n    return _this;\n  }\n\n  Cookie.available = function () {\n    var cookieEnabled = window.navigator.cookieEnabled;\n\n    if (!cookieEnabled) {\n      jar.set('ajs:cookies', 'test');\n      cookieEnabled = document.cookie.includes('ajs:cookies');\n      jar.remove('ajs:cookies');\n    }\n\n    return cookieEnabled;\n  };\n\n  Object.defineProperty(Cookie, \"defaults\", {\n    get: function () {\n      return {\n        maxage: ONE_YEAR,\n        domain: tld(window.location.href),\n        path: '/',\n        sameSite: 'Lax'\n      };\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Cookie.prototype.opts = function () {\n    return {\n      sameSite: this.options.sameSite,\n      expires: this.options.maxage,\n      domain: this.options.domain,\n      path: this.options.path,\n      secure: this.options.secure\n    };\n  };\n\n  Cookie.prototype.get = function (key) {\n    try {\n      var value = jar.get(key);\n\n      if (!value) {\n        return null;\n      }\n\n      try {\n        return JSON.parse(value);\n      } catch (e) {\n        return value;\n      }\n    } catch (e) {\n      return null;\n    }\n  };\n\n  Cookie.prototype.set = function (key, value) {\n    if (typeof value === 'string') {\n      jar.set(key, value, this.opts());\n    } else if (value === null) {\n      jar.remove(key, this.opts());\n    } else {\n      jar.set(key, JSON.stringify(value), this.opts());\n    }\n\n    return value;\n  };\n\n  Cookie.prototype.remove = function (key) {\n    return jar.remove(key, this.opts());\n  };\n\n  return Cookie;\n}(Store);\n\nexport { Cookie };\n\nvar NullStorage =\n/** @class */\nfunction (_super) {\n  __extends(NullStorage, _super);\n\n  function NullStorage() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.get = function (_key) {\n      return null;\n    };\n\n    _this.set = function (_key, _val) {\n      return null;\n    };\n\n    _this.remove = function (_key) {};\n\n    return _this;\n  }\n\n  return NullStorage;\n}(Store);\n\nvar LocalStorage =\n/** @class */\nfunction (_super) {\n  __extends(LocalStorage, _super);\n\n  function LocalStorage() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  LocalStorage.available = function () {\n    var test = 'test';\n\n    try {\n      localStorage.setItem(test, test);\n      localStorage.removeItem(test);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  };\n\n  LocalStorage.prototype.get = function (key) {\n    var val = localStorage.getItem(key);\n\n    if (val) {\n      try {\n        return JSON.parse(val);\n      } catch (e) {\n        return JSON.parse(JSON.stringify(val));\n      }\n    }\n\n    return null;\n  };\n\n  LocalStorage.prototype.set = function (key, value) {\n    try {\n      localStorage.setItem(key, JSON.stringify(value));\n    } catch (_a) {\n      console.warn(\"Unable to set \".concat(key, \" in localStorage, storage may be full.\"));\n    }\n\n    return value;\n  };\n\n  LocalStorage.prototype.remove = function (key) {\n    return localStorage.removeItem(key);\n  };\n\n  return LocalStorage;\n}(Store);\n\nexport { LocalStorage };\n\nvar User =\n/** @class */\nfunction () {\n  function User(options, cookieOptions) {\n    if (options === void 0) {\n      options = defaults;\n    }\n\n    var _this = this;\n\n    var _a, _b, _c, _d;\n\n    this.options = {};\n\n    this.id = function (id) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return null;\n      }\n\n      var prevId = _this.chainGet(_this.idKey);\n\n      if (id !== undefined) {\n        _this.trySet(_this.idKey, id);\n\n        var changingIdentity = id !== prevId && prevId !== null && id !== null;\n\n        if (changingIdentity) {\n          _this.anonymousId(null);\n        }\n      }\n\n      return (_b = (_a = _this.chainGet(_this.idKey)) !== null && _a !== void 0 ? _a : _this.cookies.get(defaults.cookie.oldKey)) !== null && _b !== void 0 ? _b : null;\n    };\n\n    this.anonymousId = function (id) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return null;\n      }\n\n      if (id === undefined) {\n        var val = (_a = _this.chainGet(_this.anonKey)) !== null && _a !== void 0 ? _a : (_b = _this.legacySIO()) === null || _b === void 0 ? void 0 : _b[0];\n\n        if (val) {\n          return val;\n        }\n      }\n\n      if (id === null) {\n        _this.trySet(_this.anonKey, null);\n\n        return _this.chainGet(_this.anonKey);\n      }\n\n      _this.trySet(_this.anonKey, id !== null && id !== void 0 ? id : uuid());\n\n      return _this.chainGet(_this.anonKey);\n    };\n\n    this.traits = function (traits) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return;\n      }\n\n      if (traits === null) {\n        traits = {};\n      }\n\n      if (traits) {\n        _this.mem.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n\n        _this.localStorage.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n      }\n\n      return (_b = (_a = _this.localStorage.get(_this.traitsKey)) !== null && _a !== void 0 ? _a : _this.mem.get(_this.traitsKey)) !== null && _b !== void 0 ? _b : {};\n    };\n\n    this.options = options;\n    this.cookieOptions = cookieOptions;\n    this.idKey = (_b = (_a = options.cookie) === null || _a === void 0 ? void 0 : _a.key) !== null && _b !== void 0 ? _b : defaults.cookie.key;\n    this.traitsKey = (_d = (_c = options.localStorage) === null || _c === void 0 ? void 0 : _c.key) !== null && _d !== void 0 ? _d : defaults.localStorage.key;\n    this.anonKey = 'ajs_anonymous_id';\n    var isDisabled = options.disable === true;\n    var shouldPersist = options.persist !== false;\n    this.localStorage = isDisabled || options.localStorageFallbackDisabled || !shouldPersist || !LocalStorage.available() ? new NullStorage() : new LocalStorage();\n    this.cookies = !isDisabled && shouldPersist && Cookie.available() ? new Cookie(cookieOptions) : new NullStorage();\n    this.mem = isDisabled ? new NullStorage() : new Store();\n    var legacyUser = this.cookies.get(defaults.cookie.oldKey);\n\n    if (legacyUser) {\n      legacyUser.id && this.id(legacyUser.id);\n      legacyUser.traits && this.traits(legacyUser.traits);\n    }\n\n    autoBind(this);\n  }\n\n  User.prototype.chainGet = function (key) {\n    var _a, _b, _c;\n\n    var val = (_c = (_b = (_a = this.localStorage.get(key)) !== null && _a !== void 0 ? _a : this.cookies.get(key)) !== null && _b !== void 0 ? _b : this.mem.get(key)) !== null && _c !== void 0 ? _c : null;\n    return this.trySet(key, typeof val === 'number' ? val.toString() : val);\n  };\n\n  User.prototype.trySet = function (key, value) {\n    this.localStorage.set(key, value);\n    this.cookies.set(key, value);\n    this.mem.set(key, value);\n    return value;\n  };\n\n  User.prototype.chainClear = function (key) {\n    this.localStorage.remove(key);\n    this.cookies.remove(key);\n    this.mem.remove(key);\n  };\n\n  User.prototype.legacySIO = function () {\n    var val = this.cookies.get('_sio');\n\n    if (!val) {\n      return null;\n    }\n\n    var _a = val.split('----'),\n        anon = _a[0],\n        user = _a[1];\n\n    return [anon, user];\n  };\n\n  User.prototype.identify = function (id, traits) {\n    if (this.options.disable) {\n      return;\n    }\n\n    traits = traits !== null && traits !== void 0 ? traits : {};\n    var currentId = this.id();\n\n    if (currentId === null || currentId === id) {\n      traits = __assign(__assign({}, this.traits()), traits);\n    }\n\n    if (id) {\n      this.id(id);\n    }\n\n    this.traits(traits);\n  };\n\n  User.prototype.logout = function () {\n    this.anonymousId(null);\n    this.id(null);\n    this.traits({});\n  };\n\n  User.prototype.reset = function () {\n    this.logout();\n    this.chainClear(this.idKey);\n    this.chainClear(this.anonKey);\n    this.chainClear(this.traitsKey);\n  };\n\n  User.prototype.load = function () {\n    return new User(this.options, this.cookieOptions);\n  };\n\n  User.prototype.save = function () {\n    return true;\n  };\n\n  User.defaults = defaults;\n  return User;\n}();\n\nexport { User };\nvar groupDefaults = {\n  persist: true,\n  cookie: {\n    key: 'ajs_group_id'\n  },\n  localStorage: {\n    key: 'ajs_group_properties'\n  }\n};\n\nvar Group =\n/** @class */\nfunction (_super) {\n  __extends(Group, _super);\n\n  function Group(options, cookie) {\n    if (options === void 0) {\n      options = groupDefaults;\n    }\n\n    var _this = _super.call(this, options, cookie) || this;\n\n    _this.anonymousId = function (_id) {\n      return undefined;\n    };\n\n    autoBind(_this);\n    return _this;\n  }\n\n  return Group;\n}(User);\n\nexport { Group };","map":{"version":3,"sources":["../../../../src/core/user/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends } from \"tslib\";\nimport { v4 as uuid } from '@lukeed/uuid';\nimport jar from 'js-cookie';\nimport { tld } from './tld';\nimport autoBind from '../../lib/bind-all';\nvar defaults = {\n    persist: true,\n    cookie: {\n        key: 'ajs_user_id',\n        oldKey: 'ajs_user',\n    },\n    localStorage: {\n        key: 'ajs_user_traits',\n    },\n};\nvar Store = /** @class */ (function () {\n    function Store() {\n        this.cache = {};\n    }\n    Store.prototype.get = function (key) {\n        return this.cache[key];\n    };\n    Store.prototype.set = function (key, value) {\n        this.cache[key] = value;\n        return value;\n    };\n    Store.prototype.remove = function (key) {\n        delete this.cache[key];\n    };\n    return Store;\n}());\nvar ONE_YEAR = 365;\nvar Cookie = /** @class */ (function (_super) {\n    __extends(Cookie, _super);\n    function Cookie(options) {\n        if (options === void 0) { options = Cookie.defaults; }\n        var _this = _super.call(this) || this;\n        _this.options = __assign(__assign({}, Cookie.defaults), options);\n        return _this;\n    }\n    Cookie.available = function () {\n        var cookieEnabled = window.navigator.cookieEnabled;\n        if (!cookieEnabled) {\n            jar.set('ajs:cookies', 'test');\n            cookieEnabled = document.cookie.includes('ajs:cookies');\n            jar.remove('ajs:cookies');\n        }\n        return cookieEnabled;\n    };\n    Object.defineProperty(Cookie, \"defaults\", {\n        get: function () {\n            return {\n                maxage: ONE_YEAR,\n                domain: tld(window.location.href),\n                path: '/',\n                sameSite: 'Lax',\n            };\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Cookie.prototype.opts = function () {\n        return {\n            sameSite: this.options.sameSite,\n            expires: this.options.maxage,\n            domain: this.options.domain,\n            path: this.options.path,\n            secure: this.options.secure,\n        };\n    };\n    Cookie.prototype.get = function (key) {\n        try {\n            var value = jar.get(key);\n            if (!value) {\n                return null;\n            }\n            try {\n                return JSON.parse(value);\n            }\n            catch (e) {\n                return value;\n            }\n        }\n        catch (e) {\n            return null;\n        }\n    };\n    Cookie.prototype.set = function (key, value) {\n        if (typeof value === 'string') {\n            jar.set(key, value, this.opts());\n        }\n        else if (value === null) {\n            jar.remove(key, this.opts());\n        }\n        else {\n            jar.set(key, JSON.stringify(value), this.opts());\n        }\n        return value;\n    };\n    Cookie.prototype.remove = function (key) {\n        return jar.remove(key, this.opts());\n    };\n    return Cookie;\n}(Store));\nexport { Cookie };\nvar NullStorage = /** @class */ (function (_super) {\n    __extends(NullStorage, _super);\n    function NullStorage() {\n        var _this = _super !== null && _super.apply(this, arguments) || this;\n        _this.get = function (_key) { return null; };\n        _this.set = function (_key, _val) { return null; };\n        _this.remove = function (_key) { };\n        return _this;\n    }\n    return NullStorage;\n}(Store));\nvar LocalStorage = /** @class */ (function (_super) {\n    __extends(LocalStorage, _super);\n    function LocalStorage() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    LocalStorage.available = function () {\n        var test = 'test';\n        try {\n            localStorage.setItem(test, test);\n            localStorage.removeItem(test);\n            return true;\n        }\n        catch (e) {\n            return false;\n        }\n    };\n    LocalStorage.prototype.get = function (key) {\n        var val = localStorage.getItem(key);\n        if (val) {\n            try {\n                return JSON.parse(val);\n            }\n            catch (e) {\n                return JSON.parse(JSON.stringify(val));\n            }\n        }\n        return null;\n    };\n    LocalStorage.prototype.set = function (key, value) {\n        try {\n            localStorage.setItem(key, JSON.stringify(value));\n        }\n        catch (_a) {\n            console.warn(\"Unable to set \".concat(key, \" in localStorage, storage may be full.\"));\n        }\n        return value;\n    };\n    LocalStorage.prototype.remove = function (key) {\n        return localStorage.removeItem(key);\n    };\n    return LocalStorage;\n}(Store));\nexport { LocalStorage };\nvar User = /** @class */ (function () {\n    function User(options, cookieOptions) {\n        if (options === void 0) { options = defaults; }\n        var _this = this;\n        var _a, _b, _c, _d;\n        this.options = {};\n        this.id = function (id) {\n            var _a, _b;\n            if (_this.options.disable) {\n                return null;\n            }\n            var prevId = _this.chainGet(_this.idKey);\n            if (id !== undefined) {\n                _this.trySet(_this.idKey, id);\n                var changingIdentity = id !== prevId && prevId !== null && id !== null;\n                if (changingIdentity) {\n                    _this.anonymousId(null);\n                }\n            }\n            return ((_b = (_a = _this.chainGet(_this.idKey)) !== null && _a !== void 0 ? _a : _this.cookies.get(defaults.cookie.oldKey)) !== null && _b !== void 0 ? _b : null);\n        };\n        this.anonymousId = function (id) {\n            var _a, _b;\n            if (_this.options.disable) {\n                return null;\n            }\n            if (id === undefined) {\n                var val = (_a = _this.chainGet(_this.anonKey)) !== null && _a !== void 0 ? _a : (_b = _this.legacySIO()) === null || _b === void 0 ? void 0 : _b[0];\n                if (val) {\n                    return val;\n                }\n            }\n            if (id === null) {\n                _this.trySet(_this.anonKey, null);\n                return _this.chainGet(_this.anonKey);\n            }\n            _this.trySet(_this.anonKey, id !== null && id !== void 0 ? id : uuid());\n            return _this.chainGet(_this.anonKey);\n        };\n        this.traits = function (traits) {\n            var _a, _b;\n            if (_this.options.disable) {\n                return;\n            }\n            if (traits === null) {\n                traits = {};\n            }\n            if (traits) {\n                _this.mem.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n                _this.localStorage.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n            }\n            return ((_b = (_a = _this.localStorage.get(_this.traitsKey)) !== null && _a !== void 0 ? _a : _this.mem.get(_this.traitsKey)) !== null && _b !== void 0 ? _b : {});\n        };\n        this.options = options;\n        this.cookieOptions = cookieOptions;\n        this.idKey = (_b = (_a = options.cookie) === null || _a === void 0 ? void 0 : _a.key) !== null && _b !== void 0 ? _b : defaults.cookie.key;\n        this.traitsKey = (_d = (_c = options.localStorage) === null || _c === void 0 ? void 0 : _c.key) !== null && _d !== void 0 ? _d : defaults.localStorage.key;\n        this.anonKey = 'ajs_anonymous_id';\n        var isDisabled = options.disable === true;\n        var shouldPersist = options.persist !== false;\n        this.localStorage =\n            isDisabled ||\n                options.localStorageFallbackDisabled ||\n                !shouldPersist ||\n                !LocalStorage.available()\n                ? new NullStorage()\n                : new LocalStorage();\n        this.cookies =\n            !isDisabled && shouldPersist && Cookie.available()\n                ? new Cookie(cookieOptions)\n                : new NullStorage();\n        this.mem = isDisabled ? new NullStorage() : new Store();\n        var legacyUser = this.cookies.get(defaults.cookie.oldKey);\n        if (legacyUser) {\n            legacyUser.id && this.id(legacyUser.id);\n            legacyUser.traits && this.traits(legacyUser.traits);\n        }\n        autoBind(this);\n    }\n    User.prototype.chainGet = function (key) {\n        var _a, _b, _c;\n        var val = (_c = (_b = (_a = this.localStorage.get(key)) !== null && _a !== void 0 ? _a : this.cookies.get(key)) !== null && _b !== void 0 ? _b : this.mem.get(key)) !== null && _c !== void 0 ? _c : null;\n        return this.trySet(key, typeof val === 'number' ? val.toString() : val);\n    };\n    User.prototype.trySet = function (key, value) {\n        this.localStorage.set(key, value);\n        this.cookies.set(key, value);\n        this.mem.set(key, value);\n        return value;\n    };\n    User.prototype.chainClear = function (key) {\n        this.localStorage.remove(key);\n        this.cookies.remove(key);\n        this.mem.remove(key);\n    };\n    User.prototype.legacySIO = function () {\n        var val = this.cookies.get('_sio');\n        if (!val) {\n            return null;\n        }\n        var _a = val.split('----'), anon = _a[0], user = _a[1];\n        return [anon, user];\n    };\n    User.prototype.identify = function (id, traits) {\n        if (this.options.disable) {\n            return;\n        }\n        traits = traits !== null && traits !== void 0 ? traits : {};\n        var currentId = this.id();\n        if (currentId === null || currentId === id) {\n            traits = __assign(__assign({}, this.traits()), traits);\n        }\n        if (id) {\n            this.id(id);\n        }\n        this.traits(traits);\n    };\n    User.prototype.logout = function () {\n        this.anonymousId(null);\n        this.id(null);\n        this.traits({});\n    };\n    User.prototype.reset = function () {\n        this.logout();\n        this.chainClear(this.idKey);\n        this.chainClear(this.anonKey);\n        this.chainClear(this.traitsKey);\n    };\n    User.prototype.load = function () {\n        return new User(this.options, this.cookieOptions);\n    };\n    User.prototype.save = function () {\n        return true;\n    };\n    User.defaults = defaults;\n    return User;\n}());\nexport { User };\nvar groupDefaults = {\n    persist: true,\n    cookie: {\n        key: 'ajs_group_id',\n    },\n    localStorage: {\n        key: 'ajs_group_properties',\n    },\n};\nvar Group = /** @class */ (function (_super) {\n    __extends(Group, _super);\n    function Group(options, cookie) {\n        if (options === void 0) { options = groupDefaults; }\n        var _this = _super.call(this, options, cookie) || this;\n        _this.anonymousId = function (_id) {\n            return undefined;\n        };\n        autoBind(_this);\n        return _this;\n    }\n    return Group;\n}(User));\nexport { Group };\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}