{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\rober\\\\Documents\\\\swaps-client\\\\src\\\\components\\\\Exchange\\\\PositionSeller.js\",\n    _s = $RefreshSig$();\n\nimport React, { useState, useCallback, useEffect, useMemo } from \"react\";\nimport useSWR from \"swr\";\nimport { ethers } from \"ethers\";\nimport cx from \"classnames\";\nimport { BsArrowRight } from \"react-icons/bs\";\nimport { CLOSE_POSITION_RECEIVE_TOKEN_KEY, SLIPPAGE_BPS_KEY } from '../../config/localstorage';\nimport { formatAmount, bigNumberify, DEFAULT_SLIPPAGE_AMOUNT, DEFAULT_HIGHER_SLIPPAGE_AMOUNT, USD_DECIMALS, DUST_USD, BASIS_POINTS_DIVISOR, TRIGGER_PREFIX_BELOW, TRIGGER_PREFIX_ABOVE, MIN_PROFIT_TIME, fetcher, usePrevious, formatAmountFree, parseValue, expandDecimals, getTokenInfo, getLiquidationPrice, getLeverage, getMarginFee, PRECISION, MARKET, STOP, DECREASE, LIMIT, useLocalStorageSerializeKey, calculatePositionDelta, getDeltaStr, getProfitPrice, formatDateTime, getTimeRemaining, getUserTokenBalances, USDG_DECIMALS, useLocalStorageByChainId, getNextToAmount, adjustForDecimals, getDeltaAfterFees } from \"../../Helpers\";\nimport { getAnalyticsEventStage } from \"../../utils/analytics\";\nimport \"./PositionSeller.css\";\nimport { getConstant } from \"../../Constants\";\nimport { createDecreaseOrder, callContract, useHasOutdatedUi } from \"../../Api\";\nimport { getContract } from \"../../Addresses\";\nimport PositionRouter from \"../../abis/PositionRouter.json\";\nimport Checkbox from \"../Checkbox/Checkbox\";\nimport Tab from \"../Tab/Tab\";\nimport Modal from \"../Modal/Modal\";\nimport ExchangeInfoRow from \"./ExchangeInfoRow\";\nimport Tooltip from \"../Tooltip/Tooltip\";\nimport TooltipRow from \"../Tooltip/TooltipRow\";\nimport { getTokens } from \"../../data/Tokens\";\nimport TokenSelector from \"./TokenSelector\";\nimport { getTokenAmountFromUsd, getUsd } from \"../../utils/tokens\";\nimport { convertStringToFloat } from \"../../utils/common\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst {\n  AddressZero\n} = ethers.constants;\nconst ORDER_SIZE_DUST_USD = expandDecimals(1, USD_DECIMALS - 1); // $0.10\n\nconst orderOptionLabels = {\n  [MARKET]: \"Market\",\n  [STOP]: \"Trigger\"\n};\n\nfunction shouldSwap(collateralToken, receiveToken) {\n  // If position collateral is WETH in contract, then position.collateralToken is { symbol: “ETH”, isNative: true, … }\n  // @see https://github.com/mycelium-ethereum/swaps-client/blob/master/src/pages/Exchange/Exchange.js#L162\n  // meaning if collateralToken.isNative === true in reality position has WETH as a collateral\n  // and if collateralToken.isNative === true and receiveToken.isNative === true then position’s WETH will be unwrapped and user will receive native ETH\n  const isCollateralWrapped = collateralToken.isNative;\n  const isSameToken = collateralToken.address === receiveToken.address || isCollateralWrapped && receiveToken.isWrapped;\n  const isUnwrap = isCollateralWrapped && receiveToken.isNative;\n  return !isSameToken && !isUnwrap;\n}\n\nfunction getSwapLimits(infoTokens, fromTokenAddress, toTokenAddress) {\n  const fromInfo = getTokenInfo(infoTokens, fromTokenAddress);\n  const toInfo = getTokenInfo(infoTokens, toTokenAddress);\n  let maxInUsd;\n  let maxIn;\n  let maxOut;\n  let maxOutUsd;\n\n  if (!(fromInfo !== null && fromInfo !== void 0 && fromInfo.maxUsdgAmount)) {\n    maxInUsd = bigNumberify(0);\n    maxIn = bigNumberify(0);\n  } else {\n    maxInUsd = fromInfo.maxUsdgAmount.sub(fromInfo.usdgAmount).mul(expandDecimals(1, USD_DECIMALS)).div(expandDecimals(1, USDG_DECIMALS));\n    maxIn = maxInUsd.mul(expandDecimals(1, fromInfo.decimals)).div(fromInfo.maxPrice).toString();\n  }\n\n  if (!(toInfo !== null && toInfo !== void 0 && toInfo.poolAmount) || !(toInfo !== null && toInfo !== void 0 && toInfo.bufferAmount)) {\n    maxOut = bigNumberify(0);\n    maxOutUsd = bigNumberify(0);\n  } else {\n    maxOut = toInfo.availableAmount.gt(toInfo.poolAmount.sub(toInfo.bufferAmount)) ? toInfo.poolAmount.sub(toInfo.bufferAmount) : toInfo.availableAmount;\n    maxOutUsd = getUsd(maxOut, toInfo.address, false, infoTokens);\n  }\n\n  return {\n    maxIn,\n    maxInUsd,\n    maxOut,\n    maxOutUsd\n  };\n}\n\nconst orderOptions = [MARKET, STOP];\nexport default function PositionSeller(props) {\n  _s();\n\n  var _position$indexToken;\n\n  const {\n    active,\n    pendingPositions,\n    setPendingPositions,\n    positionsMap,\n    positionKey,\n    isVisible,\n    setIsVisible,\n    account,\n    library,\n    infoTokens,\n    setPendingTxns,\n    flagOrdersEnabled,\n    savedIsPnlInLeverage,\n    chainId,\n    nativeTokenAddress,\n    orders,\n    isWaitingForPluginApproval,\n    isPluginApproving,\n    orderBookApproved,\n    setOrdersToaOpen,\n    positionRouterApproved,\n    isWaitingForPositionRouterApproval,\n    isPositionRouterApproving,\n    approvePositionRouter,\n    isHigherSlippageAllowed,\n    setIsHigherSlippageAllowed,\n    trackAction,\n    usdgSupply,\n    totalTokenWeights,\n    showPnlAfterFees\n  } = props;\n  const [savedSlippageAmount] = useLocalStorageSerializeKey([chainId, SLIPPAGE_BPS_KEY], DEFAULT_SLIPPAGE_AMOUNT);\n  const [keepLeverage, setKeepLeverage] = useLocalStorageSerializeKey([chainId, \"Exchange-keep-leverage\"], true);\n  const position = positionsMap && positionKey ? positionsMap[positionKey] : undefined;\n  const [fromValue, setFromValue] = useState(\"\");\n  const [isProfitWarningAccepted, setIsProfitWarningAccepted] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const prevIsVisible = usePrevious(isVisible);\n  const positionRouterAddress = getContract(chainId, \"PositionRouter\");\n  const nativeTokenSymbol = getConstant(chainId, \"nativeTokenSymbol\");\n  const toTokens = getTokens(chainId);\n  const [savedReceiveTokenAddress, setSavedReceiveTokenAddress] = useLocalStorageByChainId(chainId, `${CLOSE_POSITION_RECEIVE_TOKEN_KEY}-${position === null || position === void 0 ? void 0 : (_position$indexToken = position.indexToken) === null || _position$indexToken === void 0 ? void 0 : _position$indexToken.symbol}-${position.isLong ? \"long\" : \"short\"}`);\n  const [swapToToken, setSwapToToken] = useState(() => savedReceiveTokenAddress ? toTokens.find(token => token.address === savedReceiveTokenAddress) : undefined);\n  let allowedSlippage = savedSlippageAmount;\n\n  if (isHigherSlippageAllowed) {\n    allowedSlippage = DEFAULT_HIGHER_SLIPPAGE_AMOUNT;\n  }\n\n  const {\n    data: minExecutionFee\n  } = useSWR([active, chainId, positionRouterAddress, \"minExecutionFee\"], {\n    fetcher: fetcher(library, PositionRouter)\n  });\n  let [orderOption, setOrderOption] = useState(MARKET);\n\n  if (!flagOrdersEnabled) {\n    orderOption = MARKET;\n  }\n\n  const needPositionRouterApproval = !positionRouterApproved && orderOption === MARKET;\n\n  const onOrderOptionChange = option => {\n    // disabled limit close\n    if (typeof option === \"string\" && option !== LIMIT) {\n      setOrderOption(option);\n    }\n  };\n\n  const onTriggerPriceChange = evt => {\n    setTriggerPriceValue(evt.target.value || \"\");\n  };\n\n  const [triggerPriceValue, setTriggerPriceValue] = useState(\"\");\n  const triggerPriceUsd = orderOption === MARKET ? 0 : parseValue(triggerPriceValue, USD_DECIMALS);\n  const [nextDelta, nextHasProfit = bigNumberify(0)] = useMemo(() => {\n    if (!position) {\n      return [bigNumberify(0), false];\n    }\n\n    if (orderOption !== STOP) {\n      return [position.delta, position.hasProfit, position.deltaPercentage];\n    }\n\n    if (!triggerPriceUsd) {\n      return [bigNumberify(0), false];\n    }\n\n    const {\n      delta,\n      hasProfit,\n      deltaPercentage\n    } = calculatePositionDelta(triggerPriceUsd, position);\n    return [delta, hasProfit, deltaPercentage];\n  }, [position, orderOption, triggerPriceUsd]);\n  const existingOrders = useMemo(() => {\n    if (orderOption === STOP && (!triggerPriceUsd || triggerPriceUsd.eq(0))) {\n      return [];\n    }\n\n    if (!orders || !position) {\n      return [];\n    }\n\n    const ret = [];\n\n    for (const order of orders) {\n      // only Stop orders can't be executed without corresponding opened position\n      if (order.type !== DECREASE) continue; // if user creates Stop-Loss we need only Stop-Loss orders and vice versa\n\n      if (orderOption === STOP) {\n        const triggerAboveThreshold = triggerPriceUsd.gt(position.markPrice);\n        if (triggerAboveThreshold !== order.triggerAboveThreshold) continue;\n      }\n\n      const sameToken = order.indexToken === nativeTokenAddress ? position.indexToken.isNative : order.indexToken === position.indexToken.address;\n\n      if (order.isLong === position.isLong && sameToken) {\n        ret.push(order);\n      }\n    }\n\n    return ret;\n  }, [position, orders, triggerPriceUsd, orderOption, nativeTokenAddress]);\n  const existingOrder = existingOrders[0];\n  const needOrderBookApproval = orderOption === STOP && !orderBookApproved;\n  const isSwapAllowed = orderOption === MARKET;\n  const {\n    data: hasOutdatedUi\n  } = useHasOutdatedUi();\n  let collateralToken;\n  let receiveToken;\n  let maxAmount;\n  let maxAmountFormatted;\n  let maxAmountFormattedFree;\n  let fromAmount;\n  let convertedAmount;\n  let convertedAmountFormatted;\n  let nextLeverage;\n  let liquidationPrice;\n  let nextLiquidationPrice;\n  let isClosing;\n  let sizeDelta;\n  let nextCollateral;\n  let collateralDelta = bigNumberify(0);\n  let receiveAmount = bigNumberify(0);\n  let convertedReceiveAmount = bigNumberify(0);\n  let adjustedDelta = bigNumberify(0);\n  let isNotEnoughReceiveTokenLiquidity;\n  let isCollateralPoolCapacityExceeded;\n  let title;\n  let fundingFee;\n  let positionFee;\n  let swapFeeToken;\n  let swapFee;\n  let totalFees = bigNumberify(0);\n  let executionFee = orderOption === STOP ? getConstant(chainId, \"DECREASE_ORDER_EXECUTION_GAS_FEE\") : minExecutionFee;\n  let executionFeeUsd = getUsd(executionFee, nativeTokenAddress, false, infoTokens) || bigNumberify(0);\n\n  if (position) {\n    fundingFee = position.fundingFee;\n    fromAmount = parseValue(fromValue, USD_DECIMALS);\n    sizeDelta = fromAmount;\n    title = `Close ${position.isLong ? \"Long\" : \"Short\"} ${position.indexToken.symbol}`;\n    collateralToken = position.collateralToken;\n    liquidationPrice = getLiquidationPrice(position);\n\n    if (fromAmount) {\n      isClosing = position.size.sub(fromAmount).lt(DUST_USD);\n      positionFee = getMarginFee(fromAmount);\n    }\n\n    if (isClosing) {\n      sizeDelta = position.size;\n      receiveAmount = position.collateral;\n    } else if (orderOption === STOP && sizeDelta && existingOrders.length > 0) {\n      let residualSize = position.size;\n\n      for (const order of existingOrders) {\n        residualSize = residualSize.sub(order.sizeDelta);\n      }\n\n      if (residualSize.sub(sizeDelta).abs().lt(ORDER_SIZE_DUST_USD)) {\n        sizeDelta = residualSize;\n      }\n    }\n\n    if (sizeDelta) {\n      adjustedDelta = nextDelta.mul(sizeDelta).div(position.size);\n    }\n\n    if (nextHasProfit) {\n      receiveAmount = receiveAmount.add(adjustedDelta);\n    } else {\n      if (receiveAmount.gt(adjustedDelta)) {\n        receiveAmount = receiveAmount.sub(adjustedDelta);\n      } else {\n        receiveAmount = bigNumberify(0);\n      }\n    }\n\n    if (keepLeverage && sizeDelta && !isClosing) {\n      collateralDelta = sizeDelta.mul(position.collateral).div(position.size); // if the position will be realising a loss then reduce collateralDelta by the realised loss\n\n      if (!nextHasProfit) {\n        const deductions = adjustedDelta.add(positionFee).add(fundingFee);\n\n        if (collateralDelta.gt(deductions)) {\n          collateralDelta = collateralDelta = collateralDelta.sub(deductions);\n        } else {\n          collateralDelta = bigNumberify(0);\n        }\n      }\n    }\n\n    maxAmount = position.size;\n    maxAmountFormatted = formatAmount(maxAmount, USD_DECIMALS, 2, true);\n    maxAmountFormattedFree = formatAmountFree(maxAmount, USD_DECIMALS, 2);\n\n    if (fromAmount && collateralToken.maxPrice) {\n      convertedAmount = fromAmount.mul(expandDecimals(1, collateralToken.decimals)).div(collateralToken.maxPrice);\n      convertedAmountFormatted = formatAmount(convertedAmount, collateralToken.decimals, 4, true);\n    }\n\n    totalFees = totalFees.add(positionFee || bigNumberify(0)).add(fundingFee || bigNumberify(0));\n    receiveAmount = receiveAmount.add(collateralDelta);\n\n    if (sizeDelta) {\n      if (receiveAmount.gt(totalFees)) {\n        receiveAmount = receiveAmount.sub(totalFees);\n      } else {\n        receiveAmount = bigNumberify(0);\n      }\n    }\n\n    receiveToken = isSwapAllowed && swapToToken ? swapToToken : collateralToken; // Calculate swap fees\n\n    if (isSwapAllowed && swapToToken) {\n      const {\n        feeBasisPoints\n      } = getNextToAmount(chainId, convertedAmount, collateralToken.address, receiveToken.address, infoTokens, undefined, undefined, usdgSupply, totalTokenWeights, true);\n\n      if (feeBasisPoints) {\n        swapFee = receiveAmount.mul(feeBasisPoints).div(BASIS_POINTS_DIVISOR);\n        swapFeeToken = getTokenAmountFromUsd(infoTokens, collateralToken.address, swapFee);\n        totalFees = totalFees.add(swapFee || bigNumberify(0));\n        receiveAmount = receiveAmount.sub(swapFee);\n      }\n    }\n\n    if (orderOption === STOP) {\n      convertedReceiveAmount = getTokenAmountFromUsd(infoTokens, receiveToken.address, receiveAmount, {\n        overridePrice: triggerPriceUsd\n      });\n    } else {\n      convertedReceiveAmount = getTokenAmountFromUsd(infoTokens, receiveToken.address, receiveAmount);\n    } // Check swap limits (max in / max out)\n\n\n    if (isSwapAllowed && shouldSwap(collateralToken, receiveToken)) {\n      const collateralInfo = getTokenInfo(infoTokens, collateralToken.address);\n      const receiveTokenInfo = getTokenInfo(infoTokens, receiveToken.address);\n      isNotEnoughReceiveTokenLiquidity = receiveTokenInfo.availableAmount.lt(convertedReceiveAmount) || receiveTokenInfo.bufferAmount.gt(receiveTokenInfo.poolAmount.sub(convertedReceiveAmount));\n\n      if (collateralInfo.maxUsdgAmount && collateralInfo.maxUsdgAmount.gt(0) && collateralInfo.usdgAmount && collateralInfo.maxPrice) {\n        const usdgFromAmount = adjustForDecimals(receiveAmount, USD_DECIMALS, USDG_DECIMALS);\n        const nextUsdgAmount = collateralInfo.usdgAmount.add(usdgFromAmount);\n\n        if (nextUsdgAmount.gt(collateralInfo.maxUsdgAmount)) {\n          isCollateralPoolCapacityExceeded = true;\n        }\n      }\n    }\n\n    if (isClosing) {\n      nextCollateral = bigNumberify(0);\n    } else {\n      if (position.collateral) {\n        nextCollateral = position.collateral;\n\n        if (collateralDelta && collateralDelta.gt(0)) {\n          nextCollateral = position.collateral.sub(collateralDelta);\n        } else if (position.delta && position.delta.gt(0) && sizeDelta) {\n          if (!position.hasProfit) {\n            nextCollateral = nextCollateral.sub(adjustedDelta);\n          }\n        }\n      }\n    }\n\n    if (fromAmount) {\n      if (!isClosing && !keepLeverage) {\n        nextLeverage = getLeverage({\n          size: position.size,\n          sizeDelta,\n          collateral: position.collateral,\n          entryFundingRate: position.entryFundingRate,\n          cumulativeFundingRate: position.cumulativeFundingRate,\n          hasProfit: nextHasProfit,\n          delta: nextDelta,\n          includeDelta: savedIsPnlInLeverage\n        });\n        nextLiquidationPrice = getLiquidationPrice({\n          isLong: position.isLong,\n          size: position.size,\n          sizeDelta,\n          collateral: position.collateral,\n          averagePrice: position.averagePrice,\n          entryFundingRate: position.entryFundingRate,\n          cumulativeFundingRate: position.cumulativeFundingRate,\n          delta: nextDelta,\n          hasProfit: nextHasProfit,\n          includeDelta: true\n        });\n      }\n    }\n  }\n\n  const [deltaStr, deltaPercentageStr] = useMemo(() => {\n    let pendingDelta, pendingDeltaPercentage, hasProfit;\n\n    if (!position || !position.markPrice) {\n      return [\"-\", \"-\"];\n    } else if (orderOption !== STOP) {\n      ({\n        pendingDelta,\n        pendingDeltaPercentage,\n        hasProfit\n      } = calculatePositionDelta(position.markPrice, position, fromAmount));\n    } else if (!triggerPriceUsd || triggerPriceUsd.eq(0)) {\n      return [\"-\", \"-\"];\n    } else {\n      ({\n        pendingDelta,\n        pendingDeltaPercentage,\n        hasProfit\n      } = calculatePositionDelta(triggerPriceUsd, position, fromAmount));\n    }\n\n    let deltaStr, deltaPercentageStr;\n\n    if (showPnlAfterFees) {\n      const {\n        pendingDeltaAfterFees,\n        deltaPercentageAfterFees,\n        hasProfitAfterFees\n      } = getDeltaAfterFees({\n        delta: pendingDelta,\n        totalFees: position.totalFees,\n        hasProfit,\n        collateral: position.collateral\n      });\n\n      if (!pendingDeltaAfterFees) {\n        return ['-', '-'];\n      }\n\n      ({\n        deltaStr,\n        deltaPercentageStr\n      } = getDeltaStr({\n        delta: pendingDeltaAfterFees,\n        deltaPercentage: deltaPercentageAfterFees,\n        hasProfit: hasProfitAfterFees\n      }));\n    } else {\n      ({\n        deltaStr,\n        deltaPercentageStr\n      } = getDeltaStr({\n        delta: pendingDelta,\n        deltaPercentage: pendingDeltaPercentage,\n        hasProfit\n      }));\n    }\n\n    return [deltaStr, deltaPercentageStr];\n  }, [position, triggerPriceUsd, orderOption, fromAmount]);\n\n  const getError = () => {\n    if (hasOutdatedUi) {\n      return \"Page outdated, please refresh\";\n    }\n\n    if (!fromAmount) {\n      return \"Enter an amount\";\n    }\n\n    if (nextLeverage && nextLeverage.eq(0)) {\n      return \"Enter an amount\";\n    }\n\n    if (orderOption === STOP) {\n      if (!triggerPriceUsd || triggerPriceUsd.eq(0)) {\n        return \"Enter Price\";\n      }\n\n      if (position.isLong && triggerPriceUsd.lte(liquidationPrice)) {\n        return \"Price below Liq. Price\";\n      }\n\n      if (!position.isLong && triggerPriceUsd.gte(liquidationPrice)) {\n        return \"Price above Liq. Price\";\n      }\n\n      if (profitPrice && nextDelta.eq(0) && nextHasProfit) {\n        return \"Invalid price, see warning\";\n      }\n    }\n\n    if (!isClosing && position && position.size && fromAmount) {\n      if (position.size.sub(fromAmount).lt(expandDecimals(10, USD_DECIMALS))) {\n        return \"Leftover position below 10 USD\";\n      }\n    }\n\n    if (position && position.size && position.size.lt(fromAmount)) {\n      return \"Max close amount exceeded\";\n    }\n\n    if (nextLeverage && nextLeverage.lt(1.1 * BASIS_POINTS_DIVISOR)) {\n      return \"Min leverage: 1.1x\";\n    }\n\n    if (nextLeverage && nextLeverage.gt(30.5 * BASIS_POINTS_DIVISOR)) {\n      return \"Max leverage: 30.5x\";\n    }\n\n    if (hasPendingProfit && orderOption !== STOP && !isProfitWarningAccepted) {\n      return \"Forfeit profit not checked\";\n    }\n  };\n\n  const isPrimaryEnabled = () => {\n    const error = getError();\n\n    if (error) {\n      return false;\n    }\n\n    if (isSubmitting) {\n      return false;\n    }\n\n    if (needOrderBookApproval && isWaitingForPluginApproval) {\n      return false;\n    }\n\n    if (isPluginApproving) {\n      return false;\n    }\n\n    if (needPositionRouterApproval && isWaitingForPositionRouterApproval) {\n      return false;\n    }\n\n    if (isPositionRouterApproving) {\n      return false;\n    }\n\n    return true;\n  };\n\n  const hasPendingProfit = MIN_PROFIT_TIME > 0 && position.delta.eq(0) && position.pendingDelta.gt(0);\n\n  const getPrimaryText = () => {\n    const error = getError();\n\n    if (error) {\n      return error;\n    }\n\n    if (orderOption === STOP) {\n      if (isSubmitting) return \"Creating Order...\";\n\n      if (needOrderBookApproval && isWaitingForPluginApproval) {\n        return \"Enabling Orders...\";\n      }\n\n      if (isPluginApproving) {\n        return \"Enabling Orders...\";\n      }\n\n      if (needOrderBookApproval) {\n        return \"Enable Orders\";\n      }\n\n      return \"Create Order\";\n    }\n\n    if (needPositionRouterApproval && isWaitingForPositionRouterApproval) {\n      return \"Enabling Leverage...\";\n    }\n\n    if (isPositionRouterApproving) {\n      return \"Enabling Leverage...\";\n    }\n\n    if (needPositionRouterApproval) {\n      return \"Enable Leverage\";\n    }\n\n    if (hasPendingProfit) {\n      return \"Close without profit\";\n    }\n\n    return isSubmitting ? \"Closing...\" : \"Close\";\n  };\n\n  const resetForm = () => {\n    setFromValue(\"\");\n    setIsProfitWarningAccepted(false);\n  };\n\n  useEffect(() => {\n    if (prevIsVisible !== isVisible) {\n      resetForm();\n    }\n  }, [prevIsVisible, isVisible]);\n\n  const onClickPrimary = async () => {\n    if (needOrderBookApproval) {\n      setOrdersToaOpen(true);\n      return;\n    }\n\n    if (needPositionRouterApproval) {\n      approvePositionRouter({\n        sentMsg: `Enable leverage sent.`,\n        failMsg: `Enable leverage failed.`\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    const collateralTokenAddress = position.collateralToken.isNative ? nativeTokenAddress : position.collateralToken.address;\n    const indexTokenAddress = position.indexToken.isNative ? nativeTokenAddress : position.indexToken.address;\n\n    if (orderOption === STOP) {\n      const triggerAboveThreshold = triggerPriceUsd.gt(position.markPrice);\n      createDecreaseOrder(chainId, library, indexTokenAddress, sizeDelta, collateralTokenAddress, collateralDelta, position.isLong, triggerPriceUsd, triggerAboveThreshold, {\n        sentMsg: `Order submitted!`,\n        successMsg: `Order created!`,\n        failMsg: `Order creation failed.`,\n        setPendingTxns\n      }).then(() => {\n        setFromValue(\"\");\n        setIsVisible(false);\n      }).finally(() => {\n        setIsSubmitting(false);\n      });\n      return;\n    }\n\n    const priceBasisPoints = position.isLong ? BASIS_POINTS_DIVISOR - allowedSlippage : BASIS_POINTS_DIVISOR + allowedSlippage;\n    const refPrice = position.isLong ? position.indexToken.minPrice : position.indexToken.maxPrice;\n    let priceLimit = refPrice.mul(priceBasisPoints).div(BASIS_POINTS_DIVISOR);\n    const minProfitExpiration = position.lastIncreasedTime + MIN_PROFIT_TIME;\n    const minProfitTimeExpired = parseInt(Date.now() / 1000) > minProfitExpiration;\n\n    if (nextHasProfit && !minProfitTimeExpired && !isProfitWarningAccepted) {\n      if (position.isLong && priceLimit.lt(profitPrice) || !position.isLong && priceLimit.gt(profitPrice)) {\n        priceLimit = profitPrice;\n      }\n    }\n\n    const tokenAddress0 = collateralTokenAddress === AddressZero ? nativeTokenAddress : collateralTokenAddress;\n    const path = [tokenAddress0];\n    const isUnwrap = receiveToken.address === AddressZero;\n    const isSwap = receiveToken.address !== tokenAddress0;\n\n    if (isSwap) {\n      if (isUnwrap && tokenAddress0 !== nativeTokenAddress) {\n        path.push(nativeTokenAddress);\n      } else if (!isUnwrap) {\n        path.push(receiveToken.address);\n      }\n    }\n\n    const withdrawETH = isUnwrap;\n    const params = [path, // _path\n    indexTokenAddress, // _indexToken\n    collateralDelta, // _collateralDelta\n    sizeDelta, // _sizeDelta\n    position.isLong, // _isLong\n    account, // _receiver\n    priceLimit, // _acceptablePrice\n    0, // _minOut\n    minExecutionFee, // _executionFee\n    withdrawETH // _withdrawETH\n    ];\n    const successMsg = `Requested decrease of ${position.indexToken.symbol} ${position.isLong ? \"Long\" : \"Short\"} by ${formatAmount(sizeDelta, USD_DECIMALS, 2)} USD.`;\n    const contract = new ethers.Contract(positionRouterAddress, PositionRouter.abi, library.getSigner());\n    callContract(chainId, contract, \"createDecreasePosition\", params, {\n      value: minExecutionFee,\n      sentMsg: `Close submitted!`,\n      successMsg,\n      failMsg: `Close failed.`,\n      setPendingTxns\n    }).then(async res => {\n      setFromValue(\"\");\n      setIsVisible(false);\n      let nextSize = position.size.sub(sizeDelta);\n      pendingPositions[position.key] = {\n        updatedAt: Date.now(),\n        pendingChanges: {\n          size: nextSize\n        }\n      };\n      setPendingPositions({ ...pendingPositions\n      });\n    }).finally(() => {\n      setIsSubmitting(false);\n    });\n  };\n\n  const renderExistingOrderWarning = useCallback(() => {\n    if (!existingOrder) {\n      return;\n    }\n\n    const indexToken = getTokenInfo(infoTokens, existingOrder.indexToken);\n    const sizeInToken = formatAmount(existingOrder.sizeDelta.mul(PRECISION).div(existingOrder.triggerPrice), USD_DECIMALS, 4, true);\n    const prefix = existingOrder.triggerAboveThreshold ? TRIGGER_PREFIX_ABOVE : TRIGGER_PREFIX_BELOW;\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"Confirmation-box-warning\",\n      children: [\"You have an active order to decrease \", existingOrder.isLong ? \"Long\" : \"Short\", \" \", sizeInToken, \" \", indexToken.symbol, \" \", \"($\", formatAmount(existingOrder.sizeDelta, USD_DECIMALS, 2, true), \") at \", prefix, \" \", formatAmount(existingOrder.triggerPrice, USD_DECIMALS, 2, true)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 799,\n      columnNumber: 7\n    }, this);\n  }, [existingOrder, infoTokens]);\n\n  function renderMinProfitWarning() {\n    if (MIN_PROFIT_TIME === 0) {\n      return null;\n    }\n\n    if (profitPrice && nextDelta.eq(0) && nextHasProfit) {\n      const minProfitExpiration = position.lastIncreasedTime + MIN_PROFIT_TIME;\n\n      if (orderOption === MARKET) {\n        return /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Confirmation-box-warning\",\n          children: [\"Reducing the position at the current price will forfeit a pending profit of \", deltaStr, \". \", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 819,\n            columnNumber: 101\n          }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 820,\n            columnNumber: 13\n          }, this), \"Profit price: \", position.isLong ? \">\" : \"<\", \" $\", formatAmount(profitPrice, USD_DECIMALS, 2, true), \". This rule applies for the next \", getTimeRemaining(minProfitExpiration), \", until \", formatDateTime(minProfitExpiration), \".\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 818,\n          columnNumber: 11\n        }, this);\n      }\n\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"Confirmation-box-warning\",\n        children: [\"This order will forfeit a profit of \", deltaStr, \". \", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 828,\n          columnNumber: 59\n        }, this), \"Profit price: \", position.isLong ? \">\" : \"<\", \" $\", formatAmount(profitPrice, USD_DECIMALS, 2, true), \". This rule applies for the next \", getTimeRemaining(minProfitExpiration), \", until \", formatDateTime(minProfitExpiration), \".\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 827,\n        columnNumber: 9\n      }, this);\n    }\n  }\n\n  const profitPrice = getProfitPrice(orderOption === MARKET ? position.markPrice : triggerPriceUsd, position);\n  let triggerPricePrefix;\n\n  if (triggerPriceUsd) {\n    triggerPricePrefix = triggerPriceUsd.gt(position.markPrice) ? TRIGGER_PREFIX_ABOVE : TRIGGER_PREFIX_BELOW;\n  }\n\n  const shouldShowExistingOrderWarning = false;\n\n  const trackClosePosition = stage => {\n    const eventName = getAnalyticsEventStage(stage);\n\n    try {\n      const size = convertStringToFloat(formatAmount(position.size, USD_DECIMALS, 2, true));\n      const collateral = convertStringToFloat(formatAmount(position.collateral, USD_DECIMALS, 2, true));\n      const nextCollateralValue = nextCollateral ? convertStringToFloat(formatAmount(nextCollateral, USD_DECIMALS, 2, true)) : 0;\n      const leverage = convertStringToFloat(formatAmount(position.leverage, 4, 2, true));\n      const nextLeverageValue = nextLeverage ? convertStringToFloat(formatAmount(nextLeverage, 4, 2, true)) : 0;\n      const liqPrice = convertStringToFloat(formatAmount(liquidationPrice, USD_DECIMALS, 2, true));\n      const nextLiqPriceValue = nextLiquidationPrice ? convertStringToFloat(formatAmount(nextLiquidationPrice, USD_DECIMALS, 2, true)) : 0;\n      const amountToPay = convertedAmountFormatted;\n      const allowedSlippageValue = convertStringToFloat(formatAmount(allowedSlippage, 2, 2));\n      const entryPrice = convertStringToFloat(formatAmount(position.averagePrice, USD_DECIMALS, 2, true));\n      const exitPrice = convertStringToFloat(formatAmount(position.markPrice, USD_DECIMALS, 2, true));\n      const borrowFeeValue = convertStringToFloat(formatAmount(fundingFee, USD_DECIMALS, 2, true));\n      const closingFee = convertStringToFloat(formatAmount(positionFee, USD_DECIMALS, 2, true));\n      const amountToReceiveUsd = convertStringToFloat(formatAmount(receiveAmount, USD_DECIMALS, 2, true));\n      const amountToReceive = convertStringToFloat(formatAmount(convertedReceiveAmount, position.collateralToken.decimals, 4, true));\n      const [userBalances, tokenPrices, poolBalances] = getUserTokenBalances(infoTokens);\n      const traits = {\n        actionType: \"Close\",\n        position: position.isLong ? \"Long\" : \"Short\",\n        transactionType: orderOption === MARKET ? \"Market\" : \"Trigger\",\n        size: size,\n        collateral: collateral,\n        nextCollateral: nextCollateralValue,\n        leverage: leverage,\n        nextLeverage: nextLeverageValue,\n        keepOriginalLeverage: keepLeverage,\n        upToOnePercentSlippageEnabled: isHigherSlippageAllowed,\n        liqPrice: liqPrice,\n        nextLiqPrice: nextLiqPriceValue,\n        amountToPay: amountToPay,\n        allowedSlippage: allowedSlippageValue,\n        entryPrice: entryPrice,\n        exitPrice: exitPrice,\n        borrowFee: borrowFeeValue,\n        closingFee: closingFee,\n        pnlActual: deltaStr,\n        pnlPercentage: deltaPercentageStr,\n        amountToReceiveUsd: amountToReceiveUsd,\n        amountToReceive: amountToReceive,\n        tokenToReceive: position.collateralToken.symbol,\n        ...userBalances,\n        ...tokenPrices,\n        ...poolBalances\n      };\n      trackAction && trackAction(eventName, traits);\n    } catch (err) {\n      console.error(`Unable to track ${eventName} event`, err);\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"PositionEditor\",\n    children: position && /*#__PURE__*/_jsxDEV(Modal, {\n      isVisible: isVisible,\n      setIsVisible: setIsVisible,\n      label: title,\n      children: [flagOrdersEnabled && /*#__PURE__*/_jsxDEV(Tab, {\n        options: orderOptions,\n        option: orderOption,\n        optionLabels: orderOptionLabels,\n        onChange: onOrderOptionChange\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 910,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"Exchange-swap-section\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-swap-section-top\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"muted\",\n            children: [convertedAmountFormatted && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"Exchange-swap-usd\",\n              children: [\"Close: \", convertedAmountFormatted, \" \", position.collateralToken.symbol]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 921,\n              columnNumber: 19\n            }, this), !convertedAmountFormatted && \"Close\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 919,\n            columnNumber: 15\n          }, this), maxAmount && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"muted align-right clickable\",\n            onClick: () => setFromValue(maxAmountFormattedFree),\n            children: [\"Max: \", maxAmountFormatted]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 928,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 918,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-swap-section-bottom\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-swap-input-container\",\n            children: [/*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"number\",\n              min: \"0\",\n              placeholder: \"0.0\",\n              className: \"Exchange-swap-input\",\n              value: fromValue,\n              onChange: e => setFromValue(e.target.value)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 935,\n              columnNumber: 17\n            }, this), fromValue !== maxAmountFormattedFree && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"Exchange-swap-max\",\n              onClick: () => {\n                setFromValue(maxAmountFormattedFree);\n              },\n              children: \"MAX\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 944,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 934,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"PositionEditor-token-symbol\",\n            children: \"USD\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 954,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 933,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 917,\n        columnNumber: 11\n      }, this), orderOption === STOP && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"Exchange-swap-section\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-swap-section-top\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"muted\",\n            children: \"Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 960,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"muted align-right clickable\",\n            onClick: () => {\n              setTriggerPriceValue(formatAmountFree(position.markPrice, USD_DECIMALS, 2));\n            },\n            children: [\"Mark: \", formatAmount(position.markPrice, USD_DECIMALS, 2, true)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 961,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 959,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-swap-section-bottom\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-swap-input-container\",\n            children: /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"number\",\n              min: \"0\",\n              placeholder: \"0.0\",\n              className: \"Exchange-swap-input\",\n              value: triggerPriceValue,\n              onChange: onTriggerPriceChange\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 972,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 971,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"PositionEditor-token-symbol\",\n            children: \"USD\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 981,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 970,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 958,\n        columnNumber: 13\n      }, this), renderMinProfitWarning(), shouldShowExistingOrderWarning && renderExistingOrderWarning(), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"PositionEditor-info-box\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row PositionSeller-receive-row bottom-line\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Receive\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 989,\n            columnNumber: 15\n          }, this), !isSwapAllowed && receiveToken && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right PositionSelector-selected-receive-token\",\n            children: [formatAmount(convertedReceiveAmount, receiveToken.decimals, 4, true), \"\\xA0\", receiveToken.symbol, \" ($\", formatAmount(receiveAmount, USD_DECIMALS, 2, true), \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 994,\n            columnNumber: 17\n          }, this), isSwapAllowed && receiveToken && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: /*#__PURE__*/_jsxDEV(TokenSelector // Scroll lock lead to side effects\n            // if it applied on modal inside another modal\n            , {\n              disableBodyScrollLock: true,\n              className: cx(\"PositionSeller-token-selector\", {\n                warning: isNotEnoughReceiveTokenLiquidity || isCollateralPoolCapacityExceeded\n              }),\n              label: \"Receive\",\n              showBalances: false,\n              chainId: chainId,\n              tokenAddress: receiveToken.address,\n              onSelectToken: token => {\n                setSwapToToken(token);\n                setSavedReceiveTokenAddress(token.address);\n              },\n              tokens: toTokens,\n              getTokenState: tokenOptionInfo => {\n                if (!shouldSwap(collateralToken, tokenOptionInfo)) {\n                  return;\n                }\n\n                const convertedTokenAmount = getTokenAmountFromUsd(infoTokens, tokenOptionInfo.address, receiveAmount);\n                const isNotEnoughLiquidity = tokenOptionInfo.availableAmount.lt(convertedTokenAmount) || tokenOptionInfo.bufferAmount.gt(tokenOptionInfo.poolAmount.sub(convertedTokenAmount));\n\n                if (isNotEnoughLiquidity) {\n                  const {\n                    maxIn,\n                    maxOut,\n                    maxInUsd,\n                    maxOutUsd\n                  } = getSwapLimits(infoTokens, collateralToken.address, tokenOptionInfo.address);\n                  const collateralInfo = getTokenInfo(infoTokens, collateralToken.address);\n                  return {\n                    disabled: true,\n                    message: /*#__PURE__*/_jsxDEV(\"div\", {\n                      children: [\"Insufficient Available Liquidity to swap to \", tokenOptionInfo.symbol, \":\", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1047,\n                        columnNumber: 31\n                      }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1048,\n                        columnNumber: 31\n                      }, this), /*#__PURE__*/_jsxDEV(TooltipRow, {\n                        label: `Max ${collateralInfo.symbol} in`,\n                        value: [`${formatAmount(maxIn, collateralInfo.decimals, 0, true)} ${collateralInfo.symbol}`, `($${formatAmount(maxInUsd, USD_DECIMALS, 0, true)})`]\n                      }, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1049,\n                        columnNumber: 31\n                      }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1056,\n                        columnNumber: 31\n                      }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1057,\n                        columnNumber: 31\n                      }, this), \"Max \", tokenOptionInfo.symbol, \" out:\", \" \", formatAmount(maxOut, tokenOptionInfo.decimals, 2, true), \" \", tokenOptionInfo.symbol, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                        fileName: _jsxFileName,\n                        lineNumber: 1060,\n                        columnNumber: 31\n                      }, this), \"($\", formatAmount(maxOutUsd, USD_DECIMALS, 2, true), \")\"]\n                    }, void 0, true, {\n                      fileName: _jsxFileName,\n                      lineNumber: 1045,\n                      columnNumber: 29\n                    }, this)\n                  };\n                }\n              },\n              infoTokens: infoTokens,\n              showTokenImgInDropdown: true,\n              selectedTokenLabel: /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"PositionSelector-selected-receive-token\",\n                children: [formatAmount(convertedReceiveAmount, receiveToken.decimals, 4, true), \"\\xA0\", receiveToken.symbol, \" ($\", formatAmount(receiveAmount, USD_DECIMALS, 2, true), \")\"]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1070,\n                columnNumber: 23\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1002,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1001,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 988,\n          columnNumber: 13\n        }, this), hasPendingProfit && orderOption !== STOP && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"PositionEditor-accept-profit-warning\",\n          children: /*#__PURE__*/_jsxDEV(Checkbox, {\n            isChecked: isProfitWarningAccepted,\n            setIsChecked: setIsProfitWarningAccepted,\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"muted\",\n              children: \"Forfeit profit\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1082,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1081,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1080,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"PositionEditor-keep-leverage-settings\",\n          children: /*#__PURE__*/_jsxDEV(Checkbox, {\n            isChecked: keepLeverage,\n            setIsChecked: setKeepLeverage,\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"muted\",\n              children: [\"Keep leverage at \", formatAmount(position.leverage, 4, 2), \"x\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1088,\n              columnNumber: 17\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1087,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1086,\n          columnNumber: 13\n        }, this), orderOption === MARKET && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"PositionEditor-allow-higher-slippage\",\n          children: /*#__PURE__*/_jsxDEV(Checkbox, {\n            isChecked: isHigherSlippageAllowed,\n            setIsChecked: setIsHigherSlippageAllowed,\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              className: \"muted\",\n              children: \"Allow up to 1% slippage\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1094,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1093,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1092,\n          columnNumber: 15\n        }, this), orderOption === MARKET && /*#__PURE__*/_jsxDEV(\"div\", {\n          children: /*#__PURE__*/_jsxDEV(ExchangeInfoRow, {\n            label: \"Allowed Slippage\",\n            children: /*#__PURE__*/_jsxDEV(Tooltip, {\n              handle: `${formatAmount(allowedSlippage, 2, 2)}%`,\n              position: \"right-bottom\",\n              renderContent: () => {\n                return /*#__PURE__*/_jsxDEV(_Fragment, {\n                  children: [\"You can change this in the settings menu on the top right of the page.\", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1108,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1109,\n                    columnNumber: 27\n                  }, this), \"Note that a low allowed slippage, e.g. less than 0.5%, may result in failed orders if prices are volatile.\"]\n                }, void 0, true);\n              }\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1101,\n              columnNumber: 19\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1100,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1099,\n          columnNumber: 15\n        }, this), orderOption === STOP && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Trigger Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1121,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [!triggerPriceUsd && \"-\", triggerPriceUsd && `${triggerPricePrefix} ${formatAmount(triggerPriceUsd, USD_DECIMALS, 2, true)}`]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1122,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1120,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Entry Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1129,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [\"$\", formatAmount(position.averagePrice, USD_DECIMALS, 2, true)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1130,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1128,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Exit Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1133,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [\"$\", formatAmount(position.markPrice, USD_DECIMALS, 2, true)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1134,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1132,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Liq. Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1137,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [isClosing && orderOption !== STOP && \"-\", (!isClosing || orderOption === STOP) && /*#__PURE__*/_jsxDEV(\"div\", {\n              children: [(!nextLiquidationPrice || nextLiquidationPrice.eq(liquidationPrice)) && /*#__PURE__*/_jsxDEV(\"div\", {\n                children: `$${formatAmount(liquidationPrice, USD_DECIMALS, 2, true)}`\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1143,\n                columnNumber: 23\n              }, this), nextLiquidationPrice && !nextLiquidationPrice.eq(liquidationPrice) && /*#__PURE__*/_jsxDEV(\"div\", {\n                children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"inline-block muted\",\n                  children: [\"$\", formatAmount(liquidationPrice, USD_DECIMALS, 2, true), /*#__PURE__*/_jsxDEV(BsArrowRight, {\n                    className: \"transition-arrow\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1149,\n                    columnNumber: 27\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1147,\n                  columnNumber: 25\n                }, this), \"$\", formatAmount(nextLiquidationPrice, USD_DECIMALS, 2, true)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1146,\n                columnNumber: 23\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1141,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1138,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1136,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row top-line\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Size\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1159,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [position && position.size && fromAmount && /*#__PURE__*/_jsxDEV(\"div\", {\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"inline-block muted\",\n                children: [\"$\", formatAmount(position.size, USD_DECIMALS, 2, true), /*#__PURE__*/_jsxDEV(BsArrowRight, {\n                  className: \"transition-arrow\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1165,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1163,\n                columnNumber: 21\n              }, this), \"$\", formatAmount(position.size.sub(fromAmount), USD_DECIMALS, 2, true)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1162,\n              columnNumber: 19\n            }, this), position && position.size && !fromAmount && /*#__PURE__*/_jsxDEV(\"div\", {\n              children: [\"$\", formatAmount(position.size, USD_DECIMALS, 2, true)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1171,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1160,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1158,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Collateral\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1176,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: nextCollateral && !nextCollateral.eq(position.collateral) ? /*#__PURE__*/_jsxDEV(\"div\", {\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"inline-block muted\",\n                children: [\"$\", formatAmount(position.collateral, USD_DECIMALS, 2, true), /*#__PURE__*/_jsxDEV(BsArrowRight, {\n                  className: \"transition-arrow\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1182,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1180,\n                columnNumber: 21\n              }, this), \"$\", formatAmount(nextCollateral, USD_DECIMALS, 2, true)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1179,\n              columnNumber: 19\n            }, this) : `$${formatAmount(position.collateral, USD_DECIMALS, 4, true)}`\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1177,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1175,\n          columnNumber: 13\n        }, this), !keepLeverage && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Leverage\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1193,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [isClosing && \"-\", !isClosing && /*#__PURE__*/_jsxDEV(\"div\", {\n              children: [!nextLeverage && /*#__PURE__*/_jsxDEV(\"div\", {\n                children: [formatAmount(position.leverage, 4, 2), \"x\"]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1198,\n                columnNumber: 41\n              }, this), nextLeverage && /*#__PURE__*/_jsxDEV(\"div\", {\n                children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"inline-block muted\",\n                  children: [formatAmount(position.leverage, 4, 2), \"x\", /*#__PURE__*/_jsxDEV(BsArrowRight, {\n                    className: \"transition-arrow\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1203,\n                    columnNumber: 29\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1201,\n                  columnNumber: 27\n                }, this), formatAmount(nextLeverage, 4, 2), \"x\"]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1200,\n                columnNumber: 25\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1197,\n              columnNumber: 21\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1194,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1192,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"PnL\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1214,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [deltaStr, \" (\", deltaPercentageStr, \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1215,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1213,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row top-line\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Borrow Fee\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1220,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [\"$\", formatAmount(fundingFee, USD_DECIMALS, 2, true)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1221,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1219,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Closing Fee\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1224,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: [positionFee && `$${formatAmount(positionFee, USD_DECIMALS, 2, true)}`, !positionFee && \"-\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1225,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1223,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"Exchange-info-row\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"Exchange-info-label\",\n            children: \"Fees\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1231,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"align-right\",\n            children: /*#__PURE__*/_jsxDEV(Tooltip, {\n              position: \"right-top\",\n              className: \"PositionSeller-fees-tooltip\",\n              handle: /*#__PURE__*/_jsxDEV(\"div\", {\n                children: totalFees ? `$${formatAmount(totalFees.add(executionFeeUsd), USD_DECIMALS, 2, true)}` : \"-\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1239,\n                columnNumber: 21\n              }, this),\n              renderContent: () => /*#__PURE__*/_jsxDEV(\"div\", {\n                children: [fundingFee && /*#__PURE__*/_jsxDEV(TooltipRow, {\n                  label: \"Borrow fee\",\n                  value: formatAmount(fundingFee, USD_DECIMALS, 2, true)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1246,\n                  columnNumber: 25\n                }, this), positionFee && /*#__PURE__*/_jsxDEV(TooltipRow, {\n                  label: \"Closing fee\",\n                  value: formatAmount(positionFee, USD_DECIMALS, 2, true)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1250,\n                  columnNumber: 25\n                }, this), swapFee && /*#__PURE__*/_jsxDEV(TooltipRow, {\n                  label: \"Swap fee\",\n                  showDollar: false,\n                  value: `${formatAmount(swapFeeToken, collateralToken.decimals, 5)} ${collateralToken.symbol}\n                           ($${formatAmount(swapFee, USD_DECIMALS, 2, true)})`\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1254,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(TooltipRow, {\n                  label: \"Execution fee\",\n                  showDollar: false,\n                  value: `${formatAmount(executionFee, 18, 5, true)} ${nativeTokenSymbol} ($${formatAmount(executionFeeUsd, USD_DECIMALS, 2)})`\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1262,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1272,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: \"PositionSeller-fee-item\",\n                  children: [/*#__PURE__*/_jsxDEV(\"a\", {\n                    href: \"https://swaps.docs.mycelium.xyz/protocol-design/trading/fees\",\n                    target: \"_blank\",\n                    rel: \"noopener noreferrer\",\n                    children: \"More Info\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1275,\n                    columnNumber: 25\n                  }, this), \" \", \"about fees.\"]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1274,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1244,\n                columnNumber: 21\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1235,\n              columnNumber: 17\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1234,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1230,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 987,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"Exchange-swap-button-container\",\n        children: /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"App-cta Exchange-swap-button\",\n          onClick: () => {\n            const stage = getPrimaryText() === \"Approve\" ? 1 : 2;\n            trackClosePosition(stage);\n            onClickPrimary();\n          },\n          disabled: !isPrimaryEnabled(),\n          children: getPrimaryText()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1287,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1286,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 908,\n      columnNumber: 9\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 906,\n    columnNumber: 5\n  }, this);\n}\n\n_s(PositionSeller, \"NRKCjLIe2S8MbaMQaFBXLF2+rsI=\", false, function () {\n  return [useLocalStorageSerializeKey, useLocalStorageSerializeKey, usePrevious, useLocalStorageByChainId, useSWR, useHasOutdatedUi];\n});\n\n_c = PositionSeller;\n\nvar _c;\n\n$RefreshReg$(_c, \"PositionSeller\");","map":{"version":3,"names":["React","useState","useCallback","useEffect","useMemo","useSWR","ethers","cx","BsArrowRight","CLOSE_POSITION_RECEIVE_TOKEN_KEY","SLIPPAGE_BPS_KEY","formatAmount","bigNumberify","DEFAULT_SLIPPAGE_AMOUNT","DEFAULT_HIGHER_SLIPPAGE_AMOUNT","USD_DECIMALS","DUST_USD","BASIS_POINTS_DIVISOR","TRIGGER_PREFIX_BELOW","TRIGGER_PREFIX_ABOVE","MIN_PROFIT_TIME","fetcher","usePrevious","formatAmountFree","parseValue","expandDecimals","getTokenInfo","getLiquidationPrice","getLeverage","getMarginFee","PRECISION","MARKET","STOP","DECREASE","LIMIT","useLocalStorageSerializeKey","calculatePositionDelta","getDeltaStr","getProfitPrice","formatDateTime","getTimeRemaining","getUserTokenBalances","USDG_DECIMALS","useLocalStorageByChainId","getNextToAmount","adjustForDecimals","getDeltaAfterFees","getAnalyticsEventStage","getConstant","createDecreaseOrder","callContract","useHasOutdatedUi","getContract","PositionRouter","Checkbox","Tab","Modal","ExchangeInfoRow","Tooltip","TooltipRow","getTokens","TokenSelector","getTokenAmountFromUsd","getUsd","convertStringToFloat","AddressZero","constants","ORDER_SIZE_DUST_USD","orderOptionLabels","shouldSwap","collateralToken","receiveToken","isCollateralWrapped","isNative","isSameToken","address","isWrapped","isUnwrap","getSwapLimits","infoTokens","fromTokenAddress","toTokenAddress","fromInfo","toInfo","maxInUsd","maxIn","maxOut","maxOutUsd","maxUsdgAmount","sub","usdgAmount","mul","div","decimals","maxPrice","toString","poolAmount","bufferAmount","availableAmount","gt","orderOptions","PositionSeller","props","active","pendingPositions","setPendingPositions","positionsMap","positionKey","isVisible","setIsVisible","account","library","setPendingTxns","flagOrdersEnabled","savedIsPnlInLeverage","chainId","nativeTokenAddress","orders","isWaitingForPluginApproval","isPluginApproving","orderBookApproved","setOrdersToaOpen","positionRouterApproved","isWaitingForPositionRouterApproval","isPositionRouterApproving","approvePositionRouter","isHigherSlippageAllowed","setIsHigherSlippageAllowed","trackAction","usdgSupply","totalTokenWeights","showPnlAfterFees","savedSlippageAmount","keepLeverage","setKeepLeverage","position","undefined","fromValue","setFromValue","isProfitWarningAccepted","setIsProfitWarningAccepted","isSubmitting","setIsSubmitting","prevIsVisible","positionRouterAddress","nativeTokenSymbol","toTokens","savedReceiveTokenAddress","setSavedReceiveTokenAddress","indexToken","symbol","isLong","swapToToken","setSwapToToken","find","token","allowedSlippage","data","minExecutionFee","orderOption","setOrderOption","needPositionRouterApproval","onOrderOptionChange","option","onTriggerPriceChange","evt","setTriggerPriceValue","target","value","triggerPriceValue","triggerPriceUsd","nextDelta","nextHasProfit","delta","hasProfit","deltaPercentage","existingOrders","eq","ret","order","type","triggerAboveThreshold","markPrice","sameToken","push","existingOrder","needOrderBookApproval","isSwapAllowed","hasOutdatedUi","maxAmount","maxAmountFormatted","maxAmountFormattedFree","fromAmount","convertedAmount","convertedAmountFormatted","nextLeverage","liquidationPrice","nextLiquidationPrice","isClosing","sizeDelta","nextCollateral","collateralDelta","receiveAmount","convertedReceiveAmount","adjustedDelta","isNotEnoughReceiveTokenLiquidity","isCollateralPoolCapacityExceeded","title","fundingFee","positionFee","swapFeeToken","swapFee","totalFees","executionFee","executionFeeUsd","size","lt","collateral","length","residualSize","abs","add","deductions","feeBasisPoints","overridePrice","collateralInfo","receiveTokenInfo","usdgFromAmount","nextUsdgAmount","entryFundingRate","cumulativeFundingRate","includeDelta","averagePrice","deltaStr","deltaPercentageStr","pendingDelta","pendingDeltaPercentage","pendingDeltaAfterFees","deltaPercentageAfterFees","hasProfitAfterFees","getError","lte","gte","profitPrice","hasPendingProfit","isPrimaryEnabled","error","getPrimaryText","resetForm","onClickPrimary","sentMsg","failMsg","collateralTokenAddress","indexTokenAddress","successMsg","then","finally","priceBasisPoints","refPrice","minPrice","priceLimit","minProfitExpiration","lastIncreasedTime","minProfitTimeExpired","parseInt","Date","now","tokenAddress0","path","isSwap","withdrawETH","params","contract","Contract","abi","getSigner","res","nextSize","key","updatedAt","pendingChanges","renderExistingOrderWarning","sizeInToken","triggerPrice","prefix","renderMinProfitWarning","triggerPricePrefix","shouldShowExistingOrderWarning","trackClosePosition","stage","eventName","nextCollateralValue","leverage","nextLeverageValue","liqPrice","nextLiqPriceValue","amountToPay","allowedSlippageValue","entryPrice","exitPrice","borrowFeeValue","closingFee","amountToReceiveUsd","amountToReceive","userBalances","tokenPrices","poolBalances","traits","actionType","transactionType","keepOriginalLeverage","upToOnePercentSlippageEnabled","nextLiqPrice","borrowFee","pnlActual","pnlPercentage","tokenToReceive","err","console","e","warning","tokenOptionInfo","convertedTokenAmount","isNotEnoughLiquidity","disabled","message"],"sources":["C:/Users/rober/Documents/swaps-client/src/components/Exchange/PositionSeller.js"],"sourcesContent":["import React, { useState, useCallback, useEffect, useMemo } from \"react\";\nimport useSWR from \"swr\";\nimport { ethers } from \"ethers\";\nimport cx from \"classnames\";\n\nimport { BsArrowRight } from \"react-icons/bs\";\n\nimport {\n  CLOSE_POSITION_RECEIVE_TOKEN_KEY,\n  SLIPPAGE_BPS_KEY\n} from '../../config/localstorage';\n\nimport {\n  formatAmount,\n  bigNumberify,\n  DEFAULT_SLIPPAGE_AMOUNT,\n  DEFAULT_HIGHER_SLIPPAGE_AMOUNT,\n  USD_DECIMALS,\n  DUST_USD,\n  BASIS_POINTS_DIVISOR,\n  TRIGGER_PREFIX_BELOW,\n  TRIGGER_PREFIX_ABOVE,\n  MIN_PROFIT_TIME,\n  fetcher,\n  usePrevious,\n  formatAmountFree,\n  parseValue,\n  expandDecimals,\n  getTokenInfo,\n  getLiquidationPrice,\n  getLeverage,\n  getMarginFee,\n  PRECISION,\n  MARKET,\n  STOP,\n  DECREASE,\n  LIMIT,\n  useLocalStorageSerializeKey,\n  calculatePositionDelta,\n  getDeltaStr,\n  getProfitPrice,\n  formatDateTime,\n  getTimeRemaining,\n  getUserTokenBalances,\n  USDG_DECIMALS,\n  useLocalStorageByChainId,\n  getNextToAmount,\n  adjustForDecimals,\n  getDeltaAfterFees,\n} from \"../../Helpers\";\nimport { getAnalyticsEventStage } from \"../../utils/analytics\";\n\nimport \"./PositionSeller.css\";\nimport { getConstant } from \"../../Constants\";\nimport { createDecreaseOrder, callContract, useHasOutdatedUi } from \"../../Api\";\nimport { getContract } from \"../../Addresses\";\nimport PositionRouter from \"../../abis/PositionRouter.json\";\nimport Checkbox from \"../Checkbox/Checkbox\";\nimport Tab from \"../Tab/Tab\";\nimport Modal from \"../Modal/Modal\";\nimport ExchangeInfoRow from \"./ExchangeInfoRow\";\nimport Tooltip from \"../Tooltip/Tooltip\";\nimport TooltipRow from \"../Tooltip/TooltipRow\";\nimport { getTokens } from \"../../data/Tokens\";\nimport TokenSelector from \"./TokenSelector\";\nimport { getTokenAmountFromUsd, getUsd } from \"../../utils/tokens\";\nimport { convertStringToFloat } from \"../../utils/common\";\n\nconst { AddressZero } = ethers.constants;\nconst ORDER_SIZE_DUST_USD = expandDecimals(1, USD_DECIMALS - 1); // $0.10\n\nconst orderOptionLabels = {\n  [MARKET]: \"Market\",\n  [STOP]: \"Trigger\",\n};\n\nfunction shouldSwap(collateralToken, receiveToken) {\n  // If position collateral is WETH in contract, then position.collateralToken is { symbol: “ETH”, isNative: true, … }\n  // @see https://github.com/mycelium-ethereum/swaps-client/blob/master/src/pages/Exchange/Exchange.js#L162\n  // meaning if collateralToken.isNative === true in reality position has WETH as a collateral\n  // and if collateralToken.isNative === true and receiveToken.isNative === true then position’s WETH will be unwrapped and user will receive native ETH\n  const isCollateralWrapped = collateralToken.isNative;\n\n  const isSameToken =\n    collateralToken.address === receiveToken.address || (isCollateralWrapped && receiveToken.isWrapped);\n\n  const isUnwrap = isCollateralWrapped && receiveToken.isNative;\n\n  return !isSameToken && !isUnwrap;\n}\n\nfunction getSwapLimits(infoTokens, fromTokenAddress, toTokenAddress) {\n  const fromInfo = getTokenInfo(infoTokens, fromTokenAddress);\n  const toInfo = getTokenInfo(infoTokens, toTokenAddress);\n\n  let maxInUsd;\n  let maxIn;\n  let maxOut;\n  let maxOutUsd;\n\n  if (!fromInfo?.maxUsdgAmount) {\n    maxInUsd = bigNumberify(0);\n    maxIn = bigNumberify(0);\n  } else {\n    maxInUsd = fromInfo.maxUsdgAmount\n      .sub(fromInfo.usdgAmount)\n      .mul(expandDecimals(1, USD_DECIMALS))\n      .div(expandDecimals(1, USDG_DECIMALS));\n\n    maxIn = maxInUsd.mul(expandDecimals(1, fromInfo.decimals)).div(fromInfo.maxPrice).toString();\n  }\n\n  if (!toInfo?.poolAmount || !toInfo?.bufferAmount) {\n    maxOut = bigNumberify(0);\n    maxOutUsd = bigNumberify(0);\n  } else {\n    maxOut = toInfo.availableAmount.gt(toInfo.poolAmount.sub(toInfo.bufferAmount))\n      ? toInfo.poolAmount.sub(toInfo.bufferAmount)\n      : toInfo.availableAmount;\n\n    maxOutUsd = getUsd(maxOut, toInfo.address, false, infoTokens);\n  }\n\n  return {\n    maxIn,\n    maxInUsd,\n    maxOut,\n    maxOutUsd,\n  };\n}\n\nconst orderOptions = [MARKET, STOP];\n\nexport default function PositionSeller(props) {\n  const {\n    active,\n    pendingPositions,\n    setPendingPositions,\n    positionsMap,\n    positionKey,\n    isVisible,\n    setIsVisible,\n    account,\n    library,\n    infoTokens,\n    setPendingTxns,\n    flagOrdersEnabled,\n    savedIsPnlInLeverage,\n    chainId,\n    nativeTokenAddress,\n    orders,\n    isWaitingForPluginApproval,\n    isPluginApproving,\n    orderBookApproved,\n    setOrdersToaOpen,\n    positionRouterApproved,\n    isWaitingForPositionRouterApproval,\n    isPositionRouterApproving,\n    approvePositionRouter,\n    isHigherSlippageAllowed,\n    setIsHigherSlippageAllowed,\n    trackAction,\n    usdgSupply,\n    totalTokenWeights,\n    showPnlAfterFees\n  } = props;\n  const [savedSlippageAmount] = useLocalStorageSerializeKey([chainId, SLIPPAGE_BPS_KEY], DEFAULT_SLIPPAGE_AMOUNT);\n  const [keepLeverage, setKeepLeverage] = useLocalStorageSerializeKey([chainId, \"Exchange-keep-leverage\"], true);\n  const position = positionsMap && positionKey ? positionsMap[positionKey] : undefined;\n  const [fromValue, setFromValue] = useState(\"\");\n  const [isProfitWarningAccepted, setIsProfitWarningAccepted] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const prevIsVisible = usePrevious(isVisible);\n  const positionRouterAddress = getContract(chainId, \"PositionRouter\");\n  const nativeTokenSymbol = getConstant(chainId, \"nativeTokenSymbol\");\n  const toTokens = getTokens(chainId);\n\n  const [savedReceiveTokenAddress, setSavedReceiveTokenAddress] = useLocalStorageByChainId(\n    chainId,\n    `${CLOSE_POSITION_RECEIVE_TOKEN_KEY}-${position?.indexToken?.symbol}-${position.isLong ? \"long\" : \"short\"}`\n  );\n\n  const [swapToToken, setSwapToToken] = useState(() =>\n    savedReceiveTokenAddress ? toTokens.find((token) => token.address === savedReceiveTokenAddress) : undefined\n  );\n\n  let allowedSlippage = savedSlippageAmount;\n  if (isHigherSlippageAllowed) {\n    allowedSlippage = DEFAULT_HIGHER_SLIPPAGE_AMOUNT;\n  }\n\n  const { data: minExecutionFee } = useSWR([active, chainId, positionRouterAddress, \"minExecutionFee\"], {\n    fetcher: fetcher(library, PositionRouter),\n  });\n\n\n  let [orderOption, setOrderOption] = useState(MARKET);\n\n  if (!flagOrdersEnabled) {\n    orderOption = MARKET;\n  }\n\n  const needPositionRouterApproval = !positionRouterApproved && orderOption === MARKET;\n\n  const onOrderOptionChange = (option) => {\n    // disabled limit close\n    if (typeof option === \"string\" && option !== LIMIT) {\n      setOrderOption(option);\n    }\n  };\n\n  const onTriggerPriceChange = (evt) => {\n    setTriggerPriceValue(evt.target.value || \"\");\n  };\n  const [triggerPriceValue, setTriggerPriceValue] = useState(\"\");\n  const triggerPriceUsd = orderOption === MARKET ? 0 : parseValue(triggerPriceValue, USD_DECIMALS);\n\n  const [nextDelta, nextHasProfit = bigNumberify(0)] = useMemo(() => {\n    if (!position) {\n      return [bigNumberify(0), false];\n    }\n\n    if (orderOption !== STOP) {\n      return [position.delta, position.hasProfit, position.deltaPercentage];\n    }\n\n    if (!triggerPriceUsd) {\n      return [bigNumberify(0), false];\n    }\n\n    const { delta, hasProfit, deltaPercentage } = calculatePositionDelta(triggerPriceUsd, position);\n    return [delta, hasProfit, deltaPercentage];\n  }, [position, orderOption, triggerPriceUsd]);\n\n  const existingOrders = useMemo(() => {\n    if (orderOption === STOP && (!triggerPriceUsd || triggerPriceUsd.eq(0))) {\n      return [];\n    }\n    if (!orders || !position) {\n      return [];\n    }\n\n    const ret = [];\n    for (const order of orders) {\n      // only Stop orders can't be executed without corresponding opened position\n      if (order.type !== DECREASE) continue;\n\n      // if user creates Stop-Loss we need only Stop-Loss orders and vice versa\n      if (orderOption === STOP) {\n        const triggerAboveThreshold = triggerPriceUsd.gt(position.markPrice);\n        if (triggerAboveThreshold !== order.triggerAboveThreshold) continue;\n      }\n\n      const sameToken =\n        order.indexToken === nativeTokenAddress\n          ? position.indexToken.isNative\n          : order.indexToken === position.indexToken.address;\n      if (order.isLong === position.isLong && sameToken) {\n        ret.push(order);\n      }\n    }\n    return ret;\n  }, [position, orders, triggerPriceUsd, orderOption, nativeTokenAddress]);\n\n  const existingOrder = existingOrders[0];\n\n\n\n  const needOrderBookApproval = orderOption === STOP && !orderBookApproved;\n\n  const isSwapAllowed = orderOption === MARKET;\n\n  const { data: hasOutdatedUi } = useHasOutdatedUi();\n\n  let collateralToken;\n  let receiveToken;\n  let maxAmount;\n  let maxAmountFormatted;\n  let maxAmountFormattedFree;\n  let fromAmount;\n\n  let convertedAmount;\n  let convertedAmountFormatted;\n\n  let nextLeverage;\n  let liquidationPrice;\n  let nextLiquidationPrice;\n  let isClosing;\n  let sizeDelta;\n\n  let nextCollateral;\n  let collateralDelta = bigNumberify(0);\n  let receiveAmount = bigNumberify(0);\n  let convertedReceiveAmount = bigNumberify(0);\n  let adjustedDelta = bigNumberify(0);\n\n  let isNotEnoughReceiveTokenLiquidity;\n  let isCollateralPoolCapacityExceeded;\n\n  let title;\n  let fundingFee;\n  let positionFee;\n  let swapFeeToken;\n  let swapFee;\n  let totalFees = bigNumberify(0);\n\n  let executionFee = orderOption === STOP ? getConstant(chainId, \"DECREASE_ORDER_EXECUTION_GAS_FEE\") : minExecutionFee;\n\n  let executionFeeUsd = getUsd(executionFee, nativeTokenAddress, false, infoTokens) || bigNumberify(0);\n\n  if (position) {\n    fundingFee = position.fundingFee;\n    fromAmount = parseValue(fromValue, USD_DECIMALS);\n    sizeDelta = fromAmount;\n\n    title = `Close ${position.isLong ? \"Long\" : \"Short\"} ${position.indexToken.symbol}`;\n    collateralToken = position.collateralToken;\n    liquidationPrice = getLiquidationPrice(position);\n\n    if (fromAmount) {\n      isClosing = position.size.sub(fromAmount).lt(DUST_USD);\n      positionFee = getMarginFee(fromAmount);\n    }\n\n    if (isClosing) {\n      sizeDelta = position.size;\n      receiveAmount = position.collateral;\n    } else if (orderOption === STOP && sizeDelta && existingOrders.length > 0) {\n      let residualSize = position.size;\n      for (const order of existingOrders) {\n        residualSize = residualSize.sub(order.sizeDelta);\n      }\n      if (residualSize.sub(sizeDelta).abs().lt(ORDER_SIZE_DUST_USD)) {\n        sizeDelta = residualSize;\n      }\n    }\n\n    if (sizeDelta) {\n      adjustedDelta = nextDelta.mul(sizeDelta).div(position.size);\n    }\n\n    if (nextHasProfit) {\n      receiveAmount = receiveAmount.add(adjustedDelta);\n    } else {\n      if (receiveAmount.gt(adjustedDelta)) {\n        receiveAmount = receiveAmount.sub(adjustedDelta);\n      } else {\n        receiveAmount = bigNumberify(0);\n      }\n    }\n\n    if (keepLeverage && sizeDelta && !isClosing) {\n      collateralDelta = sizeDelta.mul(position.collateral).div(position.size);\n      // if the position will be realising a loss then reduce collateralDelta by the realised loss\n      if (!nextHasProfit) {\n        const deductions = adjustedDelta.add(positionFee).add(fundingFee);\n        if (collateralDelta.gt(deductions)) {\n          collateralDelta = collateralDelta = collateralDelta.sub(deductions);\n        } else {\n          collateralDelta = bigNumberify(0);\n        }\n      }\n    }\n\n    maxAmount = position.size;\n    maxAmountFormatted = formatAmount(maxAmount, USD_DECIMALS, 2, true);\n    maxAmountFormattedFree = formatAmountFree(maxAmount, USD_DECIMALS, 2);\n\n    if (fromAmount && collateralToken.maxPrice) {\n      convertedAmount = fromAmount.mul(expandDecimals(1, collateralToken.decimals)).div(collateralToken.maxPrice);\n      convertedAmountFormatted = formatAmount(convertedAmount, collateralToken.decimals, 4, true);\n    }\n\n    totalFees = totalFees.add(positionFee || bigNumberify(0)).add(fundingFee || bigNumberify(0));\n\n    receiveAmount = receiveAmount.add(collateralDelta);\n\n    if (sizeDelta) {\n      if (receiveAmount.gt(totalFees)) {\n        receiveAmount = receiveAmount.sub(totalFees);\n      } else {\n        receiveAmount = bigNumberify(0);\n      }\n    }\n\n    receiveToken = isSwapAllowed && swapToToken ? swapToToken : collateralToken;\n\n    // Calculate swap fees\n    if (isSwapAllowed && swapToToken) {\n      const { feeBasisPoints } = getNextToAmount(\n        chainId,\n        convertedAmount,\n        collateralToken.address,\n        receiveToken.address,\n        infoTokens,\n        undefined,\n        undefined,\n        usdgSupply,\n        totalTokenWeights,\n        true\n      );\n\n      if (feeBasisPoints) {\n        swapFee = receiveAmount.mul(feeBasisPoints).div(BASIS_POINTS_DIVISOR);\n        swapFeeToken = getTokenAmountFromUsd(infoTokens, collateralToken.address, swapFee);\n        totalFees = totalFees.add(swapFee || bigNumberify(0));\n        receiveAmount = receiveAmount.sub(swapFee);\n      }\n    }\n\n    if (orderOption === STOP) {\n      convertedReceiveAmount = getTokenAmountFromUsd(infoTokens, receiveToken.address, receiveAmount, {\n        overridePrice: triggerPriceUsd,\n      });\n    } else {\n      convertedReceiveAmount = getTokenAmountFromUsd(infoTokens, receiveToken.address, receiveAmount);\n    }\n\n    // Check swap limits (max in / max out)\n    if (isSwapAllowed && shouldSwap(collateralToken, receiveToken)) {\n      const collateralInfo = getTokenInfo(infoTokens, collateralToken.address);\n      const receiveTokenInfo = getTokenInfo(infoTokens, receiveToken.address);\n\n      isNotEnoughReceiveTokenLiquidity =\n        receiveTokenInfo.availableAmount.lt(convertedReceiveAmount) ||\n        receiveTokenInfo.bufferAmount.gt(receiveTokenInfo.poolAmount.sub(convertedReceiveAmount));\n\n      if (\n        collateralInfo.maxUsdgAmount &&\n        collateralInfo.maxUsdgAmount.gt(0) &&\n        collateralInfo.usdgAmount &&\n        collateralInfo.maxPrice\n      ) {\n        const usdgFromAmount = adjustForDecimals(receiveAmount, USD_DECIMALS, USDG_DECIMALS);\n        const nextUsdgAmount = collateralInfo.usdgAmount.add(usdgFromAmount);\n\n        if (nextUsdgAmount.gt(collateralInfo.maxUsdgAmount)) {\n          isCollateralPoolCapacityExceeded = true;\n        }\n      }\n    }\n\n    if (isClosing) {\n      nextCollateral = bigNumberify(0);\n    } else {\n      if (position.collateral) {\n        nextCollateral = position.collateral;\n        if (collateralDelta && collateralDelta.gt(0)) {\n          nextCollateral = position.collateral.sub(collateralDelta);\n        } else if (position.delta && position.delta.gt(0) && sizeDelta) {\n          if (!position.hasProfit) {\n            nextCollateral = nextCollateral.sub(adjustedDelta);\n          }\n        }\n      }\n    }\n\n    if (fromAmount) {\n      if (!isClosing && !keepLeverage) {\n        nextLeverage = getLeverage({\n          size: position.size,\n          sizeDelta,\n          collateral: position.collateral,\n          entryFundingRate: position.entryFundingRate,\n          cumulativeFundingRate: position.cumulativeFundingRate,\n          hasProfit: nextHasProfit,\n          delta: nextDelta,\n          includeDelta: savedIsPnlInLeverage,\n        });\n        nextLiquidationPrice = getLiquidationPrice({\n          isLong: position.isLong,\n          size: position.size,\n          sizeDelta,\n          collateral: position.collateral,\n          averagePrice: position.averagePrice,\n          entryFundingRate: position.entryFundingRate,\n          cumulativeFundingRate: position.cumulativeFundingRate,\n          delta: nextDelta,\n          hasProfit: nextHasProfit,\n          includeDelta: true,\n        });\n      }\n    }\n  }\n\n  const [deltaStr, deltaPercentageStr] = useMemo(() => {\n    let pendingDelta, pendingDeltaPercentage, hasProfit;\n    if (!position || !position.markPrice) {\n      return [\"-\", \"-\"];\n    } else if (orderOption !== STOP) {\n      ({ pendingDelta, pendingDeltaPercentage, hasProfit } = calculatePositionDelta(\n        position.markPrice,\n        position,\n        fromAmount\n      ));\n    } else if (!triggerPriceUsd || triggerPriceUsd.eq(0)) {\n      return [\"-\", \"-\"];\n    } else {\n      ({ pendingDelta, pendingDeltaPercentage, hasProfit } = calculatePositionDelta(\n        triggerPriceUsd,\n        position,\n        fromAmount\n      ));\n    }\n\n    let deltaStr, deltaPercentageStr;\n    if (showPnlAfterFees) {\n      const { pendingDeltaAfterFees, deltaPercentageAfterFees, hasProfitAfterFees } = getDeltaAfterFees({\n        delta: pendingDelta,\n        totalFees: position.totalFees,\n        hasProfit,\n        collateral: position.collateral\n      })\n      if (!pendingDeltaAfterFees) {\n        return ['-', '-']\n      }\n      ({ deltaStr, deltaPercentageStr } = getDeltaStr({\n        delta: pendingDeltaAfterFees,\n        deltaPercentage: deltaPercentageAfterFees,\n        hasProfit: hasProfitAfterFees,\n      }));\n    } else {\n      ({ deltaStr, deltaPercentageStr } = getDeltaStr({\n        delta: pendingDelta,\n        deltaPercentage: pendingDeltaPercentage,\n        hasProfit,\n      }));\n    }\n    return [deltaStr, deltaPercentageStr];\n  }, [position, triggerPriceUsd, orderOption, fromAmount]);\n\n  const getError = () => {\n    if (hasOutdatedUi) {\n      return \"Page outdated, please refresh\";\n    }\n    if (!fromAmount) {\n      return \"Enter an amount\";\n    }\n    if (nextLeverage && nextLeverage.eq(0)) {\n      return \"Enter an amount\";\n    }\n    if (orderOption === STOP) {\n      if (!triggerPriceUsd || triggerPriceUsd.eq(0)) {\n        return \"Enter Price\";\n      }\n      if (position.isLong && triggerPriceUsd.lte(liquidationPrice)) {\n        return \"Price below Liq. Price\";\n      }\n      if (!position.isLong && triggerPriceUsd.gte(liquidationPrice)) {\n        return \"Price above Liq. Price\";\n      }\n\n      if (profitPrice && nextDelta.eq(0) && nextHasProfit) {\n        return \"Invalid price, see warning\";\n      }\n    }\n\n    if (!isClosing && position && position.size && fromAmount) {\n      if (position.size.sub(fromAmount).lt(expandDecimals(10, USD_DECIMALS))) {\n        return \"Leftover position below 10 USD\";\n      }\n    }\n\n    if (position && position.size && position.size.lt(fromAmount)) {\n      return \"Max close amount exceeded\";\n    }\n\n    if (nextLeverage && nextLeverage.lt(1.1 * BASIS_POINTS_DIVISOR)) {\n      return \"Min leverage: 1.1x\";\n    }\n\n    if (nextLeverage && nextLeverage.gt(30.5 * BASIS_POINTS_DIVISOR)) {\n      return \"Max leverage: 30.5x\";\n    }\n\n    if (hasPendingProfit && orderOption !== STOP && !isProfitWarningAccepted) {\n      return \"Forfeit profit not checked\";\n    }\n  };\n\n  const isPrimaryEnabled = () => {\n    const error = getError();\n    if (error) {\n      return false;\n    }\n    if (isSubmitting) {\n      return false;\n    }\n    if (needOrderBookApproval && isWaitingForPluginApproval) {\n      return false;\n    }\n    if (isPluginApproving) {\n      return false;\n    }\n    if (needPositionRouterApproval && isWaitingForPositionRouterApproval) {\n      return false;\n    }\n    if (isPositionRouterApproving) {\n      return false;\n    }\n\n    return true;\n  };\n\n  const hasPendingProfit = MIN_PROFIT_TIME > 0 && position.delta.eq(0) && position.pendingDelta.gt(0);\n\n  const getPrimaryText = () => {\n    const error = getError();\n    if (error) {\n      return error;\n    }\n\n    if (orderOption === STOP) {\n      if (isSubmitting) return \"Creating Order...\";\n\n      if (needOrderBookApproval && isWaitingForPluginApproval) {\n        return \"Enabling Orders...\";\n      }\n      if (isPluginApproving) {\n        return \"Enabling Orders...\";\n      }\n      if (needOrderBookApproval) {\n        return \"Enable Orders\";\n      }\n\n      return \"Create Order\";\n    }\n\n    if (needPositionRouterApproval && isWaitingForPositionRouterApproval) {\n      return \"Enabling Leverage...\";\n    }\n\n    if (isPositionRouterApproving) {\n      return \"Enabling Leverage...\";\n    }\n\n    if (needPositionRouterApproval) {\n      return \"Enable Leverage\";\n    }\n\n    if (hasPendingProfit) {\n      return \"Close without profit\";\n    }\n    return isSubmitting ? \"Closing...\" : \"Close\";\n  };\n\n  const resetForm = () => {\n    setFromValue(\"\");\n    setIsProfitWarningAccepted(false);\n  };\n\n  useEffect(() => {\n    if (prevIsVisible !== isVisible) {\n      resetForm();\n    }\n  }, [prevIsVisible, isVisible]);\n\n  const onClickPrimary = async () => {\n    if (needOrderBookApproval) {\n      setOrdersToaOpen(true);\n      return;\n    }\n\n    if (needPositionRouterApproval) {\n      approvePositionRouter({\n        sentMsg: `Enable leverage sent.`,\n        failMsg: `Enable leverage failed.`,\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    const collateralTokenAddress = position.collateralToken.isNative\n      ? nativeTokenAddress\n      : position.collateralToken.address;\n    const indexTokenAddress = position.indexToken.isNative ? nativeTokenAddress : position.indexToken.address;\n\n    if (orderOption === STOP) {\n      const triggerAboveThreshold = triggerPriceUsd.gt(position.markPrice);\n\n      createDecreaseOrder(\n        chainId,\n        library,\n        indexTokenAddress,\n        sizeDelta,\n        collateralTokenAddress,\n        collateralDelta,\n        position.isLong,\n        triggerPriceUsd,\n        triggerAboveThreshold,\n        {\n          sentMsg: `Order submitted!`,\n          successMsg: `Order created!`,\n          failMsg: `Order creation failed.`,\n          setPendingTxns,\n        }\n      )\n        .then(() => {\n          setFromValue(\"\");\n          setIsVisible(false);\n        })\n        .finally(() => {\n          setIsSubmitting(false);\n        });\n      return;\n    }\n\n    const priceBasisPoints = position.isLong\n      ? BASIS_POINTS_DIVISOR - allowedSlippage\n      : BASIS_POINTS_DIVISOR + allowedSlippage;\n    const refPrice = position.isLong ? position.indexToken.minPrice : position.indexToken.maxPrice;\n    let priceLimit = refPrice.mul(priceBasisPoints).div(BASIS_POINTS_DIVISOR);\n    const minProfitExpiration = position.lastIncreasedTime + MIN_PROFIT_TIME;\n    const minProfitTimeExpired = parseInt(Date.now() / 1000) > minProfitExpiration;\n\n    if (nextHasProfit && !minProfitTimeExpired && !isProfitWarningAccepted) {\n      if ((position.isLong && priceLimit.lt(profitPrice)) || (!position.isLong && priceLimit.gt(profitPrice))) {\n        priceLimit = profitPrice;\n      }\n    }\n\n    const tokenAddress0 = collateralTokenAddress === AddressZero ? nativeTokenAddress : collateralTokenAddress;\n\n    const path = [tokenAddress0];\n\n    const isUnwrap = receiveToken.address === AddressZero;\n    const isSwap = receiveToken.address !== tokenAddress0;\n\n    if (isSwap) {\n      if (isUnwrap && tokenAddress0 !== nativeTokenAddress) {\n        path.push(nativeTokenAddress);\n      } else if (!isUnwrap) {\n        path.push(receiveToken.address);\n      }\n    }\n\n    const withdrawETH = isUnwrap;\n\n    const params = [\n      path, // _path\n      indexTokenAddress, // _indexToken\n      collateralDelta, // _collateralDelta\n      sizeDelta, // _sizeDelta\n      position.isLong, // _isLong\n      account, // _receiver\n      priceLimit, // _acceptablePrice\n      0, // _minOut\n      minExecutionFee, // _executionFee\n      withdrawETH, // _withdrawETH\n    ];\n\n    const successMsg = `Requested decrease of ${position.indexToken.symbol} ${\n      position.isLong ? \"Long\" : \"Short\"\n    } by ${formatAmount(sizeDelta, USD_DECIMALS, 2)} USD.`;\n\n    const contract = new ethers.Contract(positionRouterAddress, PositionRouter.abi, library.getSigner());\n\n    callContract(chainId, contract, \"createDecreasePosition\", params, {\n      value: minExecutionFee,\n      sentMsg: `Close submitted!`,\n      successMsg,\n      failMsg: `Close failed.`,\n      setPendingTxns,\n    })\n      .then(async (res) => {\n        setFromValue(\"\");\n        setIsVisible(false);\n\n        let nextSize = position.size.sub(sizeDelta);\n\n        pendingPositions[position.key] = {\n          updatedAt: Date.now(),\n          pendingChanges: {\n            size: nextSize,\n          },\n        };\n\n        setPendingPositions({ ...pendingPositions });\n      })\n      .finally(() => {\n        setIsSubmitting(false);\n      });\n  };\n\n  const renderExistingOrderWarning = useCallback(() => {\n    if (!existingOrder) {\n      return;\n    }\n    const indexToken = getTokenInfo(infoTokens, existingOrder.indexToken);\n    const sizeInToken = formatAmount(\n      existingOrder.sizeDelta.mul(PRECISION).div(existingOrder.triggerPrice),\n      USD_DECIMALS,\n      4,\n      true\n    );\n    const prefix = existingOrder.triggerAboveThreshold ? TRIGGER_PREFIX_ABOVE : TRIGGER_PREFIX_BELOW;\n    return (\n      <div className=\"Confirmation-box-warning\">\n        You have an active order to decrease {existingOrder.isLong ? \"Long\" : \"Short\"} {sizeInToken} {indexToken.symbol}{\" \"}\n        ($\n        {formatAmount(existingOrder.sizeDelta, USD_DECIMALS, 2, true)}) at {prefix}{\" \"}\n        {formatAmount(existingOrder.triggerPrice, USD_DECIMALS, 2, true)}\n      </div>\n    );\n  }, [existingOrder, infoTokens]);\n\n  function renderMinProfitWarning() {\n    if (MIN_PROFIT_TIME === 0) {\n      return null;\n    }\n\n    if (profitPrice && nextDelta.eq(0) && nextHasProfit) {\n      const minProfitExpiration = position.lastIncreasedTime + MIN_PROFIT_TIME;\n\n      if (orderOption === MARKET) {\n        return (\n          <div className=\"Confirmation-box-warning\">\n            Reducing the position at the current price will forfeit a pending profit of {deltaStr}. <br />\n            <br />\n            Profit price: {position.isLong ? \">\" : \"<\"} ${formatAmount(profitPrice, USD_DECIMALS, 2, true)}. This rule\n            applies for the next {getTimeRemaining(minProfitExpiration)}, until {formatDateTime(minProfitExpiration)}.\n          </div>\n        );\n      }\n      return (\n        <div className=\"Confirmation-box-warning\">\n          This order will forfeit a profit of {deltaStr}. <br />\n          Profit price: {position.isLong ? \">\" : \"<\"} ${formatAmount(profitPrice, USD_DECIMALS, 2, true)}. This rule\n          applies for the next {getTimeRemaining(minProfitExpiration)}, until {formatDateTime(minProfitExpiration)}.\n        </div>\n      );\n    }\n  }\n\n  const profitPrice = getProfitPrice(orderOption === MARKET ? position.markPrice : triggerPriceUsd, position);\n\n  let triggerPricePrefix;\n  if (triggerPriceUsd) {\n    triggerPricePrefix = triggerPriceUsd.gt(position.markPrice) ? TRIGGER_PREFIX_ABOVE : TRIGGER_PREFIX_BELOW;\n  }\n\n  const shouldShowExistingOrderWarning = false;\n\n  const trackClosePosition = (stage) => {\n    const eventName = getAnalyticsEventStage(stage);\n    try {\n      const size = convertStringToFloat(formatAmount(position.size, USD_DECIMALS, 2, true));\n      const collateral = convertStringToFloat(formatAmount(position.collateral, USD_DECIMALS, 2, true));\n      const nextCollateralValue = nextCollateral\n        ? convertStringToFloat(formatAmount(nextCollateral, USD_DECIMALS, 2, true))\n        : 0;\n      const leverage = convertStringToFloat(formatAmount(position.leverage, 4, 2, true));\n      const nextLeverageValue = nextLeverage ? convertStringToFloat(formatAmount(nextLeverage, 4, 2, true)) : 0;\n      const liqPrice = convertStringToFloat(formatAmount(liquidationPrice, USD_DECIMALS, 2, true));\n      const nextLiqPriceValue = nextLiquidationPrice\n        ? convertStringToFloat(formatAmount(nextLiquidationPrice, USD_DECIMALS, 2, true))\n        : 0;\n      const amountToPay = convertedAmountFormatted;\n      const allowedSlippageValue = convertStringToFloat(formatAmount(allowedSlippage, 2, 2));\n      const entryPrice = convertStringToFloat(formatAmount(position.averagePrice, USD_DECIMALS, 2, true));\n      const exitPrice = convertStringToFloat(formatAmount(position.markPrice, USD_DECIMALS, 2, true));\n      const borrowFeeValue = convertStringToFloat(formatAmount(fundingFee, USD_DECIMALS, 2, true));\n      const closingFee = convertStringToFloat(formatAmount(positionFee, USD_DECIMALS, 2, true));\n      const amountToReceiveUsd = convertStringToFloat(formatAmount(receiveAmount, USD_DECIMALS, 2, true));\n      const amountToReceive = convertStringToFloat(\n        formatAmount(convertedReceiveAmount, position.collateralToken.decimals, 4, true)\n      );\n      const [userBalances, tokenPrices, poolBalances] = getUserTokenBalances(infoTokens);\n\n      const traits = {\n        actionType: \"Close\",\n        position: position.isLong ? \"Long\" : \"Short\",\n        transactionType: orderOption === MARKET ? \"Market\" : \"Trigger\",\n        size: size,\n        collateral: collateral,\n        nextCollateral: nextCollateralValue,\n        leverage: leverage,\n        nextLeverage: nextLeverageValue,\n        keepOriginalLeverage: keepLeverage,\n        upToOnePercentSlippageEnabled: isHigherSlippageAllowed,\n        liqPrice: liqPrice,\n        nextLiqPrice: nextLiqPriceValue,\n        amountToPay: amountToPay,\n        allowedSlippage: allowedSlippageValue,\n        entryPrice: entryPrice,\n        exitPrice: exitPrice,\n        borrowFee: borrowFeeValue,\n        closingFee: closingFee,\n        pnlActual: deltaStr,\n        pnlPercentage: deltaPercentageStr,\n        amountToReceiveUsd: amountToReceiveUsd,\n        amountToReceive: amountToReceive,\n        tokenToReceive: position.collateralToken.symbol,\n        ...userBalances,\n        ...tokenPrices,\n        ...poolBalances,\n      };\n      trackAction && trackAction(eventName, traits);\n    } catch (err) {\n      console.error(`Unable to track ${eventName} event`, err);\n    }\n  };\n\n  return (\n    <div className=\"PositionEditor\">\n      {position && (\n        <Modal isVisible={isVisible} setIsVisible={setIsVisible} label={title}>\n          {flagOrdersEnabled && (\n            <Tab\n              options={orderOptions}\n              option={orderOption}\n              optionLabels={orderOptionLabels}\n              onChange={onOrderOptionChange}\n            />\n          )}\n          <div className=\"Exchange-swap-section\">\n            <div className=\"Exchange-swap-section-top\">\n              <div className=\"muted\">\n                {convertedAmountFormatted && (\n                  <div className=\"Exchange-swap-usd\">\n                    Close: {convertedAmountFormatted} {position.collateralToken.symbol}\n                  </div>\n                )}\n                {!convertedAmountFormatted && \"Close\"}\n              </div>\n              {maxAmount && (\n                <div className=\"muted align-right clickable\" onClick={() => setFromValue(maxAmountFormattedFree)}>\n                  Max: {maxAmountFormatted}\n                </div>\n              )}\n            </div>\n            <div className=\"Exchange-swap-section-bottom\">\n              <div className=\"Exchange-swap-input-container\">\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  placeholder=\"0.0\"\n                  className=\"Exchange-swap-input\"\n                  value={fromValue}\n                  onChange={(e) => setFromValue(e.target.value)}\n                />\n                {fromValue !== maxAmountFormattedFree && (\n                  <div\n                    className=\"Exchange-swap-max\"\n                    onClick={() => {\n                      setFromValue(maxAmountFormattedFree);\n                    }}\n                  >\n                    MAX\n                  </div>\n                )}\n              </div>\n              <div className=\"PositionEditor-token-symbol\">USD</div>\n            </div>\n          </div>\n          {orderOption === STOP && (\n            <div className=\"Exchange-swap-section\">\n              <div className=\"Exchange-swap-section-top\">\n                <div className=\"muted\">Price</div>\n                <div\n                  className=\"muted align-right clickable\"\n                  onClick={() => {\n                    setTriggerPriceValue(formatAmountFree(position.markPrice, USD_DECIMALS, 2));\n                  }}\n                >\n                  Mark: {formatAmount(position.markPrice, USD_DECIMALS, 2, true)}\n                </div>\n              </div>\n              <div className=\"Exchange-swap-section-bottom\">\n                <div className=\"Exchange-swap-input-container\">\n                  <input\n                    type=\"number\"\n                    min=\"0\"\n                    placeholder=\"0.0\"\n                    className=\"Exchange-swap-input\"\n                    value={triggerPriceValue}\n                    onChange={onTriggerPriceChange}\n                  />\n                </div>\n                <div className=\"PositionEditor-token-symbol\">USD</div>\n              </div>\n            </div>\n          )}\n          {renderMinProfitWarning()}\n          {shouldShowExistingOrderWarning && renderExistingOrderWarning()}\n          <div className=\"PositionEditor-info-box\">\n            <div className=\"Exchange-info-row PositionSeller-receive-row bottom-line\">\n              <div className=\"Exchange-info-label\">\n                Receive\n              </div>\n\n              {!isSwapAllowed && receiveToken && (\n                <div className=\"align-right PositionSelector-selected-receive-token\">\n                  {formatAmount(convertedReceiveAmount, receiveToken.decimals, 4, true)}&nbsp;{receiveToken.symbol} ($\n                  {formatAmount(receiveAmount, USD_DECIMALS, 2, true)})\n                </div>\n              )}\n\n              {isSwapAllowed && receiveToken && (\n                <div className=\"align-right\">\n                  <TokenSelector\n                    // Scroll lock lead to side effects\n                    // if it applied on modal inside another modal\n                    disableBodyScrollLock={true}\n                    className={cx(\"PositionSeller-token-selector\", {\n                      warning: isNotEnoughReceiveTokenLiquidity || isCollateralPoolCapacityExceeded,\n                    })}\n                    label={\"Receive\"}\n                    showBalances={false}\n                    chainId={chainId}\n                    tokenAddress={receiveToken.address}\n                    onSelectToken={(token) => {\n                      setSwapToToken(token);\n                      setSavedReceiveTokenAddress(token.address);\n                    }}\n                    tokens={toTokens}\n                    getTokenState={(tokenOptionInfo) => {\n                      if (!shouldSwap(collateralToken, tokenOptionInfo)) {\n                        return;\n                      }\n\n                      const convertedTokenAmount = getTokenAmountFromUsd(\n                        infoTokens,\n                        tokenOptionInfo.address,\n                        receiveAmount\n                      );\n\n                      const isNotEnoughLiquidity =\n                        tokenOptionInfo.availableAmount.lt(convertedTokenAmount) ||\n                        tokenOptionInfo.bufferAmount.gt(tokenOptionInfo.poolAmount.sub(convertedTokenAmount));\n\n                      if (isNotEnoughLiquidity) {\n                        const { maxIn, maxOut, maxInUsd, maxOutUsd } = getSwapLimits(\n                          infoTokens,\n                          collateralToken.address,\n                          tokenOptionInfo.address\n                        );\n\n                        const collateralInfo = getTokenInfo(infoTokens, collateralToken.address);\n\n                        return {\n                          disabled: true,\n                          message: (\n                            <div>\n                              Insufficient Available Liquidity to swap to {tokenOptionInfo.symbol}:\n                              <br />\n                              <br />\n                              <TooltipRow\n                                label={`Max ${collateralInfo.symbol} in`}\n                                value={[\n                                  `${formatAmount(maxIn, collateralInfo.decimals, 0, true)} ${collateralInfo.symbol}`,\n                                  `($${formatAmount(maxInUsd, USD_DECIMALS, 0, true)})`,\n                                ]}\n                              />\n                              <br />\n                              <br />\n                              Max {tokenOptionInfo.symbol} out:{\" \"}\n                              {formatAmount(maxOut, tokenOptionInfo.decimals, 2, true)} {tokenOptionInfo.symbol}\n                              <br />\n                              (${formatAmount(maxOutUsd, USD_DECIMALS, 2, true)})\n                            </div>\n                          ),\n                        };\n                      }\n                    }}\n                    infoTokens={infoTokens}\n                    showTokenImgInDropdown={true}\n                    selectedTokenLabel={\n                      <span className=\"PositionSelector-selected-receive-token\">\n                        {formatAmount(convertedReceiveAmount, receiveToken.decimals, 4, true)}&nbsp;\n                        {receiveToken.symbol} (${formatAmount(receiveAmount, USD_DECIMALS, 2, true)})\n                      </span>\n                    }\n                  />\n                </div>\n              )}\n            </div>\n            {hasPendingProfit && orderOption !== STOP && (\n              <div className=\"PositionEditor-accept-profit-warning\">\n                <Checkbox isChecked={isProfitWarningAccepted} setIsChecked={setIsProfitWarningAccepted}>\n                  <span className=\"muted\">Forfeit profit</span>\n                </Checkbox>\n              </div>\n            )}\n            <div className=\"PositionEditor-keep-leverage-settings\">\n              <Checkbox isChecked={keepLeverage} setIsChecked={setKeepLeverage}>\n                <span className=\"muted\">Keep leverage at {formatAmount(position.leverage, 4, 2)}x</span>\n              </Checkbox>\n            </div>\n            {orderOption === MARKET && (\n              <div className=\"PositionEditor-allow-higher-slippage\">\n                <Checkbox isChecked={isHigherSlippageAllowed} setIsChecked={setIsHigherSlippageAllowed}>\n                  <span className=\"muted\">Allow up to 1% slippage</span>\n                </Checkbox>\n              </div>\n            )}\n            {orderOption === MARKET && (\n              <div>\n                <ExchangeInfoRow label=\"Allowed Slippage\">\n                  <Tooltip\n                    handle={`${formatAmount(allowedSlippage, 2, 2)}%`}\n                    position=\"right-bottom\"\n                    renderContent={() => {\n                      return (\n                        <>\n                          You can change this in the settings menu on the top right of the page.\n                          <br />\n                          <br />\n                          Note that a low allowed slippage, e.g. less than 0.5%, may result in failed orders if prices\n                          are volatile.\n                        </>\n                      );\n                    }}\n                  />\n                </ExchangeInfoRow>\n              </div>\n            )}\n            {orderOption === STOP && (\n              <div className=\"Exchange-info-row\">\n                <div className=\"Exchange-info-label\">Trigger Price</div>\n                <div className=\"align-right\">\n                  {!triggerPriceUsd && \"-\"}\n                  {triggerPriceUsd && `${triggerPricePrefix} ${formatAmount(triggerPriceUsd, USD_DECIMALS, 2, true)}`}\n                </div>\n              </div>\n            )}\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">Entry Price</div>\n              <div className=\"align-right\">${formatAmount(position.averagePrice, USD_DECIMALS, 2, true)}</div>\n            </div>\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">Exit Price</div>\n              <div className=\"align-right\">${formatAmount(position.markPrice, USD_DECIMALS, 2, true)}</div>\n            </div>\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">Liq. Price</div>\n              <div className=\"align-right\">\n                {isClosing && orderOption !== STOP && \"-\"}\n                {(!isClosing || orderOption === STOP) && (\n                  <div>\n                    {(!nextLiquidationPrice || nextLiquidationPrice.eq(liquidationPrice)) && (\n                      <div>{`$${formatAmount(liquidationPrice, USD_DECIMALS, 2, true)}`}</div>\n                    )}\n                    {nextLiquidationPrice && !nextLiquidationPrice.eq(liquidationPrice) && (\n                      <div>\n                        <div className=\"inline-block muted\">\n                          ${formatAmount(liquidationPrice, USD_DECIMALS, 2, true)}\n                          <BsArrowRight className=\"transition-arrow\" />\n                        </div>\n                        ${formatAmount(nextLiquidationPrice, USD_DECIMALS, 2, true)}\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n            <div className=\"Exchange-info-row top-line\">\n              <div className=\"Exchange-info-label\">Size</div>\n              <div className=\"align-right\">\n                {position && position.size && fromAmount && (\n                  <div>\n                    <div className=\"inline-block muted\">\n                      ${formatAmount(position.size, USD_DECIMALS, 2, true)}\n                      <BsArrowRight className=\"transition-arrow\" />\n                    </div>\n                    ${formatAmount(position.size.sub(fromAmount), USD_DECIMALS, 2, true)}\n                  </div>\n                )}\n                {position && position.size && !fromAmount && (\n                  <div>${formatAmount(position.size, USD_DECIMALS, 2, true)}</div>\n                )}\n              </div>\n            </div>\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">Collateral</div>\n              <div className=\"align-right\">\n                {nextCollateral && !nextCollateral.eq(position.collateral) ? (\n                  <div>\n                    <div className=\"inline-block muted\">\n                      ${formatAmount(position.collateral, USD_DECIMALS, 2, true)}\n                      <BsArrowRight className=\"transition-arrow\" />\n                    </div>\n                    ${formatAmount(nextCollateral, USD_DECIMALS, 2, true)}\n                  </div>\n                ) : (\n                  `$${formatAmount(position.collateral, USD_DECIMALS, 4, true)}`\n                )}\n              </div>\n            </div>\n            {!keepLeverage && (\n              <div className=\"Exchange-info-row\">\n                <div className=\"Exchange-info-label\">Leverage</div>\n                <div className=\"align-right\">\n                  {isClosing && \"-\"}\n                  {!isClosing && (\n                    <div>\n                      {!nextLeverage && <div>{formatAmount(position.leverage, 4, 2)}x</div>}\n                      {nextLeverage && (\n                        <div>\n                          <div className=\"inline-block muted\">\n                            {formatAmount(position.leverage, 4, 2)}x\n                            <BsArrowRight className=\"transition-arrow\" />\n                          </div>\n                          {formatAmount(nextLeverage, 4, 2)}x\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">PnL</div>\n              <div className=\"align-right\">\n                {deltaStr} ({deltaPercentageStr})\n              </div>\n            </div>\n            <div className=\"Exchange-info-row top-line\">\n              <div className=\"Exchange-info-label\">Borrow Fee</div>\n              <div className=\"align-right\">${formatAmount(fundingFee, USD_DECIMALS, 2, true)}</div>\n            </div>\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">Closing Fee</div>\n              <div className=\"align-right\">\n                {positionFee && `$${formatAmount(positionFee, USD_DECIMALS, 2, true)}`}\n                {!positionFee && \"-\"}\n              </div>\n            </div>\n            <div className=\"Exchange-info-row\">\n              <div className=\"Exchange-info-label\">\n                Fees\n              </div>\n              <div className=\"align-right\">\n                <Tooltip\n                  position=\"right-top\"\n                  className=\"PositionSeller-fees-tooltip\"\n                  handle={\n                    <div>\n                      {totalFees ? `$${formatAmount(totalFees.add(executionFeeUsd), USD_DECIMALS, 2, true)}` : \"-\"}\n                    </div>\n                  }\n                  renderContent={() => (\n                    <div>\n                      {fundingFee && (\n                        <TooltipRow label=\"Borrow fee\" value={formatAmount(fundingFee, USD_DECIMALS, 2, true)} />\n                      )}\n\n                      {positionFee && (\n                        <TooltipRow label=\"Closing fee\" value={formatAmount(positionFee, USD_DECIMALS, 2, true)} />\n                      )}\n\n                      {swapFee && (\n                        <TooltipRow\n                          label=\"Swap fee\"\n                          showDollar={false}\n                          value={`${formatAmount(swapFeeToken, collateralToken.decimals, 5)} ${collateralToken.symbol}\n                           ($${formatAmount(swapFee, USD_DECIMALS, 2, true)})`}\n                        />\n                      )}\n\n                      <TooltipRow\n                        label=\"Execution fee\"\n                        showDollar={false}\n                        value={`${formatAmount(executionFee, 18, 5, true)} ${nativeTokenSymbol} ($${formatAmount(\n                          executionFeeUsd,\n                          USD_DECIMALS,\n                          2\n                        )})`}\n                      />\n\n                      <br />\n\n                      <div className=\"PositionSeller-fee-item\">\n                        <a href=\"https://swaps.docs.mycelium.xyz/protocol-design/trading/fees\" target=\"_blank\" rel=\"noopener noreferrer\">\n                          More Info\n                        </a>{\" \"}\n                        about fees.\n                      </div>\n                    </div>\n                  )}\n                />\n              </div>\n            </div>\n          </div>\n          <div className=\"Exchange-swap-button-container\">\n            <button\n              className=\"App-cta Exchange-swap-button\"\n              onClick={() => {\n                const stage = getPrimaryText() === \"Approve\" ? 1 : 2;\n                trackClosePosition(stage);\n                onClickPrimary();\n              }}\n              disabled={!isPrimaryEnabled()}\n            >\n              {getPrimaryText()}\n            </button>\n          </div>\n        </Modal>\n      )}\n    </div>\n  );\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}